<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>ess.ess API documentation</title>
            <link rel="icon" href="assets/ess_logo.svg"/>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../ess.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;ess</a>

            <img src="assets/ess_logo.svg" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#logger">logger</a>
            </li>
            <li>
                    <a class="variable" href="#KNN_SWITCH_THRESHOLD">KNN_SWITCH_THRESHOLD</a>
            </li>
            <li>
                    <a class="variable" href="#RADIUS_SWITCH_THRESHOLD">RADIUS_SWITCH_THRESHOLD</a>
            </li>
            <li>
                    <a class="function" href="#gaussian_force">gaussian_force</a>
            </li>
            <li>
                    <a class="function" href="#softened_inverse_force">softened_inverse_force</a>
            </li>
            <li>
                    <a class="function" href="#linear_force">linear_force</a>
            </li>
            <li>
                    <a class="function" href="#cauchy_force">cauchy_force</a>
            </li>
            <li>
                    <a class="variable" href="#METRIC_REGISTRY">METRIC_REGISTRY</a>
            </li>
            <li>
                    <a class="function" href="#esa">esa</a>
            </li>
            <li>
                    <a class="function" href="#ess">ess</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../ess.html">ess</a><wbr>.ess    </h1>

                
                        <input id="mod-ess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ess-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">collections.abc</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">ess.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">&quot;&quot;&quot;logging.Logger: Module-level logger for debugging ESA optimization steps.&quot;&quot;&quot;</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="c1"># --- Configuration Constants ---</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="n">KNN_SWITCH_THRESHOLD</span> <span class="o">=</span> <span class="mi">4096</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">&quot;&quot;&quot;int: The point count threshold for switching k-NN search engines.</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">If $N_{total} \\le$ this value, the algorithm uses a brute-force `NumpyNN` engine</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">(exact, faster for small N). Above this, it switches to `FaissHNSWFlatNN`</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">(approximate, faster for large N).</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="n">RADIUS_SWITCH_THRESHOLD</span> <span class="o">=</span> <span class="mi">50000</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">&quot;&quot;&quot;int: The point count threshold for switching Radius search engines.</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">For radius searches, dense matrix operations (`NumpyNN`) are often faster than</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">HNSW range search due to implementation overhead, up to a fairly large N.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">Above this value, the memory cost of the dense matrix becomes prohibitive.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="c1"># --- Force Functions ---</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="k">def</span><span class="w"> </span><span class="nf">gaussian_force</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="sd">    Computes a Gaussian repulsion force based on distance.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    This function models a short-range repulsive force that decays exponentially with distance,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    resembling a Gaussian distribution. It is useful for creating &quot;soft&quot; exclusion zones</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">    around particles. The force magnitude $F$ is calculated as:</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    $ F(d) = \\alpha \\cdot \\exp\\left(-\\frac{d^2}{2\\sigma^2}\\right) $</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    where $d$ is the distance, $\\sigma$ controls the width of the repulsion (standard deviation),</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    and $\\alpha$ is the peak magnitude at $d=0$.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    Args:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        d (np.ndarray): Array of pairwise distances between points.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        sigma (float): The spread parameter $\\sigma$. Larger values increase the range of influence.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">        alpha (float): The maximum force magnitude $\\alpha$ (at zero distance).</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    Returns:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        np.ndarray: An array of force magnitudes corresponding to the input distances.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>    <span class="n">s2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">s2</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="k">def</span><span class="w"> </span><span class="nf">softened_inverse_force</span><span class="p">(</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">    Computes a softened inverse-square repulsion force.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">    This function mimics electrostatic or gravitational repulsion but introduces a softening</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">    parameter $\\epsilon$ to prevent numerical singularities (division by zero) when particles</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    overlap ($d \\to 0$). The force decays algebraically rather than exponentially.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">    The magnitude is given by:</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">    $ F(d) = \\frac{\\alpha}{d^2 + \\epsilon^2} $</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">    This ensures that the maximum force is bounded at $\\alpha / \\epsilon^2$.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">    Args:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">        d (np.ndarray): Array of distances.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">        epsilon (float): Softening parameter $\\epsilon$. Prevents infinite forces at $d=0$.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        alpha (float): Magnitude scaling factor $\\alpha$.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">    Returns:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">        np.ndarray: An array of force magnitudes.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">)))</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="k">def</span><span class="w"> </span><span class="nf">linear_force</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">R</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">    Computes a linear repulsive force that falls to zero at a specific radius.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">    This force models a simple linear spring compression. It provides a constant stiffness</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="sd">    repulsion within a defined radius $R$ and is zero elsewhere. This creates a clear</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">    &quot;cutoff&quot; for interactions.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">    The formula is:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">    $ F(d) = \\max\\left(0, 1 - \\frac{d}{R}\\right) $</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">    Args:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        d (np.ndarray): Array of distances.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        R (float): The cutoff radius $R$. Forces are zero for $d \\ge R$.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">    Returns:</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        np.ndarray: An array of normalized force magnitudes in $[0, 1]$.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="n">R</span><span class="p">))</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="k">def</span><span class="w"> </span><span class="nf">cauchy_force</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">    Computes a long-tailed repulsion based on the Cauchy distribution.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    This function provides a heavy-tailed force distribution, which can be useful for</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">    maintaining global separation between points as the force does not decay as rapidly</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">    as a Gaussian.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">    The magnitude is defined as:</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">    $ F(d) = \\frac{1}{1 + d^2} $</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">    Args:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">        d (np.ndarray): Array of distances.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">    Returns:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        np.ndarray: An array of force magnitudes.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="n">METRIC_REGISTRY</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span> <span class="n">gaussian_force</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="s2">&quot;softened_inverse&quot;</span><span class="p">:</span> <span class="n">softened_inverse_force</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="n">linear_force</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="s2">&quot;cauchy&quot;</span><span class="p">:</span> <span class="n">cauchy_force</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="p">}</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="c1"># --- Helpers ---</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_scale</span><span class="p">(</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="n">min_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">max_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="p">]:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    Normalizes the input array to the unit hypercube $[0, 1]^D$.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">    Min-max scaling is performed column-wise (per dimension). If explicit bounds are not</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">    provided, they are inferred from the data. The transformation for a value $x$ is:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">    $ x&#39; = \\frac{x - x_{min}}{x_{max} - x_{min}} $</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">    This function handles constant dimensions (where $x_{max} = x_{min}$) by setting the</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">    denominator to 1.0 to avoid division by zero.</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">    Args:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        arr (np.ndarray): Input data array of shape $(N, D)$.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="sd">        min_val (np.ndarray | np.number | None): Optional pre-computed minimum values.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="sd">            If None, computed from `arr`.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">        max_val (np.ndarray | np.number | None): Optional pre-computed maximum values.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">            If None, computed from `arr`.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">    Returns:</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">            - **scaled_arr**: The normalized data in range $[0, 1]$.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">            - **min_val**: The minimum values used for scaling.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="sd">            - **max_val**: The maximum values used for scaling.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="n">used_min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">min_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">min_val</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="n">used_max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">max_val</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="n">denom</span> <span class="o">=</span> <span class="n">used_max_val</span> <span class="o">-</span> <span class="n">used_min_val</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="n">used_min_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="n">used_min_val</span><span class="p">,</span> <span class="n">used_max_val</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_inv_scale</span><span class="p">(</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>    <span class="n">scl_arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>    <span class="n">min_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>    <span class="n">max_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">    Restores scaled data from $[0, 1]^D$ back to its original domain.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">    This applies the inverse of the min-max normalization:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">    $ x = x&#39; \\cdot (x_{max} - x_{min}) + x_{min} $</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">    Args:</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        scl_arr (np.ndarray): Scaled input array in $[0, 1]$.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">        min_val (np.ndarray | np.number): The minimum values of the original domain.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">        max_val (np.ndarray | np.number): The maximum values of the original domain.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">    Returns:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        np.ndarray: The array projected back into the original bounds.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="k">return</span> <span class="n">scl_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_val</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_smart_init</span><span class="p">(</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="n">bounds_01</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>    <span class="n">n_new</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">    Initializes new points using a vectorized Best Candidate Sampling strategy.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">    Instead of placing points purely randomly, this method generates a pool of candidate</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">    positions for each required new point and selects the one that is furthest from</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">    the existing set of static points.</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">    **Algorithm:**</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">    1. For $N$ requested points, generate $N \\times k$ uniform candidates (where $k=15$).</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">    2. Compute the distance $d_i$ from every candidate to its nearest static neighbor.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">    3. For each of the $N$ slots, select the candidate $c^*$ such that:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">        $ c^* = \\arg\\max_{c \\in \\text{candidates}} (\\min_{p \\in \\text{static}} ||c - p||) $</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">    4. Apply a small jitter $\\xi \\sim U(-10^{-3}, 10^{-3})$ to avoid perfect overlaps.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">    Args:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        bounds_01 (np.ndarray): Normalized boundaries $[0, 1]$.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">        nn_instance (nn.NearestNeighbors): The index containing static points.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        n_new (int): Number of points to initialize.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        rng (np.random.Generator): Random number generator.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">    Returns:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        np.ndarray: Initial positions for the new points.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>    <span class="n">dim</span> <span class="o">=</span> <span class="n">bounds_01</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>    <span class="n">n_candidates</span> <span class="o">=</span> <span class="mi">15</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>    <span class="c1"># 1. Generate ALL candidates at once</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>    <span class="c1"># Shape: (n_new * n_candidates, D)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="n">total_candidates</span> <span class="o">=</span> <span class="n">n_new</span> <span class="o">*</span> <span class="n">n_candidates</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    <span class="n">candidates</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="n">bounds_01</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bounds_01</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">total_candidates</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>    <span class="c1"># 2. Query NN once for all candidates</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>    <span class="c1"># We only care about distance to the nearest STATIC point</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">nn_instance</span><span class="o">.</span><span class="n">query_static</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>    <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Shape (total_candidates,)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>    <span class="c1"># 3. Reshape to separate candidates per new point</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>    <span class="c1"># Shape: (n_new, n_candidates)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>    <span class="n">dists_reshaped</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">n_candidates</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>    <span class="c1"># Shape: (n_new, n_candidates, dim)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>    <span class="n">candidates_reshaped</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_new</span><span class="p">,</span> <span class="n">n_candidates</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>    <span class="c1"># 4. Find index of best candidate for each new point</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="n">best_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dists_reshaped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>    <span class="c1"># 5. Gather the best candidates</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>    <span class="c1"># Advanced indexing: pick the best candidate for each row</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>    <span class="n">row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_new</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="n">best_samples</span> <span class="o">=</span> <span class="n">candidates_reshaped</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">best_indices</span><span class="p">]</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>    <span class="n">jitter</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">best_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">best_samples</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_compute_radius_heuristic</span><span class="p">(</span><span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">    Derives an adaptive interaction radius based on domain volume and point density.</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">    In high-dimensional spaces, a fixed radius is often inappropriate. This heuristic</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">    estimates the &quot;Mean Inter-Particle Distance&quot; assuming an ideal packing and scales</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">    it to define a local neighborhood.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">    The estimated volume per point $V_p$ is:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">    $ V_p = \\frac{\\prod (side\\_lengths)}{N_{points}} $</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">    The average neighbor distance $R_{avg}$ is then approximated as:</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">    $ R_{avg} \\approx (V_p)^{1/D} $</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a><span class="sd">    The returned radius is $R = 1.25 \\times R_{avg}$, capped by the domain size.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a><span class="sd">    Args:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a><span class="sd">        bounds (np.ndarray): Domain boundaries of shape $(D, 2)$.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a><span class="sd">        n_points (int): Total number of points (static + active) in the system.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a><span class="sd">    Returns:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="sd">        float: A recommended radius for force interactions.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>    <span class="n">dim</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="n">sides</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="n">max_side</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dim </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2"> sides </span><span class="si">{</span><span class="n">sides</span><span class="si">}</span><span class="s2"> max side </span><span class="si">{</span><span class="n">max_side</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>    <span class="c1"># Estimate volume per point</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>    <span class="n">log_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sides</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">))</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>    <span class="n">log_vol_per_point</span> <span class="o">=</span> <span class="n">log_vol</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>    <span class="c1"># Mean distance to nearest neighbor in ideal packing</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="n">avg_neighbor_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_vol_per_point</span> <span class="o">/</span> <span class="n">dim</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    <span class="c1"># FIXED FACTOR: 2.5</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>    <span class="c1"># Previously, this scaled with sqrt(D), which exploded the radius in High-D.</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="c1"># 2.5 ensures we cover the immediate neighborhood without grabbing the entire world.</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>    <span class="n">radius</span> <span class="o">=</span> <span class="n">avg_neighbor_dist</span> <span class="o">*</span> <span class="mf">1.25</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>    <span class="n">domain_cap</span> <span class="o">=</span> <span class="n">max_side</span> <span class="o">*</span> <span class="mf">0.25</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    <span class="n">radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">domain_cap</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sides</span><span class="p">))</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_compute_wall_forces</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;repulsive&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">    Computes boundary containment forces using a soft linear spring model.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="sd">    If `strategy` is &#39;repulsive&#39;, this function applies a restorative force to points</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">    approaching the domain boundaries. The boundary acts as a Hookean spring with</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">    stiffness $k = 1/R$.</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">    For a point $x$ and boundary $B$, if the distance $d = |x - B| &lt; R$:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">    $ F_{wall} = k \\cdot (R - d) $ directed inward.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">    Args:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">        points (np.ndarray): Current point coordinates.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        bounds (np.ndarray): Domain boundaries.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">        strategy (str, optional): Strategy name. Returns zero forces if not &#39;repulsive&#39;.</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        radius (float, optional): The distance from the wall at which the force activates.</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a><span class="sd">    Returns:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="sd">        np.ndarray: Wall force vectors.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>    <span class="n">forces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="k">if</span> <span class="n">strategy</span> <span class="o">!=</span> <span class="s2">&quot;repulsive&quot;</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="k">return</span> <span class="n">forces</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>    <span class="n">bounds_min</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>    <span class="n">bounds_max</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>    <span class="n">dist_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">points</span> <span class="o">-</span> <span class="n">bounds_min</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>    <span class="n">dist_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">bounds_max</span> <span class="o">-</span> <span class="n">points</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>    <span class="n">mask_min</span> <span class="o">=</span> <span class="n">dist_min</span> <span class="o">&lt;</span> <span class="n">radius</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>    <span class="n">mask_max</span> <span class="o">=</span> <span class="n">dist_max</span> <span class="o">&lt;</span> <span class="n">radius</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="n">stiffness</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">radius</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_min</span><span class="p">):</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">forces</span><span class="p">[</span><span class="n">mask_min</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stiffness</span> <span class="o">*</span> <span class="p">(</span><span class="n">radius</span> <span class="o">-</span> <span class="n">dist_min</span><span class="p">[</span><span class="n">mask_min</span><span class="p">])</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_max</span><span class="p">):</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="n">forces</span><span class="p">[</span><span class="n">mask_max</span><span class="p">]</span> <span class="o">-=</span> <span class="n">stiffness</span> <span class="o">*</span> <span class="p">(</span><span class="n">radius</span> <span class="o">-</span> <span class="n">dist_max</span><span class="p">[</span><span class="n">mask_max</span><span class="p">])</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>    <span class="k">return</span> <span class="n">forces</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_compute_radius_forces</span><span class="p">(</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="n">active_view</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="n">all_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    <span class="n">metric_fn</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>    <span class="n">batch_start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">    Computes net repulsive forces using a Dense Matrix / Radius Search approach.</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">    This method calculates forces for a batch of active points against all neighbors</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">    within a given `radius`. It utilizes vector broadcasting to compute interactions</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">    efficiently and handles singularities.</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">    **Mathematical Operation:**</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">    Let $P_i$ be an active point and $P_j$ be a neighbor. The displacement is</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">    $\\vec{r}_{ij} = P_i - P_j$. The total force on $P_i$ is:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a><span class="sd">    $ \\vec{F}_i = \\sum_{j \\in N(i), j \\neq i} \\frac{\\vec{r}_{ij}}{||\\vec{r}_{ij}||} \\cdot f(||\\vec{r}_{ij}||) $</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">    **Key Steps:**</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="sd">    1. **Range Search:** Find all pairs $(i, j)$ where $||P_i - P_j|| &lt; R$.</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a><span class="sd">    2. **Self-Masking:** Explicitly zero out interactions where $i = j$.</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="sd">    3. **Collision Handling:** If $||\\vec{r}_{ij}|| \\approx 0$ (stacking), a random noise vector is injected to break symmetry.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="sd">    4. **Force Accumulation:** Forces are summed via matrix operations.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">    Args:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">        active_view (np.ndarray): The batch of points currently being optimized.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a><span class="sd">        all_data (np.ndarray): Reference to the complete dataset (static + active).</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="sd">        nn_instance (nn.NearestNeighbors): Helper for range queries.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        radius (float): Interaction cutoff radius.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a><span class="sd">        metric_fn (Callable): The scalar force magnitude function $f(d)$.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        batch_start_idx (int): Global index offset for the active batch.</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">        rng (np.random.Generator): Random generator for collision noise.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        **metric_kwargs: Arguments passed to `metric_fn`.</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">    Returns:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        np.ndarray: The net force vectors for the active batch.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="n">all_dists</span><span class="p">,</span> <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">nn_instance</span><span class="o">.</span><span class="n">range_search</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">active_view</span><span class="p">)</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>    <span class="c1"># --- 1. INDEX-BASED SELF MASKING ---</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>    <span class="c1"># The matrix columns [0..Total] map 1:1 to all_data indices.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>    <span class="c1"># The active batch starts at &#39;batch_start_idx&#39;.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>    <span class="n">n_active</span> <span class="o">=</span> <span class="n">active_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>    <span class="c1"># Create diagonal coordinates: (0, start), (1, start+1), ...</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_active</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>    <span class="n">cols</span> <span class="o">=</span> <span class="n">batch_start_idx</span> <span class="o">+</span> <span class="n">rows</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>    <span class="c1"># Ensure we don&#39;t go out of bounds (sanity check)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="n">valid_cols_mask</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="n">all_dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>    <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">valid_cols_mask</span><span class="p">]</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>    <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">valid_cols_mask</span><span class="p">]</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="c1"># Mask out Self</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>    <span class="n">valid_mask</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>    <span class="c1"># --- 2. COLLISION DETECTION ---</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="c1"># After masking self, any remaining d &lt; epsilon is a STACKED NEIGHBOR.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-9</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>    <span class="n">is_stacked_interaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_dists</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">valid_mask</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>    <span class="n">particles_stacking</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">is_stacked_interaction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>    <span class="c1"># --- 3. FORCE CALCULATION ---</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>    <span class="n">forces_mag</span> <span class="o">=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">all_dists</span><span class="p">,</span> <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">)</span> <span class="o">*</span> <span class="n">valid_mask</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="n">safe_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">all_dists</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">forces_mag</span> <span class="o">/</span> <span class="n">safe_dists</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>    <span class="n">n_valid</span> <span class="o">=</span> <span class="n">all_dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[:</span><span class="n">n_valid</span><span class="p">]</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="n">sum_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>    <span class="n">term1</span> <span class="o">=</span> <span class="n">active_view</span> <span class="o">*</span> <span class="n">sum_coeffs</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">valid_data</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>    <span class="n">forces</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">-</span> <span class="n">term2</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">particles_stacking</span><span class="p">):</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="c1"># Generate noise for the shape of forces</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>        <span class="n">noise</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">forces</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="c1"># MASK: Zero out noise for particles that are NOT stacking</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="c1"># Broadcasting: (Batch, Dim) * (Batch, 1)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>        <span class="n">noise</span> <span class="o">*=</span> <span class="n">particles_stacking</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="n">forces</span> <span class="o">+=</span> <span class="n">noise</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="k">return</span> <span class="n">forces</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_compute_knn_forces</span><span class="p">(</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="n">active_view</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>    <span class="n">all_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>    <span class="n">k_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>    <span class="n">metric_fn</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>    <span class="n">batch_start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>    <span class="n">batch_end_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a><span class="sd">    Computes net repulsive forces using a k-Nearest Neighbors (k-NN) approach.</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">    Unlike the radius approach, this method interacts with a fixed number ($k$) of</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">    nearest neighbors, regardless of distance. This adapts well to varying densities.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">    **Mathematical Operation:**</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a><span class="sd">    The summation logic mirrors `_compute_radius_forces`, but the neighborhood set</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a><span class="sd">    $N(i)$ is defined by rank order of distance rather than absolute distance threshold:</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a><span class="sd">    $ N(i) = \\{ j \\mid \\text{rank}(||P_i - P_j||) \\le k \\} $</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="sd">    It includes specific logic to handle cases where the returned neighbor indices</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a><span class="sd">    refer to the point itself (self-interaction) or overlap perfectly (stacking).</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">    Args:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        active_view (np.ndarray): The batch of active points.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">        all_data (np.ndarray): The full dataset.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        nn_instance (nn.NearestNeighbors): Helper for k-NN queries.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">        k_value (int): Number of neighbors to consider.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">        metric_fn (Callable): Force magnitude function.</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">        rng (np.random.Generator): Random generator.</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">        batch_start_idx (int): Global start index of the batch.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">        batch_end_idx (int): Global end index of the batch.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">        **metric_kwargs: Arguments passed to `metric_fn`.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a><span class="sd">    Returns:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">        np.ndarray: The net force vectors for the active batch.</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>    <span class="n">indices</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">nn_instance</span><span class="o">.</span><span class="n">query_nn</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k_value</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">batch_end_idx</span><span class="p">:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_end_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="c1"># --- 1. INDEX-BASED SELF MASKING ---</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>    <span class="c1"># We check: indices[i, j] == (batch_start_idx + i)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>    <span class="n">global_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">active_view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">batch_start_idx</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>    <span class="c1"># Broadcast comparison: (M, K) vs (M, 1)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>    <span class="n">is_self</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">==</span> <span class="n">global_idxs</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>    <span class="n">neighbor_coords</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>    <span class="n">disp_vecs</span> <span class="o">=</span> <span class="n">active_view</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">neighbor_coords</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>    <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">disp_vecs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>    <span class="c1"># --- 2. COLLISION DETECTION ---</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>    <span class="c1"># Any distance &lt; epsilon that is NOT self is a collision (stacking)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>    <span class="n">is_stacked</span> <span class="o">=</span> <span class="p">(</span><span class="n">norms</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">is_self</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>    <span class="c1"># Replace zero vectors with random unit vectors</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">is_stacked</span><span class="p">):</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="n">random_dirs</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">disp_vecs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="n">rnd_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">random_dirs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="n">random_dirs</span> <span class="o">/=</span> <span class="n">rnd_norms</span> <span class="o">+</span> <span class="mf">1e-9</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="c1"># Inject random direction where stacking occurred</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="n">disp_vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_stacked</span><span class="p">,</span> <span class="n">random_dirs</span><span class="p">,</span> <span class="n">disp_vecs</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="n">norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_stacked</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">norms</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="c1"># --- 3. FORCE CALCULATION ---</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>    <span class="n">forces_mag</span> <span class="o">=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>    <span class="c1"># Explicitly zero out self-force magnitude</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="n">forces_mag</span><span class="p">[</span><span class="n">is_self</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>    <span class="c1"># Safe Norm division</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="n">safe_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">norms</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>    <span class="n">force_vectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">disp_vecs</span> <span class="o">/</span> <span class="n">safe_norms</span><span class="p">)</span> <span class="o">*</span> <span class="n">forces_mag</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">force_vectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="c1"># --- Core Logic ---</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_esa</span><span class="p">(</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>    <span class="n">metric_fn</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="n">softened_inverse_force</span><span class="p">,</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a><span class="sd">    Executes the Empty Space Algorithm (ESA) optimization loop.</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a><span class="sd">    This function performs the core iterative position updates. It treats the problem</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a><span class="sd">    as a physics simulation where new points (charged particles) are introduced into</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">    a field of static points and repel each other to maximize spacing.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="sd">    **Process:**</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="sd">    1. **Scale:** Map input domain to unit hypercube $[0, 1]^D$.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a><span class="sd">    2. **Batching:** Process $N$ new points in mini-batches to manage complexity.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a><span class="sd">    3. **Optimization:** For each epoch $t$:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="sd">        - Calculate total force $\\vec{F}_{total} = \\vec{F}_{particle} + \\vec{F}_{wall}$.</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">        - Update positions: $\\mathbf{x}_{t+1} = \\mathbf{x}_t + \\eta_t \\cdot \\vec{F}_{total}$.</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">        - Decay learning rate: $\\eta_{t+1} = \\eta_t \\cdot \\gamma$.</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">        - Check convergence: Stop if $||\\mathbf{x}_{t+1} - \\mathbf{x}_t|| &lt; \\text{tol}$.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="sd">    4. **Consolidation:** Once a batch converges, it becomes &quot;static&quot; for subsequent batches.</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">    5. **Unscale:** Map results back to the original domain.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="sd">    Args:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a><span class="sd">        samples (np.ndarray): Existing static points.</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a><span class="sd">        bounds (np.ndarray): Domain boundaries.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a><span class="sd">        nn_instance (nn.NearestNeighbors): Index structure.</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a><span class="sd">        n (int): Number of points to generate.</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a><span class="sd">        epochs (int): Maximum update steps.</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a><span class="sd">        lr (float): Initial step size $\\eta_0$.</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a><span class="sd">        search_mode (str): &#39;k_nn&#39; or &#39;radius&#39;.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="sd">        decay (float): Learning rate decay factor $\\gamma$.</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a><span class="sd">        batch_size (int): Size of optimization groups.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">        k (int | None): Neighbors for k-NN mode.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        radius (float | None): Interaction radius.</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a><span class="sd">        tol (float): Convergence tolerance.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        metric_fn (Callable): Force function.</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">        border_strategy (str): &#39;clip&#39; or &#39;repulsive&#39;.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">        **metric_kwargs: Metric parameters.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">    Returns:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">        np.ndarray: The generated points in the original coordinate system.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>    <span class="c1"># 1. Scaling &amp; Pre-allocation</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="n">min_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>    <span class="n">max_val</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>    <span class="n">scaled_samples</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_scale</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>    <span class="n">scaled_samples</span> <span class="o">=</span> <span class="n">scaled_samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>    <span class="n">dim</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>    <span class="n">total_points</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>    <span class="n">all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">total_points</span><span class="p">,</span> <span class="n">dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>    <span class="n">all_data</span><span class="p">[:</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">scaled_samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>    <span class="c1"># 2. Setup NN</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>    <span class="n">nn_instance</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>    <span class="n">nn_instance</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="n">all_data</span><span class="p">[:</span><span class="n">cursor</span><span class="p">])</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>    <span class="c1"># 3. Parameter Defaults</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>    <span class="n">k_value</span> <span class="o">=</span> <span class="n">k</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>    <span class="c1"># Note: Radius heuristic logic moved to wrapper &#39;esa&#39;</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>    <span class="n">radius_value</span> <span class="o">=</span> <span class="n">radius</span> <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.1</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>    <span class="c1"># 4. Batch Processing</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>    <span class="n">num_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>    <span class="n">bounds_01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">dim</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="sa">f</span><span class="s2">&quot;Starting ESA: </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> points, </span><span class="si">{</span><span class="n">num_batches</span><span class="si">}</span><span class="s2"> batches. Mode=</span><span class="si">{</span><span class="n">search_mode</span><span class="si">}</span><span class="s2">. Border Strategy=</span><span class="si">{</span><span class="n">border_strategy</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>    <span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="c1"># Calculate batch size (handle last partial batch)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="n">remaining</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">cursor</span> <span class="o">-</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="n">current_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">remaining</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="k">if</span> <span class="n">current_n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="k">break</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="c1"># Define the memory slice for this batch in the Master Buffer</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="n">batch_start</span> <span class="o">=</span> <span class="n">cursor</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="n">batch_end</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">+</span> <span class="n">current_n</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        <span class="c1"># A. Smart Initialization</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>        <span class="n">active_batch_init</span> <span class="o">=</span> <span class="n">_smart_init</span><span class="p">(</span><span class="n">bounds_01</span><span class="p">,</span> <span class="n">nn_instance</span><span class="p">,</span> <span class="n">current_n</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>        <span class="n">all_data</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">active_batch_init</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="c1"># Create a VIEW of the master buffer for optimization</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="c1"># Modifying &#39;active_view&#39; modifies &#39;all_data&#39; in place.</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="n">active_view</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="n">nn_instance</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="n">active_view</span><span class="p">)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>        <span class="n">current_lr</span> <span class="o">=</span> <span class="n">lr</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        <span class="c1"># B. Optimization Loop</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>            <span class="c1"># Coordinate Retrieval:</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>            <span class="c1"># We need neighbors from the &quot;Valid&quot; part of the buffer.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>            <span class="c1"># When NN returns indices, they map directly to rows in &#39;all_data&#39;.</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>            <span class="c1"># --- Force Calculation ---</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>            <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>                <span class="n">particle_forces</span> <span class="o">=</span> <span class="n">_compute_radius_forces</span><span class="p">(</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>                    <span class="n">active_view</span><span class="p">,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>                    <span class="n">all_data</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                    <span class="n">nn_instance</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>                    <span class="n">radius_value</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>                    <span class="n">metric_fn</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>                    <span class="n">batch_start_idx</span><span class="o">=</span><span class="n">batch_start</span><span class="p">,</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>                    <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>                    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>                <span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>                <span class="n">particle_forces</span> <span class="o">=</span> <span class="n">_compute_knn_forces</span><span class="p">(</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>                    <span class="n">active_view</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>                    <span class="n">all_data</span><span class="p">,</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>                    <span class="n">nn_instance</span><span class="p">,</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>                    <span class="n">k_value</span><span class="p">,</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>                    <span class="n">metric_fn</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>                    <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>                    <span class="n">batch_start_idx</span><span class="o">=</span><span class="n">batch_start</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>                    <span class="n">batch_end_idx</span><span class="o">=</span><span class="n">batch_end</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>                    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>                <span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="c1"># --- Wall Forces (Elastic Borders) ---</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>            <span class="n">wall_forces</span> <span class="o">=</span> <span class="n">_compute_wall_forces</span><span class="p">(</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>                <span class="n">active_view</span><span class="p">,</span> <span class="n">bounds_01</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius_value</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>            <span class="c1"># --- Total Force &amp; Update ---</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>            <span class="n">total_force</span> <span class="o">=</span> <span class="n">particle_forces</span> <span class="o">+</span> <span class="n">wall_forces</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>            <span class="c1"># Save previous position for convergence check</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">active_view</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="c1"># Move (In-Place Update of Master Buffer via View)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>            <span class="n">active_view</span> <span class="o">+=</span> <span class="n">total_force</span> <span class="o">*</span> <span class="n">current_lr</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>            <span class="c1"># Apply Constraints (Clip)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>            <span class="c1"># We always clip to ensure validity, even with repulsive walls</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">active_view</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">active_view</span><span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>            <span class="n">nn_instance</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="n">active_view</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="c1"># --- Early Stopping ---</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>            <span class="n">move_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">active_view</span> <span class="o">-</span> <span class="n">prev_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">move_dist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                <span class="k">break</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>            <span class="n">current_lr</span> <span class="o">*=</span> <span class="n">decay</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>        <span class="c1"># C. Consolidate Batch</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="c1"># The batch is already in &#39;all_data&#39; at the correct position.</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>        <span class="c1"># Tell NN to treat these indices as Static now.</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="n">nn_instance</span><span class="o">.</span><span class="n">consolidate</span><span class="p">()</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="c1"># Advance cursor</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">batch_end</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>    <span class="c1"># 5. Inverse Scaling &amp; Return</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>    <span class="c1"># We only return the generated portion (from len(samples) onwards)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>    <span class="n">generated_slice</span> <span class="o">=</span> <span class="n">all_data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="p">:</span> <span class="n">cursor</span><span class="p">]</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>    <span class="k">return</span> <span class="n">_inv_scale</span><span class="p">(</span><span class="n">generated_slice</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a><span class="k">def</span><span class="w"> </span><span class="nf">esa</span><span class="p">(</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="s2">&quot;softened_inverse&quot;</span><span class="p">,</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a><span class="sd">    Wrapper for the Empty Space Algorithm (ESA) that returns only generated points.</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="sd">    This acts as the public API for the algorithm. It handles infrastructure setup</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a><span class="sd">    that the internal loop `_esa` requires, specifically:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a><span class="sd">    1. **Heuristic Calculation:** Auto-computes interaction radius if not provided.</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a><span class="sd">    2. **Metric Scaling:** Scales force parameters (like $\\sigma$) relative to the radius.</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a><span class="sd">    3. **Engine Selection:** Automatically chooses between a Dense Numpy engine (small $N$)</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a><span class="sd">        and an Approximate Nearest Neighbor (HNSW) engine (large $N$) for performance.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a><span class="sd">    Args:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a><span class="sd">        samples (np.ndarray): Existing points to avoid.</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a><span class="sd">        bounds (np.ndarray): Bounding box constraints.</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a><span class="sd">        n (int): Number of new points to create.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a><span class="sd">        nn_instance (nn.NearestNeighbors | None): Optional custom NN engine.</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a><span class="sd">        epochs (int): Max iterations.</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a><span class="sd">        lr (float): Initial learning rate.</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a><span class="sd">        search_mode (str): &#39;k_nn&#39; (adaptive) or &#39;radius&#39; (fixed range).</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a><span class="sd">        decay (float): LR decay per epoch.</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a><span class="sd">        batch_size (int): Optimization batch size.</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a><span class="sd">        k (int | None): Neighbors to use (if mode is &#39;k_nn&#39;).</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a><span class="sd">        radius (float | None): Force radius (if mode is &#39;radius&#39;).</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a><span class="sd">        tol (float): Early stopping tolerance.</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a><span class="sd">        metric (str | Callable): Name of force function or callable object.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a><span class="sd">        border_strategy (str): &#39;clip&#39; (hard stop) or &#39;repulsive&#39; (soft walls).</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a><span class="sd">        **metric_kwargs: Arguments for the metric function.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a><span class="sd">    Returns:</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a><span class="sd">        np.ndarray: An array of size $(n, D)$ containing only the newly generated points.</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>        <span class="n">metric_fn</span> <span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>        <span class="k">if</span> <span class="n">metric_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown metric &#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>        <span class="n">metric_fn</span> <span class="o">=</span> <span class="n">metric</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>    <span class="c1"># 1. AUTO-COMPUTE Radius (if needed)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>    <span class="c1"># We do this here so we can use it to auto-scale metric parameters.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>    <span class="n">final_radius</span> <span class="o">=</span> <span class="n">radius</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">and</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>        <span class="n">total_capacity</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>        <span class="c1"># Calculate heuristic in Unit Space</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>        <span class="c1"># Bounds are just needed for dimensionality and side ratios</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>        <span class="n">unit_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>        <span class="n">final_radius</span> <span class="o">=</span> <span class="n">_compute_radius_heuristic</span><span class="p">(</span><span class="n">unit_bounds</span><span class="p">,</span> <span class="n">total_capacity</span><span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computed Heuristic Radius: </span><span class="si">{</span><span class="n">final_radius</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>    <span class="c1"># 2. AUTO-SCALE Metric Parameters</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>    <span class="c1"># Ensure sigma/R matches the search radius for physical consistency</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">and</span> <span class="n">final_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>        <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span> <span class="ow">and</span> <span class="s2">&quot;sigma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_kwargs</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>            <span class="n">metric_kwargs</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_radius</span> <span class="o">/</span> <span class="mf">3.0</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span> <span class="ow">and</span> <span class="s2">&quot;R&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_kwargs</span><span class="p">:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>            <span class="n">metric_kwargs</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_radius</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>    <span class="c1"># 3. NN Factory with DUAL THRESHOLDS</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>    <span class="k">if</span> <span class="n">nn_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>        <span class="c1"># Select Threshold based on Search Mode</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">RADIUS_SWITCH_THRESHOLD</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">KNN_SWITCH_THRESHOLD</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using FAISS (HNSW) engine. (N=</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>            <span class="n">nn_instance</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">FaissHNSWFlatNN</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using NUMPY (Dense) engine. (N=</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>            <span class="n">nn_instance</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NumpyNN</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>    <span class="k">return</span> <span class="n">_esa</span><span class="p">(</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>        <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>        <span class="n">nn_instance</span><span class="o">=</span><span class="n">nn_instance</span><span class="p">,</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>        <span class="n">metric_fn</span><span class="o">=</span><span class="n">metric_fn</span><span class="p">,</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>        <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>        <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">,</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>        <span class="n">radius</span><span class="o">=</span><span class="n">final_radius</span><span class="p">,</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>        <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>        <span class="n">border_strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>        <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>    <span class="p">)</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a><span class="k">def</span><span class="w"> </span><span class="nf">ess</span><span class="p">(</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="s2">&quot;softened_inverse&quot;</span><span class="p">,</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a><span class="sd">    High-level Empty Space Strategy (ESS) wrapper returning the full dataset.</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a><span class="sd">    This convenience function runs the ESA algorithm and concatenates the results</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a><span class="sd">    with the original input samples. It is useful for iterative design of experiments</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a><span class="sd">    or sequential sampling workflows where the complete set of points is needed.</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a><span class="sd">    $$ \\text{Result} = \\text{samples} \\cup \\text{ESA}(\\text{samples}, \\dots) $$</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a><span class="sd">    Args:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a><span class="sd">        samples (np.ndarray | list): Existing points.</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a><span class="sd">        bounds (np.ndarray): Domain boundaries.</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a><span class="sd">        n (int): Number of new points to generate.</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a><span class="sd">        nn_instance (nn.NearestNeighbors | None): NN engine.</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a><span class="sd">        epochs (int): Optimization steps.</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a><span class="sd">        lr (float): Learning rate.</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a><span class="sd">        search_mode (str): Neighborhood search strategy.</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a><span class="sd">        decay (float): Decay rate.</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a><span class="sd">        batch_size (int): Batch size.</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a><span class="sd">        k (int | None): Neighbors count.</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a><span class="sd">        radius (float | None): Interaction radius.</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a><span class="sd">        tol (float): Convergence tolerance.</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a><span class="sd">        metric (str | Callable): Force metric.</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a><span class="sd">        border_strategy (str): Boundary handling.</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a><span class="sd">        **kwargs: Additional metric args.</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a><span class="sd">    Returns:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a><span class="sd">        np.ndarray: A combined array of shape $(N + n, D)$ containing original and new points.</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>    <span class="n">new_points</span> <span class="o">=</span> <span class="n">esa</span><span class="p">(</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>        <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a>        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>        <span class="n">nn_instance</span><span class="o">=</span><span class="n">nn_instance</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos">896</span></a>        <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos">897</span></a>        <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">,</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos">898</span></a>        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos">899</span></a>        <span class="n">border_strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos">900</span></a>        <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos">901</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos">902</span></a>        <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Let ESA determine K</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos">903</span></a>        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos">904</span></a>        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos">905</span></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos">906</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos">907</span></a>    <span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos">908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos">909</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">samples</span><span class="p">,</span> <span class="n">new_points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="logger">
                    <div class="attr variable">
            <span class="name">logger</span>        =
<span class="default_value">&lt;Logger <a href="">ess.ess</a> (INFO)&gt;</span>

        
    </div>
    <a class="headerlink" href="#logger"></a>
    
            <div class="docstring"><p>logging.Logger: Module-level logger for debugging ESA optimization steps.</p>
</div>


                </section>
                <section id="KNN_SWITCH_THRESHOLD">
                    <div class="attr variable">
            <span class="name">KNN_SWITCH_THRESHOLD</span>        =
<span class="default_value">4096</span>

        
    </div>
    <a class="headerlink" href="#KNN_SWITCH_THRESHOLD"></a>
    
            <div class="docstring"><p>int: The point count threshold for switching k-NN search engines.</p>

<p>If $N_{total} \le$ this value, the algorithm uses a brute-force <code>NumpyNN</code> engine
(exact, faster for small N). Above this, it switches to <code>FaissHNSWFlatNN</code>
(approximate, faster for large N).</p>
</div>


                </section>
                <section id="RADIUS_SWITCH_THRESHOLD">
                    <div class="attr variable">
            <span class="name">RADIUS_SWITCH_THRESHOLD</span>        =
<span class="default_value">50000</span>

        
    </div>
    <a class="headerlink" href="#RADIUS_SWITCH_THRESHOLD"></a>
    
            <div class="docstring"><p>int: The point count threshold for switching Radius search engines.</p>

<p>For radius searches, dense matrix operations (<code>NumpyNN</code>) are often faster than
HNSW range search due to implementation overhead, up to a fairly large N.
Above this value, the memory cost of the dense matrix becomes prohibitive.</p>
</div>


                </section>
                <section id="gaussian_force">
                            <input id="gaussian_force-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gaussian_force</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">d</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>,</span><span class="param">	<span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="gaussian_force-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#gaussian_force"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="gaussian_force-34"><a href="#gaussian_force-34"><span class="linenos">34</span></a><span class="k">def</span><span class="w"> </span><span class="nf">gaussian_force</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="gaussian_force-35"><a href="#gaussian_force-35"><span class="linenos">35</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="gaussian_force-36"><a href="#gaussian_force-36"><span class="linenos">36</span></a><span class="sd">    Computes a Gaussian repulsion force based on distance.</span>
</span><span id="gaussian_force-37"><a href="#gaussian_force-37"><span class="linenos">37</span></a>
</span><span id="gaussian_force-38"><a href="#gaussian_force-38"><span class="linenos">38</span></a><span class="sd">    This function models a short-range repulsive force that decays exponentially with distance,</span>
</span><span id="gaussian_force-39"><a href="#gaussian_force-39"><span class="linenos">39</span></a><span class="sd">    resembling a Gaussian distribution. It is useful for creating &quot;soft&quot; exclusion zones</span>
</span><span id="gaussian_force-40"><a href="#gaussian_force-40"><span class="linenos">40</span></a><span class="sd">    around particles. The force magnitude $F$ is calculated as:</span>
</span><span id="gaussian_force-41"><a href="#gaussian_force-41"><span class="linenos">41</span></a>
</span><span id="gaussian_force-42"><a href="#gaussian_force-42"><span class="linenos">42</span></a><span class="sd">    $ F(d) = \\alpha \\cdot \\exp\\left(-\\frac{d^2}{2\\sigma^2}\\right) $</span>
</span><span id="gaussian_force-43"><a href="#gaussian_force-43"><span class="linenos">43</span></a>
</span><span id="gaussian_force-44"><a href="#gaussian_force-44"><span class="linenos">44</span></a><span class="sd">    where $d$ is the distance, $\\sigma$ controls the width of the repulsion (standard deviation),</span>
</span><span id="gaussian_force-45"><a href="#gaussian_force-45"><span class="linenos">45</span></a><span class="sd">    and $\\alpha$ is the peak magnitude at $d=0$.</span>
</span><span id="gaussian_force-46"><a href="#gaussian_force-46"><span class="linenos">46</span></a>
</span><span id="gaussian_force-47"><a href="#gaussian_force-47"><span class="linenos">47</span></a><span class="sd">    Args:</span>
</span><span id="gaussian_force-48"><a href="#gaussian_force-48"><span class="linenos">48</span></a><span class="sd">        d (np.ndarray): Array of pairwise distances between points.</span>
</span><span id="gaussian_force-49"><a href="#gaussian_force-49"><span class="linenos">49</span></a><span class="sd">        sigma (float): The spread parameter $\\sigma$. Larger values increase the range of influence.</span>
</span><span id="gaussian_force-50"><a href="#gaussian_force-50"><span class="linenos">50</span></a><span class="sd">        alpha (float): The maximum force magnitude $\\alpha$ (at zero distance).</span>
</span><span id="gaussian_force-51"><a href="#gaussian_force-51"><span class="linenos">51</span></a>
</span><span id="gaussian_force-52"><a href="#gaussian_force-52"><span class="linenos">52</span></a><span class="sd">    Returns:</span>
</span><span id="gaussian_force-53"><a href="#gaussian_force-53"><span class="linenos">53</span></a><span class="sd">        np.ndarray: An array of force magnitudes corresponding to the input distances.</span>
</span><span id="gaussian_force-54"><a href="#gaussian_force-54"><span class="linenos">54</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="gaussian_force-55"><a href="#gaussian_force-55"><span class="linenos">55</span></a>    <span class="n">s2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
</span><span id="gaussian_force-56"><a href="#gaussian_force-56"><span class="linenos">56</span></a>    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">s2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Computes a Gaussian repulsion force based on distance.</p>

<p>This function models a short-range repulsive force that decays exponentially with distance,
resembling a Gaussian distribution. It is useful for creating "soft" exclusion zones
around particles. The force magnitude $F$ is calculated as:</p>

<p>$ F(d) = \alpha \cdot \exp\left(-\frac{d^2}{2\sigma^2}\right) $</p>

<p>where $d$ is the distance, $\sigma$ controls the width of the repulsion (standard deviation),
and $\alpha$ is the peak magnitude at $d=0$.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>d (np.ndarray):</strong>  Array of pairwise distances between points.</li>
<li><strong>sigma (float):</strong>  The spread parameter $\sigma$. Larger values increase the range of influence.</li>
<li><strong>alpha (float):</strong>  The maximum force magnitude $\alpha$ (at zero distance).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: An array of force magnitudes corresponding to the input distances.</p>
</blockquote>
</div>


                </section>
                <section id="softened_inverse_force">
                            <input id="softened_inverse_force-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">softened_inverse_force</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">d</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>,</span><span class="param">	<span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="softened_inverse_force-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#softened_inverse_force"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="softened_inverse_force-59"><a href="#softened_inverse_force-59"><span class="linenos">59</span></a><span class="k">def</span><span class="w"> </span><span class="nf">softened_inverse_force</span><span class="p">(</span>
</span><span id="softened_inverse_force-60"><a href="#softened_inverse_force-60"><span class="linenos">60</span></a>    <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="softened_inverse_force-61"><a href="#softened_inverse_force-61"><span class="linenos">61</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="softened_inverse_force-62"><a href="#softened_inverse_force-62"><span class="linenos">62</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="softened_inverse_force-63"><a href="#softened_inverse_force-63"><span class="linenos">63</span></a><span class="sd">    Computes a softened inverse-square repulsion force.</span>
</span><span id="softened_inverse_force-64"><a href="#softened_inverse_force-64"><span class="linenos">64</span></a>
</span><span id="softened_inverse_force-65"><a href="#softened_inverse_force-65"><span class="linenos">65</span></a><span class="sd">    This function mimics electrostatic or gravitational repulsion but introduces a softening</span>
</span><span id="softened_inverse_force-66"><a href="#softened_inverse_force-66"><span class="linenos">66</span></a><span class="sd">    parameter $\\epsilon$ to prevent numerical singularities (division by zero) when particles</span>
</span><span id="softened_inverse_force-67"><a href="#softened_inverse_force-67"><span class="linenos">67</span></a><span class="sd">    overlap ($d \\to 0$). The force decays algebraically rather than exponentially.</span>
</span><span id="softened_inverse_force-68"><a href="#softened_inverse_force-68"><span class="linenos">68</span></a>
</span><span id="softened_inverse_force-69"><a href="#softened_inverse_force-69"><span class="linenos">69</span></a><span class="sd">    The magnitude is given by:</span>
</span><span id="softened_inverse_force-70"><a href="#softened_inverse_force-70"><span class="linenos">70</span></a>
</span><span id="softened_inverse_force-71"><a href="#softened_inverse_force-71"><span class="linenos">71</span></a><span class="sd">    $ F(d) = \\frac{\\alpha}{d^2 + \\epsilon^2} $</span>
</span><span id="softened_inverse_force-72"><a href="#softened_inverse_force-72"><span class="linenos">72</span></a>
</span><span id="softened_inverse_force-73"><a href="#softened_inverse_force-73"><span class="linenos">73</span></a><span class="sd">    This ensures that the maximum force is bounded at $\\alpha / \\epsilon^2$.</span>
</span><span id="softened_inverse_force-74"><a href="#softened_inverse_force-74"><span class="linenos">74</span></a>
</span><span id="softened_inverse_force-75"><a href="#softened_inverse_force-75"><span class="linenos">75</span></a><span class="sd">    Args:</span>
</span><span id="softened_inverse_force-76"><a href="#softened_inverse_force-76"><span class="linenos">76</span></a><span class="sd">        d (np.ndarray): Array of distances.</span>
</span><span id="softened_inverse_force-77"><a href="#softened_inverse_force-77"><span class="linenos">77</span></a><span class="sd">        epsilon (float): Softening parameter $\\epsilon$. Prevents infinite forces at $d=0$.</span>
</span><span id="softened_inverse_force-78"><a href="#softened_inverse_force-78"><span class="linenos">78</span></a><span class="sd">        alpha (float): Magnitude scaling factor $\\alpha$.</span>
</span><span id="softened_inverse_force-79"><a href="#softened_inverse_force-79"><span class="linenos">79</span></a>
</span><span id="softened_inverse_force-80"><a href="#softened_inverse_force-80"><span class="linenos">80</span></a><span class="sd">    Returns:</span>
</span><span id="softened_inverse_force-81"><a href="#softened_inverse_force-81"><span class="linenos">81</span></a><span class="sd">        np.ndarray: An array of force magnitudes.</span>
</span><span id="softened_inverse_force-82"><a href="#softened_inverse_force-82"><span class="linenos">82</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="softened_inverse_force-83"><a href="#softened_inverse_force-83"><span class="linenos">83</span></a>    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">)))</span>
</span></pre></div>


            <div class="docstring"><p>Computes a softened inverse-square repulsion force.</p>

<p>This function mimics electrostatic or gravitational repulsion but introduces a softening
parameter $\epsilon$ to prevent numerical singularities (division by zero) when particles
overlap ($d \to 0$). The force decays algebraically rather than exponentially.</p>

<p>The magnitude is given by:</p>

<p>$ F(d) = \frac{\alpha}{d^2 + \epsilon^2} $</p>

<p>This ensures that the maximum force is bounded at $\alpha / \epsilon^2$.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>d (np.ndarray):</strong>  Array of distances.</li>
<li><strong>epsilon (float):</strong>  Softening parameter $\epsilon$. Prevents infinite forces at $d=0$.</li>
<li><strong>alpha (float):</strong>  Magnitude scaling factor $\alpha$.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: An array of force magnitudes.</p>
</blockquote>
</div>


                </section>
                <section id="linear_force">
                            <input id="linear_force-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">linear_force</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">d</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>, </span><span class="param"><span class="n">R</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="linear_force-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#linear_force"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="linear_force-86"><a href="#linear_force-86"><span class="linenos"> 86</span></a><span class="k">def</span><span class="w"> </span><span class="nf">linear_force</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">R</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="linear_force-87"><a href="#linear_force-87"><span class="linenos"> 87</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="linear_force-88"><a href="#linear_force-88"><span class="linenos"> 88</span></a><span class="sd">    Computes a linear repulsive force that falls to zero at a specific radius.</span>
</span><span id="linear_force-89"><a href="#linear_force-89"><span class="linenos"> 89</span></a>
</span><span id="linear_force-90"><a href="#linear_force-90"><span class="linenos"> 90</span></a><span class="sd">    This force models a simple linear spring compression. It provides a constant stiffness</span>
</span><span id="linear_force-91"><a href="#linear_force-91"><span class="linenos"> 91</span></a><span class="sd">    repulsion within a defined radius $R$ and is zero elsewhere. This creates a clear</span>
</span><span id="linear_force-92"><a href="#linear_force-92"><span class="linenos"> 92</span></a><span class="sd">    &quot;cutoff&quot; for interactions.</span>
</span><span id="linear_force-93"><a href="#linear_force-93"><span class="linenos"> 93</span></a>
</span><span id="linear_force-94"><a href="#linear_force-94"><span class="linenos"> 94</span></a><span class="sd">    The formula is:</span>
</span><span id="linear_force-95"><a href="#linear_force-95"><span class="linenos"> 95</span></a>
</span><span id="linear_force-96"><a href="#linear_force-96"><span class="linenos"> 96</span></a><span class="sd">    $ F(d) = \\max\\left(0, 1 - \\frac{d}{R}\\right) $</span>
</span><span id="linear_force-97"><a href="#linear_force-97"><span class="linenos"> 97</span></a>
</span><span id="linear_force-98"><a href="#linear_force-98"><span class="linenos"> 98</span></a><span class="sd">    Args:</span>
</span><span id="linear_force-99"><a href="#linear_force-99"><span class="linenos"> 99</span></a><span class="sd">        d (np.ndarray): Array of distances.</span>
</span><span id="linear_force-100"><a href="#linear_force-100"><span class="linenos">100</span></a><span class="sd">        R (float): The cutoff radius $R$. Forces are zero for $d \\ge R$.</span>
</span><span id="linear_force-101"><a href="#linear_force-101"><span class="linenos">101</span></a>
</span><span id="linear_force-102"><a href="#linear_force-102"><span class="linenos">102</span></a><span class="sd">    Returns:</span>
</span><span id="linear_force-103"><a href="#linear_force-103"><span class="linenos">103</span></a><span class="sd">        np.ndarray: An array of normalized force magnitudes in $[0, 1]$.</span>
</span><span id="linear_force-104"><a href="#linear_force-104"><span class="linenos">104</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="linear_force-105"><a href="#linear_force-105"><span class="linenos">105</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="n">R</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Computes a linear repulsive force that falls to zero at a specific radius.</p>

<p>This force models a simple linear spring compression. It provides a constant stiffness
repulsion within a defined radius $R$ and is zero elsewhere. This creates a clear
"cutoff" for interactions.</p>

<p>The formula is:</p>

<p>$ F(d) = \max\left(0, 1 - \frac{d}{R}\right) $</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>d (np.ndarray):</strong>  Array of distances.</li>
<li><strong>R (float):</strong>  The cutoff radius $R$. Forces are zero for $d \ge R$.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: An array of normalized force magnitudes in $[0, 1]$.</p>
</blockquote>
</div>


                </section>
                <section id="cauchy_force">
                            <input id="cauchy_force-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cauchy_force</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">d</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="cauchy_force-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#cauchy_force"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="cauchy_force-108"><a href="#cauchy_force-108"><span class="linenos">108</span></a><span class="k">def</span><span class="w"> </span><span class="nf">cauchy_force</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="cauchy_force-109"><a href="#cauchy_force-109"><span class="linenos">109</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="cauchy_force-110"><a href="#cauchy_force-110"><span class="linenos">110</span></a><span class="sd">    Computes a long-tailed repulsion based on the Cauchy distribution.</span>
</span><span id="cauchy_force-111"><a href="#cauchy_force-111"><span class="linenos">111</span></a>
</span><span id="cauchy_force-112"><a href="#cauchy_force-112"><span class="linenos">112</span></a><span class="sd">    This function provides a heavy-tailed force distribution, which can be useful for</span>
</span><span id="cauchy_force-113"><a href="#cauchy_force-113"><span class="linenos">113</span></a><span class="sd">    maintaining global separation between points as the force does not decay as rapidly</span>
</span><span id="cauchy_force-114"><a href="#cauchy_force-114"><span class="linenos">114</span></a><span class="sd">    as a Gaussian.</span>
</span><span id="cauchy_force-115"><a href="#cauchy_force-115"><span class="linenos">115</span></a>
</span><span id="cauchy_force-116"><a href="#cauchy_force-116"><span class="linenos">116</span></a><span class="sd">    The magnitude is defined as:</span>
</span><span id="cauchy_force-117"><a href="#cauchy_force-117"><span class="linenos">117</span></a>
</span><span id="cauchy_force-118"><a href="#cauchy_force-118"><span class="linenos">118</span></a><span class="sd">    $ F(d) = \\frac{1}{1 + d^2} $</span>
</span><span id="cauchy_force-119"><a href="#cauchy_force-119"><span class="linenos">119</span></a>
</span><span id="cauchy_force-120"><a href="#cauchy_force-120"><span class="linenos">120</span></a><span class="sd">    Args:</span>
</span><span id="cauchy_force-121"><a href="#cauchy_force-121"><span class="linenos">121</span></a><span class="sd">        d (np.ndarray): Array of distances.</span>
</span><span id="cauchy_force-122"><a href="#cauchy_force-122"><span class="linenos">122</span></a>
</span><span id="cauchy_force-123"><a href="#cauchy_force-123"><span class="linenos">123</span></a><span class="sd">    Returns:</span>
</span><span id="cauchy_force-124"><a href="#cauchy_force-124"><span class="linenos">124</span></a><span class="sd">        np.ndarray: An array of force magnitudes.</span>
</span><span id="cauchy_force-125"><a href="#cauchy_force-125"><span class="linenos">125</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="cauchy_force-126"><a href="#cauchy_force-126"><span class="linenos">126</span></a>    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Computes a long-tailed repulsion based on the Cauchy distribution.</p>

<p>This function provides a heavy-tailed force distribution, which can be useful for
maintaining global separation between points as the force does not decay as rapidly
as a Gaussian.</p>

<p>The magnitude is defined as:</p>

<p>$ F(d) = \frac{1}{1 + d^2} $</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>d (np.ndarray):</strong>  Array of distances.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: An array of force magnitudes.</p>
</blockquote>
</div>


                </section>
                <section id="METRIC_REGISTRY">
                    <div class="attr variable">
            <span class="name">METRIC_REGISTRY</span>        =
<input id="METRIC_REGISTRY-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="METRIC_REGISTRY-view-value"></label><span class="default_value">{&#39;gaussian&#39;: &lt;function gaussian_force&gt;, &#39;softened_inverse&#39;: &lt;function softened_inverse_force&gt;, &#39;linear&#39;: &lt;function linear_force&gt;, &#39;cauchy&#39;: &lt;function cauchy_force&gt;}</span>

        
    </div>
    <a class="headerlink" href="#METRIC_REGISTRY"></a>
    
    

                </section>
                <section id="esa">
                            <input id="esa-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">esa</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">samples</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">bounds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">n</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">nn_instance</span><span class="p">:</span> <span class="n"><a href="../ess.html#NearestNeighbors">ess.NearestNeighbors</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;k_nn&#39;</span>,</span><span class="param">	<span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span> <span class="o">=</span> <span class="s1">&#39;softened_inverse&#39;</span>,</span><span class="param">	<span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span>,</span><span class="param">	<span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>,</span><span class="param">	<span class="o">**</span><span class="n">metric_kwargs</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="esa-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#esa"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="esa-717"><a href="#esa-717"><span class="linenos">717</span></a><span class="k">def</span><span class="w"> </span><span class="nf">esa</span><span class="p">(</span>
</span><span id="esa-718"><a href="#esa-718"><span class="linenos">718</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="esa-719"><a href="#esa-719"><span class="linenos">719</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="esa-720"><a href="#esa-720"><span class="linenos">720</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="esa-721"><a href="#esa-721"><span class="linenos">721</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="esa-722"><a href="#esa-722"><span class="linenos">722</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="esa-723"><a href="#esa-723"><span class="linenos">723</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="esa-724"><a href="#esa-724"><span class="linenos">724</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="esa-725"><a href="#esa-725"><span class="linenos">725</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="esa-726"><a href="#esa-726"><span class="linenos">726</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="esa-727"><a href="#esa-727"><span class="linenos">727</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="esa-728"><a href="#esa-728"><span class="linenos">728</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="esa-729"><a href="#esa-729"><span class="linenos">729</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="esa-730"><a href="#esa-730"><span class="linenos">730</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="esa-731"><a href="#esa-731"><span class="linenos">731</span></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="s2">&quot;softened_inverse&quot;</span><span class="p">,</span>
</span><span id="esa-732"><a href="#esa-732"><span class="linenos">732</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="esa-733"><a href="#esa-733"><span class="linenos">733</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="esa-734"><a href="#esa-734"><span class="linenos">734</span></a>    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="esa-735"><a href="#esa-735"><span class="linenos">735</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="esa-736"><a href="#esa-736"><span class="linenos">736</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="esa-737"><a href="#esa-737"><span class="linenos">737</span></a><span class="sd">    Wrapper for the Empty Space Algorithm (ESA) that returns only generated points.</span>
</span><span id="esa-738"><a href="#esa-738"><span class="linenos">738</span></a>
</span><span id="esa-739"><a href="#esa-739"><span class="linenos">739</span></a><span class="sd">    This acts as the public API for the algorithm. It handles infrastructure setup</span>
</span><span id="esa-740"><a href="#esa-740"><span class="linenos">740</span></a><span class="sd">    that the internal loop `_esa` requires, specifically:</span>
</span><span id="esa-741"><a href="#esa-741"><span class="linenos">741</span></a><span class="sd">    1. **Heuristic Calculation:** Auto-computes interaction radius if not provided.</span>
</span><span id="esa-742"><a href="#esa-742"><span class="linenos">742</span></a><span class="sd">    2. **Metric Scaling:** Scales force parameters (like $\\sigma$) relative to the radius.</span>
</span><span id="esa-743"><a href="#esa-743"><span class="linenos">743</span></a><span class="sd">    3. **Engine Selection:** Automatically chooses between a Dense Numpy engine (small $N$)</span>
</span><span id="esa-744"><a href="#esa-744"><span class="linenos">744</span></a><span class="sd">        and an Approximate Nearest Neighbor (HNSW) engine (large $N$) for performance.</span>
</span><span id="esa-745"><a href="#esa-745"><span class="linenos">745</span></a>
</span><span id="esa-746"><a href="#esa-746"><span class="linenos">746</span></a><span class="sd">    Args:</span>
</span><span id="esa-747"><a href="#esa-747"><span class="linenos">747</span></a><span class="sd">        samples (np.ndarray): Existing points to avoid.</span>
</span><span id="esa-748"><a href="#esa-748"><span class="linenos">748</span></a><span class="sd">        bounds (np.ndarray): Bounding box constraints.</span>
</span><span id="esa-749"><a href="#esa-749"><span class="linenos">749</span></a><span class="sd">        n (int): Number of new points to create.</span>
</span><span id="esa-750"><a href="#esa-750"><span class="linenos">750</span></a><span class="sd">        nn_instance (nn.NearestNeighbors | None): Optional custom NN engine.</span>
</span><span id="esa-751"><a href="#esa-751"><span class="linenos">751</span></a><span class="sd">        epochs (int): Max iterations.</span>
</span><span id="esa-752"><a href="#esa-752"><span class="linenos">752</span></a><span class="sd">        lr (float): Initial learning rate.</span>
</span><span id="esa-753"><a href="#esa-753"><span class="linenos">753</span></a><span class="sd">        search_mode (str): &#39;k_nn&#39; (adaptive) or &#39;radius&#39; (fixed range).</span>
</span><span id="esa-754"><a href="#esa-754"><span class="linenos">754</span></a><span class="sd">        decay (float): LR decay per epoch.</span>
</span><span id="esa-755"><a href="#esa-755"><span class="linenos">755</span></a><span class="sd">        batch_size (int): Optimization batch size.</span>
</span><span id="esa-756"><a href="#esa-756"><span class="linenos">756</span></a><span class="sd">        k (int | None): Neighbors to use (if mode is &#39;k_nn&#39;).</span>
</span><span id="esa-757"><a href="#esa-757"><span class="linenos">757</span></a><span class="sd">        radius (float | None): Force radius (if mode is &#39;radius&#39;).</span>
</span><span id="esa-758"><a href="#esa-758"><span class="linenos">758</span></a><span class="sd">        tol (float): Early stopping tolerance.</span>
</span><span id="esa-759"><a href="#esa-759"><span class="linenos">759</span></a><span class="sd">        metric (str | Callable): Name of force function or callable object.</span>
</span><span id="esa-760"><a href="#esa-760"><span class="linenos">760</span></a><span class="sd">        border_strategy (str): &#39;clip&#39; (hard stop) or &#39;repulsive&#39; (soft walls).</span>
</span><span id="esa-761"><a href="#esa-761"><span class="linenos">761</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="esa-762"><a href="#esa-762"><span class="linenos">762</span></a><span class="sd">        **metric_kwargs: Arguments for the metric function.</span>
</span><span id="esa-763"><a href="#esa-763"><span class="linenos">763</span></a>
</span><span id="esa-764"><a href="#esa-764"><span class="linenos">764</span></a><span class="sd">    Returns:</span>
</span><span id="esa-765"><a href="#esa-765"><span class="linenos">765</span></a><span class="sd">        np.ndarray: An array of size $(n, D)$ containing only the newly generated points.</span>
</span><span id="esa-766"><a href="#esa-766"><span class="linenos">766</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="esa-767"><a href="#esa-767"><span class="linenos">767</span></a>
</span><span id="esa-768"><a href="#esa-768"><span class="linenos">768</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="esa-769"><a href="#esa-769"><span class="linenos">769</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="esa-770"><a href="#esa-770"><span class="linenos">770</span></a>
</span><span id="esa-771"><a href="#esa-771"><span class="linenos">771</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="esa-772"><a href="#esa-772"><span class="linenos">772</span></a>        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="esa-773"><a href="#esa-773"><span class="linenos">773</span></a>        <span class="n">metric_fn</span> <span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
</span><span id="esa-774"><a href="#esa-774"><span class="linenos">774</span></a>        <span class="k">if</span> <span class="n">metric_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-775"><a href="#esa-775"><span class="linenos">775</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown metric &#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="esa-776"><a href="#esa-776"><span class="linenos">776</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="esa-777"><a href="#esa-777"><span class="linenos">777</span></a>        <span class="n">metric_fn</span> <span class="o">=</span> <span class="n">metric</span>
</span><span id="esa-778"><a href="#esa-778"><span class="linenos">778</span></a>        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="esa-779"><a href="#esa-779"><span class="linenos">779</span></a>
</span><span id="esa-780"><a href="#esa-780"><span class="linenos">780</span></a>    <span class="c1"># 1. AUTO-COMPUTE Radius (if needed)</span>
</span><span id="esa-781"><a href="#esa-781"><span class="linenos">781</span></a>    <span class="c1"># We do this here so we can use it to auto-scale metric parameters.</span>
</span><span id="esa-782"><a href="#esa-782"><span class="linenos">782</span></a>    <span class="n">final_radius</span> <span class="o">=</span> <span class="n">radius</span>
</span><span id="esa-783"><a href="#esa-783"><span class="linenos">783</span></a>    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">and</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-784"><a href="#esa-784"><span class="linenos">784</span></a>        <span class="n">total_capacity</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="esa-785"><a href="#esa-785"><span class="linenos">785</span></a>
</span><span id="esa-786"><a href="#esa-786"><span class="linenos">786</span></a>        <span class="c1"># Calculate heuristic in Unit Space</span>
</span><span id="esa-787"><a href="#esa-787"><span class="linenos">787</span></a>        <span class="c1"># Bounds are just needed for dimensionality and side ratios</span>
</span><span id="esa-788"><a href="#esa-788"><span class="linenos">788</span></a>        <span class="n">unit_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="esa-789"><a href="#esa-789"><span class="linenos">789</span></a>        <span class="n">final_radius</span> <span class="o">=</span> <span class="n">_compute_radius_heuristic</span><span class="p">(</span><span class="n">unit_bounds</span><span class="p">,</span> <span class="n">total_capacity</span><span class="p">)</span>
</span><span id="esa-790"><a href="#esa-790"><span class="linenos">790</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computed Heuristic Radius: </span><span class="si">{</span><span class="n">final_radius</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="esa-791"><a href="#esa-791"><span class="linenos">791</span></a>
</span><span id="esa-792"><a href="#esa-792"><span class="linenos">792</span></a>    <span class="c1"># 2. AUTO-SCALE Metric Parameters</span>
</span><span id="esa-793"><a href="#esa-793"><span class="linenos">793</span></a>    <span class="c1"># Ensure sigma/R matches the search radius for physical consistency</span>
</span><span id="esa-794"><a href="#esa-794"><span class="linenos">794</span></a>    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">and</span> <span class="n">final_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-795"><a href="#esa-795"><span class="linenos">795</span></a>        <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span> <span class="ow">and</span> <span class="s2">&quot;sigma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_kwargs</span><span class="p">:</span>
</span><span id="esa-796"><a href="#esa-796"><span class="linenos">796</span></a>            <span class="n">metric_kwargs</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_radius</span> <span class="o">/</span> <span class="mf">3.0</span>
</span><span id="esa-797"><a href="#esa-797"><span class="linenos">797</span></a>        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span> <span class="ow">and</span> <span class="s2">&quot;R&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_kwargs</span><span class="p">:</span>
</span><span id="esa-798"><a href="#esa-798"><span class="linenos">798</span></a>            <span class="n">metric_kwargs</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_radius</span>
</span><span id="esa-799"><a href="#esa-799"><span class="linenos">799</span></a>
</span><span id="esa-800"><a href="#esa-800"><span class="linenos">800</span></a>    <span class="c1"># 3. NN Factory with DUAL THRESHOLDS</span>
</span><span id="esa-801"><a href="#esa-801"><span class="linenos">801</span></a>    <span class="k">if</span> <span class="n">nn_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-802"><a href="#esa-802"><span class="linenos">802</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="esa-803"><a href="#esa-803"><span class="linenos">803</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="esa-804"><a href="#esa-804"><span class="linenos">804</span></a>
</span><span id="esa-805"><a href="#esa-805"><span class="linenos">805</span></a>        <span class="c1"># Select Threshold based on Search Mode</span>
</span><span id="esa-806"><a href="#esa-806"><span class="linenos">806</span></a>        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span>
</span><span id="esa-807"><a href="#esa-807"><span class="linenos">807</span></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">RADIUS_SWITCH_THRESHOLD</span>
</span><span id="esa-808"><a href="#esa-808"><span class="linenos">808</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="esa-809"><a href="#esa-809"><span class="linenos">809</span></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">KNN_SWITCH_THRESHOLD</span>
</span><span id="esa-810"><a href="#esa-810"><span class="linenos">810</span></a>
</span><span id="esa-811"><a href="#esa-811"><span class="linenos">811</span></a>        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="esa-812"><a href="#esa-812"><span class="linenos">812</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using FAISS (HNSW) engine. (N=</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="esa-813"><a href="#esa-813"><span class="linenos">813</span></a>            <span class="n">nn_instance</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">FaissHNSWFlatNN</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</span><span id="esa-814"><a href="#esa-814"><span class="linenos">814</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="esa-815"><a href="#esa-815"><span class="linenos">815</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using NUMPY (Dense) engine. (N=</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="esa-816"><a href="#esa-816"><span class="linenos">816</span></a>            <span class="n">nn_instance</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NumpyNN</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</span><span id="esa-817"><a href="#esa-817"><span class="linenos">817</span></a>
</span><span id="esa-818"><a href="#esa-818"><span class="linenos">818</span></a>    <span class="k">return</span> <span class="n">_esa</span><span class="p">(</span>
</span><span id="esa-819"><a href="#esa-819"><span class="linenos">819</span></a>        <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span><span id="esa-820"><a href="#esa-820"><span class="linenos">820</span></a>        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="esa-821"><a href="#esa-821"><span class="linenos">821</span></a>        <span class="n">nn_instance</span><span class="o">=</span><span class="n">nn_instance</span><span class="p">,</span>
</span><span id="esa-822"><a href="#esa-822"><span class="linenos">822</span></a>        <span class="n">metric_fn</span><span class="o">=</span><span class="n">metric_fn</span><span class="p">,</span>
</span><span id="esa-823"><a href="#esa-823"><span class="linenos">823</span></a>        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
</span><span id="esa-824"><a href="#esa-824"><span class="linenos">824</span></a>        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="esa-825"><a href="#esa-825"><span class="linenos">825</span></a>        <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
</span><span id="esa-826"><a href="#esa-826"><span class="linenos">826</span></a>        <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">,</span>
</span><span id="esa-827"><a href="#esa-827"><span class="linenos">827</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="esa-828"><a href="#esa-828"><span class="linenos">828</span></a>        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span><span id="esa-829"><a href="#esa-829"><span class="linenos">829</span></a>        <span class="n">radius</span><span class="o">=</span><span class="n">final_radius</span><span class="p">,</span>
</span><span id="esa-830"><a href="#esa-830"><span class="linenos">830</span></a>        <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span>
</span><span id="esa-831"><a href="#esa-831"><span class="linenos">831</span></a>        <span class="n">border_strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span>
</span><span id="esa-832"><a href="#esa-832"><span class="linenos">832</span></a>        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="esa-833"><a href="#esa-833"><span class="linenos">833</span></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="esa-834"><a href="#esa-834"><span class="linenos">834</span></a>        <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="esa-835"><a href="#esa-835"><span class="linenos">835</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for the Empty Space Algorithm (ESA) that returns only generated points.</p>

<p>This acts as the public API for the algorithm. It handles infrastructure setup
that the internal loop <code>_esa</code> requires, specifically:</p>

<ol>
<li><strong>Heuristic Calculation:</strong> Auto-computes interaction radius if not provided.</li>
<li><strong>Metric Scaling:</strong> Scales force parameters (like $\sigma$) relative to the radius.</li>
<li><strong>Engine Selection:</strong> Automatically chooses between a Dense Numpy engine (small $N$)
and an Approximate Nearest Neighbor (HNSW) engine (large $N$) for performance.</li>
</ol>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>samples (np.ndarray):</strong>  Existing points to avoid.</li>
<li><strong>bounds (np.ndarray):</strong>  Bounding box constraints.</li>
<li><strong>n (int):</strong>  Number of new points to create.</li>
<li><strong>nn_instance (nn.NearestNeighbors | None):</strong>  Optional custom NN engine.</li>
<li><strong>epochs (int):</strong>  Max iterations.</li>
<li><strong>lr (float):</strong>  Initial learning rate.</li>
<li><strong>search_mode (str):</strong>  'k_nn' (adaptive) or 'radius' (fixed range).</li>
<li><strong>decay (float):</strong>  LR decay per epoch.</li>
<li><strong>batch_size (int):</strong>  Optimization batch size.</li>
<li><strong>k (int | None):</strong>  Neighbors to use (if mode is 'k_nn').</li>
<li><strong>radius (float | None):</strong>  Force radius (if mode is 'radius').</li>
<li><strong>tol (float):</strong>  Early stopping tolerance.</li>
<li><strong>metric (str | Callable):</strong>  Name of force function or callable object.</li>
<li><strong>border_strategy (str):</strong>  'clip' (hard stop) or 'repulsive' (soft walls).</li>
<li><strong>seed (int):</strong>  Random seed.</li>
<li><strong>**metric_kwargs:</strong>  Arguments for the metric function.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: An array of size $(n, D)$ containing only the newly generated points.</p>
</blockquote>
</div>


                </section>
                <section id="ess">
                            <input id="ess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ess</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">samples</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">bounds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">n</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">nn_instance</span><span class="p">:</span> <span class="n"><a href="../ess.html#NearestNeighbors">ess.NearestNeighbors</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;k_nn&#39;</span>,</span><span class="param">	<span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span> <span class="o">=</span> <span class="s1">&#39;softened_inverse&#39;</span>,</span><span class="param">	<span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span>,</span><span class="param">	<span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="ess-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ess"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ess-838"><a href="#ess-838"><span class="linenos">838</span></a><span class="k">def</span><span class="w"> </span><span class="nf">ess</span><span class="p">(</span>
</span><span id="ess-839"><a href="#ess-839"><span class="linenos">839</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="ess-840"><a href="#ess-840"><span class="linenos">840</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="ess-841"><a href="#ess-841"><span class="linenos">841</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="ess-842"><a href="#ess-842"><span class="linenos">842</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="ess-843"><a href="#ess-843"><span class="linenos">843</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ess-844"><a href="#ess-844"><span class="linenos">844</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="ess-845"><a href="#ess-845"><span class="linenos">845</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="ess-846"><a href="#ess-846"><span class="linenos">846</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="ess-847"><a href="#ess-847"><span class="linenos">847</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="ess-848"><a href="#ess-848"><span class="linenos">848</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="ess-849"><a href="#ess-849"><span class="linenos">849</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ess-850"><a href="#ess-850"><span class="linenos">850</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ess-851"><a href="#ess-851"><span class="linenos">851</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="ess-852"><a href="#ess-852"><span class="linenos">852</span></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="s2">&quot;softened_inverse&quot;</span><span class="p">,</span>
</span><span id="ess-853"><a href="#ess-853"><span class="linenos">853</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="ess-854"><a href="#ess-854"><span class="linenos">854</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="ess-855"><a href="#ess-855"><span class="linenos">855</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ess-856"><a href="#ess-856"><span class="linenos">856</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="ess-857"><a href="#ess-857"><span class="linenos">857</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ess-858"><a href="#ess-858"><span class="linenos">858</span></a><span class="sd">    High-level Empty Space Strategy (ESS) wrapper returning the full dataset.</span>
</span><span id="ess-859"><a href="#ess-859"><span class="linenos">859</span></a>
</span><span id="ess-860"><a href="#ess-860"><span class="linenos">860</span></a><span class="sd">    This convenience function runs the ESA algorithm and concatenates the results</span>
</span><span id="ess-861"><a href="#ess-861"><span class="linenos">861</span></a><span class="sd">    with the original input samples. It is useful for iterative design of experiments</span>
</span><span id="ess-862"><a href="#ess-862"><span class="linenos">862</span></a><span class="sd">    or sequential sampling workflows where the complete set of points is needed.</span>
</span><span id="ess-863"><a href="#ess-863"><span class="linenos">863</span></a>
</span><span id="ess-864"><a href="#ess-864"><span class="linenos">864</span></a><span class="sd">    $$ \\text{Result} = \\text{samples} \\cup \\text{ESA}(\\text{samples}, \\dots) $$</span>
</span><span id="ess-865"><a href="#ess-865"><span class="linenos">865</span></a>
</span><span id="ess-866"><a href="#ess-866"><span class="linenos">866</span></a><span class="sd">    Args:</span>
</span><span id="ess-867"><a href="#ess-867"><span class="linenos">867</span></a><span class="sd">        samples (np.ndarray | list): Existing points.</span>
</span><span id="ess-868"><a href="#ess-868"><span class="linenos">868</span></a><span class="sd">        bounds (np.ndarray): Domain boundaries.</span>
</span><span id="ess-869"><a href="#ess-869"><span class="linenos">869</span></a><span class="sd">        n (int): Number of new points to generate.</span>
</span><span id="ess-870"><a href="#ess-870"><span class="linenos">870</span></a><span class="sd">        nn_instance (nn.NearestNeighbors | None): NN engine.</span>
</span><span id="ess-871"><a href="#ess-871"><span class="linenos">871</span></a><span class="sd">        epochs (int): Optimization steps.</span>
</span><span id="ess-872"><a href="#ess-872"><span class="linenos">872</span></a><span class="sd">        lr (float): Learning rate.</span>
</span><span id="ess-873"><a href="#ess-873"><span class="linenos">873</span></a><span class="sd">        search_mode (str): Neighborhood search strategy.</span>
</span><span id="ess-874"><a href="#ess-874"><span class="linenos">874</span></a><span class="sd">        decay (float): Decay rate.</span>
</span><span id="ess-875"><a href="#ess-875"><span class="linenos">875</span></a><span class="sd">        batch_size (int): Batch size.</span>
</span><span id="ess-876"><a href="#ess-876"><span class="linenos">876</span></a><span class="sd">        k (int | None): Neighbors count.</span>
</span><span id="ess-877"><a href="#ess-877"><span class="linenos">877</span></a><span class="sd">        radius (float | None): Interaction radius.</span>
</span><span id="ess-878"><a href="#ess-878"><span class="linenos">878</span></a><span class="sd">        tol (float): Convergence tolerance.</span>
</span><span id="ess-879"><a href="#ess-879"><span class="linenos">879</span></a><span class="sd">        metric (str | Callable): Force metric.</span>
</span><span id="ess-880"><a href="#ess-880"><span class="linenos">880</span></a><span class="sd">        border_strategy (str): Boundary handling.</span>
</span><span id="ess-881"><a href="#ess-881"><span class="linenos">881</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="ess-882"><a href="#ess-882"><span class="linenos">882</span></a><span class="sd">        **kwargs: Additional metric args.</span>
</span><span id="ess-883"><a href="#ess-883"><span class="linenos">883</span></a>
</span><span id="ess-884"><a href="#ess-884"><span class="linenos">884</span></a><span class="sd">    Returns:</span>
</span><span id="ess-885"><a href="#ess-885"><span class="linenos">885</span></a><span class="sd">        np.ndarray: A combined array of shape $(N + n, D)$ containing original and new points.</span>
</span><span id="ess-886"><a href="#ess-886"><span class="linenos">886</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ess-887"><a href="#ess-887"><span class="linenos">887</span></a>
</span><span id="ess-888"><a href="#ess-888"><span class="linenos">888</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ess-889"><a href="#ess-889"><span class="linenos">889</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ess-890"><a href="#ess-890"><span class="linenos">890</span></a>
</span><span id="ess-891"><a href="#ess-891"><span class="linenos">891</span></a>    <span class="n">new_points</span> <span class="o">=</span> <span class="n">esa</span><span class="p">(</span>
</span><span id="ess-892"><a href="#ess-892"><span class="linenos">892</span></a>        <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span><span id="ess-893"><a href="#ess-893"><span class="linenos">893</span></a>        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="ess-894"><a href="#ess-894"><span class="linenos">894</span></a>        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
</span><span id="ess-895"><a href="#ess-895"><span class="linenos">895</span></a>        <span class="n">nn_instance</span><span class="o">=</span><span class="n">nn_instance</span><span class="p">,</span>
</span><span id="ess-896"><a href="#ess-896"><span class="linenos">896</span></a>        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="ess-897"><a href="#ess-897"><span class="linenos">897</span></a>        <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
</span><span id="ess-898"><a href="#ess-898"><span class="linenos">898</span></a>        <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">,</span>
</span><span id="ess-899"><a href="#ess-899"><span class="linenos">899</span></a>        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
</span><span id="ess-900"><a href="#ess-900"><span class="linenos">900</span></a>        <span class="n">border_strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span>
</span><span id="ess-901"><a href="#ess-901"><span class="linenos">901</span></a>        <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span>
</span><span id="ess-902"><a href="#ess-902"><span class="linenos">902</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="ess-903"><a href="#ess-903"><span class="linenos">903</span></a>        <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Let ESA determine K</span>
</span><span id="ess-904"><a href="#ess-904"><span class="linenos">904</span></a>        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="ess-905"><a href="#ess-905"><span class="linenos">905</span></a>        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
</span><span id="ess-906"><a href="#ess-906"><span class="linenos">906</span></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="ess-907"><a href="#ess-907"><span class="linenos">907</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ess-908"><a href="#ess-908"><span class="linenos">908</span></a>    <span class="p">)</span>
</span><span id="ess-909"><a href="#ess-909"><span class="linenos">909</span></a>
</span><span id="ess-910"><a href="#ess-910"><span class="linenos">910</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">samples</span><span class="p">,</span> <span class="n">new_points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>High-level Empty Space Strategy (ESS) wrapper returning the full dataset.</p>

<p>This convenience function runs the ESA algorithm and concatenates the results
with the original input samples. It is useful for iterative design of experiments
or sequential sampling workflows where the complete set of points is needed.</p>

<p>$$ \text{Result} = \text{samples} \cup \text{ESA}(\text{samples}, \dots) $$</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>samples (np.ndarray | list):</strong>  Existing points.</li>
<li><strong>bounds (np.ndarray):</strong>  Domain boundaries.</li>
<li><strong>n (int):</strong>  Number of new points to generate.</li>
<li><strong>nn_instance (nn.NearestNeighbors | None):</strong>  NN engine.</li>
<li><strong>epochs (int):</strong>  Optimization steps.</li>
<li><strong>lr (float):</strong>  Learning rate.</li>
<li><strong>search_mode (str):</strong>  Neighborhood search strategy.</li>
<li><strong>decay (float):</strong>  Decay rate.</li>
<li><strong>batch_size (int):</strong>  Batch size.</li>
<li><strong>k (int | None):</strong>  Neighbors count.</li>
<li><strong>radius (float | None):</strong>  Interaction radius.</li>
<li><strong>tol (float):</strong>  Convergence tolerance.</li>
<li><strong>metric (str | Callable):</strong>  Force metric.</li>
<li><strong>border_strategy (str):</strong>  Boundary handling.</li>
<li><strong>seed (int):</strong>  Random seed.</li>
<li><strong>**kwargs:</strong>  Additional metric args.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: A combined array of shape $(N + n, D)$ containing original and new points.</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>