<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>ess API documentation</title>
            <link rel="icon" href="assets/ess_logo.svg"/>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>
            <img src="assets/ess_logo.svg" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#ess-empty-space-strategy">ESS: Empty Space Strategy</a>
  <ul>
    <li><a href="#key-algorithms">Key Algorithms</a></li>
    <li><a href="#architecture">Architecture</a></li>
    <li><a href="#modules">Modules</a></li>
  </ul></li>
</ul>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="ess/ess.html">ess</a></li>
                    <li><a href="ess/nn.html">nn</a></li>
                    <li><a href="ess/utils.html">utils</a></li>
                    <li><a href="ess/legacy.html">legacy</a></li>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#esa">esa</a>
            </li>
            <li>
                    <a class="function" href="#ess">ess</a>
            </li>
            <li>
                    <a class="class" href="#NearestNeighbors">NearestNeighbors</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#NearestNeighbors.dimension">dimension</a>
                        </li>
                        <li>
                                <a class="variable" href="#NearestNeighbors.seed">seed</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.add_static">add_static</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.set_active">set_active</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.consolidate">consolidate</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.query_nn">query_nn</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.query_static">query_static</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.range_search">range_search</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestNeighbors.clear">clear</a>
                        </li>
                        <li>
                                <a class="variable" href="#NearestNeighbors.total_count">total_count</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#NumpyNN">NumpyNN</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NumpyNN.__init__">NumpyNN</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.add_static">add_static</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.set_active">set_active</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.consolidate">consolidate</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.clear">clear</a>
                        </li>
                        <li>
                                <a class="variable" href="#NumpyNN.total_count">total_count</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.query_nn">query_nn</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.query_static">query_static</a>
                        </li>
                        <li>
                                <a class="function" href="#NumpyNN.range_search">range_search</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FaissFlatL2NN">FaissFlatL2NN</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FaissFlatL2NN.__init__">FaissFlatL2NN</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FaissHNSWFlatNN">FaissHNSWFlatNN</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FaissHNSWFlatNN.__init__">FaissHNSWFlatNN</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
ess    </h1>

                        <div class="docstring"><h1 id="ess-empty-space-strategy">ESS: Empty Space Strategy</h1>

<p>A library for generating spatially diverse point distributions in high-dimensional
spaces using physics-based repulsion simulations.</p>

<p>The Empty Space Strategy (ESS) fills the "voids" in a design space by introducing
active particles that repel each other and existing static points. This is particularly
useful for:</p>

<ol>
<li><strong>Optimization Initialization</strong>: Finding diverse starting points for population-based algorithms.</li>
<li><strong>Design of Experiments (DoE)</strong>: Creating space-filling designs.</li>
<li><strong>Sampling</strong>: Generating high-entropy distributions in bounded domains.</li>
</ol>

<h2 id="key-algorithms">Key Algorithms</h2>

<p>The library provides two main entry points:</p>

<ul>
<li><code><a href="#esa">esa</a></code>: <strong>Empty Space Algorithm</strong> - Returns <em>only</em> the new generated points.</li>
<li><code><a href="#ess">ess</a></code>: <strong>Empty Space Strategy</strong> - Returns the combined set (Original + New).</li>
</ul>

<h2 id="architecture">Architecture</h2>

<p>The simulation is powered by swappable Nearest Neighbor (NN) engines to handle
forces efficiently across different scales:</p>

<ul>
<li><strong>Small N</strong>: Uses <code><a href="#NumpyNN">NumpyNN</a></code> for vectorized brute-force exact calculation.</li>
<li><strong>Large N</strong>: Uses <code><a href="#FaissHNSWFlatNN">FaissHNSWFlatNN</a></code> for approximate, graph-based queries.</li>
</ul>

<h2 id="modules">Modules</h2>

<ul>
<li><code><a href="#ess">ess</a></code>: Core generation logic and force field definitions.</li>
<li><code>nn</code>: Abstract and concrete NN implementations (Numpy, Faiss).</li>
<li><code>utils</code>: Metrics for spatial distribution (Coverage, Clark-Evans Index, Maximin).</li>
<li><code>legacy</code>: Reference implementations of earlier sequential strategies.</li>
</ul>
</div>

                        <input id="mod-ess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-ess-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a><span class="sd">ESS: Empty Space Strategy</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="sd">=========================</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a><span class="sd">A library for generating spatially diverse point distributions in high-dimensional</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a><span class="sd">spaces using physics-based repulsion simulations.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a><span class="sd">The Empty Space Strategy (ESS) fills the &quot;voids&quot; in a design space by introducing</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a><span class="sd">active particles that repel each other and existing static points. This is particularly</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="sd">useful for:</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a><span class="sd">1. **Optimization Initialization**: Finding diverse starting points for population-based algorithms.</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a><span class="sd">2. **Design of Experiments (DoE)**: Creating space-filling designs.</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a><span class="sd">3. **Sampling**: Generating high-entropy distributions in bounded domains.</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a><span class="sd">Key Algorithms</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a><span class="sd">--------------</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a><span class="sd">The library provides two main entry points:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a><span class="sd">* `esa`: **Empty Space Algorithm** - Returns *only* the new generated points.</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a><span class="sd">* `ess`: **Empty Space Strategy** - Returns the combined set (Original + New).</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a><span class="sd">Architecture</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a><span class="sd">------------</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">23</span></a><span class="sd">The simulation is powered by swappable Nearest Neighbor (NN) engines to handle</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">24</span></a><span class="sd">forces efficiently across different scales:</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">25</span></a><span class="sd">* **Small N**: Uses `NumpyNN` for vectorized brute-force exact calculation.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">26</span></a><span class="sd">* **Large N**: Uses `FaissHNSWFlatNN` for approximate, graph-based queries.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">28</span></a><span class="sd">Modules</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">29</span></a><span class="sd">-------</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">30</span></a><span class="sd">* `ess`: Core generation logic and force field definitions.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">31</span></a><span class="sd">* `nn`: Abstract and concrete NN implementations (Numpy, Faiss).</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">32</span></a><span class="sd">* `utils`: Metrics for spatial distribution (Coverage, Clark-Evans Index, Maximin).</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">33</span></a><span class="sd">* `legacy`: Reference implementations of earlier sequential strategies.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">34</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos">36</span></a><span class="c1"># 1. Internal Module Imports</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">37</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">legacy</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">utils</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">39</span></a><span class="c1"># 2. Main API Exports</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">40</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.ess</span><span class="w"> </span><span class="kn">import</span> <span class="n">esa</span><span class="p">,</span> <span class="n">ess</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">42</span></a><span class="c1"># 3. NN Engine Exports</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">43</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">FaissFlatL2NN</span><span class="p">,</span> <span class="n">FaissHNSWFlatNN</span><span class="p">,</span> <span class="n">NearestNeighbors</span><span class="p">,</span> <span class="n">NumpyNN</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">45</span></a><span class="c1"># Define __all__ to control what &#39;from ess import *&#39; exports</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">46</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">47</span></a>    <span class="s2">&quot;esa&quot;</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">48</span></a>    <span class="s2">&quot;ess&quot;</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">49</span></a>    <span class="s2">&quot;NearestNeighbors&quot;</span><span class="p">,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">50</span></a>    <span class="s2">&quot;NumpyNN&quot;</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">51</span></a>    <span class="s2">&quot;FaissFlatL2NN&quot;</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">52</span></a>    <span class="s2">&quot;FaissHNSWFlatNN&quot;</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">53</span></a>    <span class="s2">&quot;nn&quot;</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">54</span></a>    <span class="s2">&quot;utils&quot;</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">55</span></a>    <span class="s2">&quot;legacy&quot;</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">56</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="esa">
                            <input id="esa-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">esa</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">samples</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">bounds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">n</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">nn_instance</span><span class="p">:</span> <span class="n"><a href="#NearestNeighbors">NearestNeighbors</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;k_nn&#39;</span>,</span><span class="param">	<span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span> <span class="o">=</span> <span class="s1">&#39;softened_inverse&#39;</span>,</span><span class="param">	<span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span>,</span><span class="param">	<span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>,</span><span class="param">	<span class="o">**</span><span class="n">metric_kwargs</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="esa-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#esa"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="esa-717"><a href="#esa-717"><span class="linenos">717</span></a><span class="k">def</span><span class="w"> </span><span class="nf">esa</span><span class="p">(</span>
</span><span id="esa-718"><a href="#esa-718"><span class="linenos">718</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="esa-719"><a href="#esa-719"><span class="linenos">719</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="esa-720"><a href="#esa-720"><span class="linenos">720</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="esa-721"><a href="#esa-721"><span class="linenos">721</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="esa-722"><a href="#esa-722"><span class="linenos">722</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="esa-723"><a href="#esa-723"><span class="linenos">723</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="esa-724"><a href="#esa-724"><span class="linenos">724</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="esa-725"><a href="#esa-725"><span class="linenos">725</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="esa-726"><a href="#esa-726"><span class="linenos">726</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="esa-727"><a href="#esa-727"><span class="linenos">727</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="esa-728"><a href="#esa-728"><span class="linenos">728</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="esa-729"><a href="#esa-729"><span class="linenos">729</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="esa-730"><a href="#esa-730"><span class="linenos">730</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="esa-731"><a href="#esa-731"><span class="linenos">731</span></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="s2">&quot;softened_inverse&quot;</span><span class="p">,</span>
</span><span id="esa-732"><a href="#esa-732"><span class="linenos">732</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="esa-733"><a href="#esa-733"><span class="linenos">733</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="esa-734"><a href="#esa-734"><span class="linenos">734</span></a>    <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="esa-735"><a href="#esa-735"><span class="linenos">735</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="esa-736"><a href="#esa-736"><span class="linenos">736</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="esa-737"><a href="#esa-737"><span class="linenos">737</span></a><span class="sd">    Wrapper for the Empty Space Algorithm (ESA) that returns only generated points.</span>
</span><span id="esa-738"><a href="#esa-738"><span class="linenos">738</span></a>
</span><span id="esa-739"><a href="#esa-739"><span class="linenos">739</span></a><span class="sd">    This acts as the public API for the algorithm. It handles infrastructure setup</span>
</span><span id="esa-740"><a href="#esa-740"><span class="linenos">740</span></a><span class="sd">    that the internal loop `_esa` requires, specifically:</span>
</span><span id="esa-741"><a href="#esa-741"><span class="linenos">741</span></a><span class="sd">    1. **Heuristic Calculation:** Auto-computes interaction radius if not provided.</span>
</span><span id="esa-742"><a href="#esa-742"><span class="linenos">742</span></a><span class="sd">    2. **Metric Scaling:** Scales force parameters (like $\\sigma$) relative to the radius.</span>
</span><span id="esa-743"><a href="#esa-743"><span class="linenos">743</span></a><span class="sd">    3. **Engine Selection:** Automatically chooses between a Dense Numpy engine (small $N$)</span>
</span><span id="esa-744"><a href="#esa-744"><span class="linenos">744</span></a><span class="sd">        and an Approximate Nearest Neighbor (HNSW) engine (large $N$) for performance.</span>
</span><span id="esa-745"><a href="#esa-745"><span class="linenos">745</span></a>
</span><span id="esa-746"><a href="#esa-746"><span class="linenos">746</span></a><span class="sd">    Args:</span>
</span><span id="esa-747"><a href="#esa-747"><span class="linenos">747</span></a><span class="sd">        samples (np.ndarray): Existing points to avoid.</span>
</span><span id="esa-748"><a href="#esa-748"><span class="linenos">748</span></a><span class="sd">        bounds (np.ndarray): Bounding box constraints.</span>
</span><span id="esa-749"><a href="#esa-749"><span class="linenos">749</span></a><span class="sd">        n (int): Number of new points to create.</span>
</span><span id="esa-750"><a href="#esa-750"><span class="linenos">750</span></a><span class="sd">        nn_instance (nn.NearestNeighbors | None): Optional custom NN engine.</span>
</span><span id="esa-751"><a href="#esa-751"><span class="linenos">751</span></a><span class="sd">        epochs (int): Max iterations.</span>
</span><span id="esa-752"><a href="#esa-752"><span class="linenos">752</span></a><span class="sd">        lr (float): Initial learning rate.</span>
</span><span id="esa-753"><a href="#esa-753"><span class="linenos">753</span></a><span class="sd">        search_mode (str): &#39;k_nn&#39; (adaptive) or &#39;radius&#39; (fixed range).</span>
</span><span id="esa-754"><a href="#esa-754"><span class="linenos">754</span></a><span class="sd">        decay (float): LR decay per epoch.</span>
</span><span id="esa-755"><a href="#esa-755"><span class="linenos">755</span></a><span class="sd">        batch_size (int): Optimization batch size.</span>
</span><span id="esa-756"><a href="#esa-756"><span class="linenos">756</span></a><span class="sd">        k (int | None): Neighbors to use (if mode is &#39;k_nn&#39;).</span>
</span><span id="esa-757"><a href="#esa-757"><span class="linenos">757</span></a><span class="sd">        radius (float | None): Force radius (if mode is &#39;radius&#39;).</span>
</span><span id="esa-758"><a href="#esa-758"><span class="linenos">758</span></a><span class="sd">        tol (float): Early stopping tolerance.</span>
</span><span id="esa-759"><a href="#esa-759"><span class="linenos">759</span></a><span class="sd">        metric (str | Callable): Name of force function or callable object.</span>
</span><span id="esa-760"><a href="#esa-760"><span class="linenos">760</span></a><span class="sd">        border_strategy (str): &#39;clip&#39; (hard stop) or &#39;repulsive&#39; (soft walls).</span>
</span><span id="esa-761"><a href="#esa-761"><span class="linenos">761</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="esa-762"><a href="#esa-762"><span class="linenos">762</span></a><span class="sd">        **metric_kwargs: Arguments for the metric function.</span>
</span><span id="esa-763"><a href="#esa-763"><span class="linenos">763</span></a>
</span><span id="esa-764"><a href="#esa-764"><span class="linenos">764</span></a><span class="sd">    Returns:</span>
</span><span id="esa-765"><a href="#esa-765"><span class="linenos">765</span></a><span class="sd">        np.ndarray: An array of size $(n, D)$ containing only the newly generated points.</span>
</span><span id="esa-766"><a href="#esa-766"><span class="linenos">766</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="esa-767"><a href="#esa-767"><span class="linenos">767</span></a>
</span><span id="esa-768"><a href="#esa-768"><span class="linenos">768</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="esa-769"><a href="#esa-769"><span class="linenos">769</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="esa-770"><a href="#esa-770"><span class="linenos">770</span></a>
</span><span id="esa-771"><a href="#esa-771"><span class="linenos">771</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="esa-772"><a href="#esa-772"><span class="linenos">772</span></a>        <span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="esa-773"><a href="#esa-773"><span class="linenos">773</span></a>        <span class="n">metric_fn</span> <span class="o">=</span> <span class="n">METRIC_REGISTRY</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
</span><span id="esa-774"><a href="#esa-774"><span class="linenos">774</span></a>        <span class="k">if</span> <span class="n">metric_fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-775"><a href="#esa-775"><span class="linenos">775</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown metric &#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="esa-776"><a href="#esa-776"><span class="linenos">776</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="esa-777"><a href="#esa-777"><span class="linenos">777</span></a>        <span class="n">metric_fn</span> <span class="o">=</span> <span class="n">metric</span>
</span><span id="esa-778"><a href="#esa-778"><span class="linenos">778</span></a>        <span class="n">metric_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="esa-779"><a href="#esa-779"><span class="linenos">779</span></a>
</span><span id="esa-780"><a href="#esa-780"><span class="linenos">780</span></a>    <span class="c1"># 1. AUTO-COMPUTE Radius (if needed)</span>
</span><span id="esa-781"><a href="#esa-781"><span class="linenos">781</span></a>    <span class="c1"># We do this here so we can use it to auto-scale metric parameters.</span>
</span><span id="esa-782"><a href="#esa-782"><span class="linenos">782</span></a>    <span class="n">final_radius</span> <span class="o">=</span> <span class="n">radius</span>
</span><span id="esa-783"><a href="#esa-783"><span class="linenos">783</span></a>    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">and</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-784"><a href="#esa-784"><span class="linenos">784</span></a>        <span class="n">total_capacity</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="esa-785"><a href="#esa-785"><span class="linenos">785</span></a>
</span><span id="esa-786"><a href="#esa-786"><span class="linenos">786</span></a>        <span class="c1"># Calculate heuristic in Unit Space</span>
</span><span id="esa-787"><a href="#esa-787"><span class="linenos">787</span></a>        <span class="c1"># Bounds are just needed for dimensionality and side ratios</span>
</span><span id="esa-788"><a href="#esa-788"><span class="linenos">788</span></a>        <span class="n">unit_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="esa-789"><a href="#esa-789"><span class="linenos">789</span></a>        <span class="n">final_radius</span> <span class="o">=</span> <span class="n">_compute_radius_heuristic</span><span class="p">(</span><span class="n">unit_bounds</span><span class="p">,</span> <span class="n">total_capacity</span><span class="p">)</span>
</span><span id="esa-790"><a href="#esa-790"><span class="linenos">790</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computed Heuristic Radius: </span><span class="si">{</span><span class="n">final_radius</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="esa-791"><a href="#esa-791"><span class="linenos">791</span></a>
</span><span id="esa-792"><a href="#esa-792"><span class="linenos">792</span></a>    <span class="c1"># 2. AUTO-SCALE Metric Parameters</span>
</span><span id="esa-793"><a href="#esa-793"><span class="linenos">793</span></a>    <span class="c1"># Ensure sigma/R matches the search radius for physical consistency</span>
</span><span id="esa-794"><a href="#esa-794"><span class="linenos">794</span></a>    <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span> <span class="ow">and</span> <span class="n">final_radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-795"><a href="#esa-795"><span class="linenos">795</span></a>        <span class="k">if</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span> <span class="ow">and</span> <span class="s2">&quot;sigma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_kwargs</span><span class="p">:</span>
</span><span id="esa-796"><a href="#esa-796"><span class="linenos">796</span></a>            <span class="n">metric_kwargs</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_radius</span> <span class="o">/</span> <span class="mf">3.0</span>
</span><span id="esa-797"><a href="#esa-797"><span class="linenos">797</span></a>        <span class="k">elif</span> <span class="n">metric_name</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span> <span class="ow">and</span> <span class="s2">&quot;R&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_kwargs</span><span class="p">:</span>
</span><span id="esa-798"><a href="#esa-798"><span class="linenos">798</span></a>            <span class="n">metric_kwargs</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_radius</span>
</span><span id="esa-799"><a href="#esa-799"><span class="linenos">799</span></a>
</span><span id="esa-800"><a href="#esa-800"><span class="linenos">800</span></a>    <span class="c1"># 3. NN Factory with DUAL THRESHOLDS</span>
</span><span id="esa-801"><a href="#esa-801"><span class="linenos">801</span></a>    <span class="k">if</span> <span class="n">nn_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="esa-802"><a href="#esa-802"><span class="linenos">802</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="esa-803"><a href="#esa-803"><span class="linenos">803</span></a>        <span class="n">total</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">n</span>
</span><span id="esa-804"><a href="#esa-804"><span class="linenos">804</span></a>
</span><span id="esa-805"><a href="#esa-805"><span class="linenos">805</span></a>        <span class="c1"># Select Threshold based on Search Mode</span>
</span><span id="esa-806"><a href="#esa-806"><span class="linenos">806</span></a>        <span class="k">if</span> <span class="n">search_mode</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span>
</span><span id="esa-807"><a href="#esa-807"><span class="linenos">807</span></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">RADIUS_SWITCH_THRESHOLD</span>
</span><span id="esa-808"><a href="#esa-808"><span class="linenos">808</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="esa-809"><a href="#esa-809"><span class="linenos">809</span></a>            <span class="n">threshold</span> <span class="o">=</span> <span class="n">KNN_SWITCH_THRESHOLD</span>
</span><span id="esa-810"><a href="#esa-810"><span class="linenos">810</span></a>
</span><span id="esa-811"><a href="#esa-811"><span class="linenos">811</span></a>        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="esa-812"><a href="#esa-812"><span class="linenos">812</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using FAISS (HNSW) engine. (N=</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="esa-813"><a href="#esa-813"><span class="linenos">813</span></a>            <span class="n">nn_instance</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">FaissHNSWFlatNN</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</span><span id="esa-814"><a href="#esa-814"><span class="linenos">814</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="esa-815"><a href="#esa-815"><span class="linenos">815</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using NUMPY (Dense) engine. (N=</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> &lt;= </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="esa-816"><a href="#esa-816"><span class="linenos">816</span></a>            <span class="n">nn_instance</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NumpyNN</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
</span><span id="esa-817"><a href="#esa-817"><span class="linenos">817</span></a>
</span><span id="esa-818"><a href="#esa-818"><span class="linenos">818</span></a>    <span class="k">return</span> <span class="n">_esa</span><span class="p">(</span>
</span><span id="esa-819"><a href="#esa-819"><span class="linenos">819</span></a>        <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span><span id="esa-820"><a href="#esa-820"><span class="linenos">820</span></a>        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="esa-821"><a href="#esa-821"><span class="linenos">821</span></a>        <span class="n">nn_instance</span><span class="o">=</span><span class="n">nn_instance</span><span class="p">,</span>
</span><span id="esa-822"><a href="#esa-822"><span class="linenos">822</span></a>        <span class="n">metric_fn</span><span class="o">=</span><span class="n">metric_fn</span><span class="p">,</span>
</span><span id="esa-823"><a href="#esa-823"><span class="linenos">823</span></a>        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
</span><span id="esa-824"><a href="#esa-824"><span class="linenos">824</span></a>        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="esa-825"><a href="#esa-825"><span class="linenos">825</span></a>        <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
</span><span id="esa-826"><a href="#esa-826"><span class="linenos">826</span></a>        <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">,</span>
</span><span id="esa-827"><a href="#esa-827"><span class="linenos">827</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="esa-828"><a href="#esa-828"><span class="linenos">828</span></a>        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
</span><span id="esa-829"><a href="#esa-829"><span class="linenos">829</span></a>        <span class="n">radius</span><span class="o">=</span><span class="n">final_radius</span><span class="p">,</span>
</span><span id="esa-830"><a href="#esa-830"><span class="linenos">830</span></a>        <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span>
</span><span id="esa-831"><a href="#esa-831"><span class="linenos">831</span></a>        <span class="n">border_strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span>
</span><span id="esa-832"><a href="#esa-832"><span class="linenos">832</span></a>        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="esa-833"><a href="#esa-833"><span class="linenos">833</span></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="esa-834"><a href="#esa-834"><span class="linenos">834</span></a>        <span class="o">**</span><span class="n">metric_kwargs</span><span class="p">,</span>
</span><span id="esa-835"><a href="#esa-835"><span class="linenos">835</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for the Empty Space Algorithm (ESA) that returns only generated points.</p>

<p>This acts as the public API for the algorithm. It handles infrastructure setup
that the internal loop <code>_esa</code> requires, specifically:</p>

<ol>
<li><strong>Heuristic Calculation:</strong> Auto-computes interaction radius if not provided.</li>
<li><strong>Metric Scaling:</strong> Scales force parameters (like $\sigma$) relative to the radius.</li>
<li><strong>Engine Selection:</strong> Automatically chooses between a Dense Numpy engine (small $N$)
and an Approximate Nearest Neighbor (HNSW) engine (large $N$) for performance.</li>
</ol>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>samples (np.ndarray):</strong>  Existing points to avoid.</li>
<li><strong>bounds (np.ndarray):</strong>  Bounding box constraints.</li>
<li><strong>n (int):</strong>  Number of new points to create.</li>
<li><strong>nn_instance (nn.NearestNeighbors | None):</strong>  Optional custom NN engine.</li>
<li><strong>epochs (int):</strong>  Max iterations.</li>
<li><strong>lr (float):</strong>  Initial learning rate.</li>
<li><strong>search_mode (str):</strong>  'k_nn' (adaptive) or 'radius' (fixed range).</li>
<li><strong>decay (float):</strong>  LR decay per epoch.</li>
<li><strong>batch_size (int):</strong>  Optimization batch size.</li>
<li><strong>k (int | None):</strong>  Neighbors to use (if mode is 'k_nn').</li>
<li><strong>radius (float | None):</strong>  Force radius (if mode is 'radius').</li>
<li><strong>tol (float):</strong>  Early stopping tolerance.</li>
<li><strong>metric (str | Callable):</strong>  Name of force function or callable object.</li>
<li><strong>border_strategy (str):</strong>  'clip' (hard stop) or 'repulsive' (soft walls).</li>
<li><strong>seed (int):</strong>  Random seed.</li>
<li><strong>**metric_kwargs:</strong>  Arguments for the metric function.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: An array of size $(n, D)$ containing only the newly generated points.</p>
</blockquote>
</div>


                </section>
                <section id="ess">
                            <input id="ess-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ess</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">samples</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">bounds</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">n</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">nn_instance</span><span class="p">:</span> <span class="n"><a href="#NearestNeighbors">NearestNeighbors</a></span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span>,</span><span class="param">	<span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;k_nn&#39;</span>,</span><span class="param">	<span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span>,</span><span class="param">	<span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span>,</span><span class="param">	<span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Callable</span> <span class="o">=</span> <span class="s1">&#39;softened_inverse&#39;</span>,</span><span class="param">	<span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;clip&#39;</span>,</span><span class="param">	<span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="ess-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ess"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ess-838"><a href="#ess-838"><span class="linenos">838</span></a><span class="k">def</span><span class="w"> </span><span class="nf">ess</span><span class="p">(</span>
</span><span id="ess-839"><a href="#ess-839"><span class="linenos">839</span></a>    <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="ess-840"><a href="#ess-840"><span class="linenos">840</span></a>    <span class="n">bounds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="ess-841"><a href="#ess-841"><span class="linenos">841</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="ess-842"><a href="#ess-842"><span class="linenos">842</span></a>    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="ess-843"><a href="#ess-843"><span class="linenos">843</span></a>    <span class="n">nn_instance</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">NearestNeighbors</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ess-844"><a href="#ess-844"><span class="linenos">844</span></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="ess-845"><a href="#ess-845"><span class="linenos">845</span></a>    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="ess-846"><a href="#ess-846"><span class="linenos">846</span></a>    <span class="n">search_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;k_nn&quot;</span><span class="p">,</span>
</span><span id="ess-847"><a href="#ess-847"><span class="linenos">847</span></a>    <span class="n">decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
</span><span id="ess-848"><a href="#ess-848"><span class="linenos">848</span></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="ess-849"><a href="#ess-849"><span class="linenos">849</span></a>    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ess-850"><a href="#ess-850"><span class="linenos">850</span></a>    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ess-851"><a href="#ess-851"><span class="linenos">851</span></a>    <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
</span><span id="ess-852"><a href="#ess-852"><span class="linenos">852</span></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="s2">&quot;softened_inverse&quot;</span><span class="p">,</span>
</span><span id="ess-853"><a href="#ess-853"><span class="linenos">853</span></a>    <span class="n">border_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
</span><span id="ess-854"><a href="#ess-854"><span class="linenos">854</span></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
</span><span id="ess-855"><a href="#ess-855"><span class="linenos">855</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ess-856"><a href="#ess-856"><span class="linenos">856</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="ess-857"><a href="#ess-857"><span class="linenos">857</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ess-858"><a href="#ess-858"><span class="linenos">858</span></a><span class="sd">    High-level Empty Space Strategy (ESS) wrapper returning the full dataset.</span>
</span><span id="ess-859"><a href="#ess-859"><span class="linenos">859</span></a>
</span><span id="ess-860"><a href="#ess-860"><span class="linenos">860</span></a><span class="sd">    This convenience function runs the ESA algorithm and concatenates the results</span>
</span><span id="ess-861"><a href="#ess-861"><span class="linenos">861</span></a><span class="sd">    with the original input samples. It is useful for iterative design of experiments</span>
</span><span id="ess-862"><a href="#ess-862"><span class="linenos">862</span></a><span class="sd">    or sequential sampling workflows where the complete set of points is needed.</span>
</span><span id="ess-863"><a href="#ess-863"><span class="linenos">863</span></a>
</span><span id="ess-864"><a href="#ess-864"><span class="linenos">864</span></a><span class="sd">    $$ \\text{Result} = \\text{samples} \\cup \\text{ESA}(\\text{samples}, \\dots) $$</span>
</span><span id="ess-865"><a href="#ess-865"><span class="linenos">865</span></a>
</span><span id="ess-866"><a href="#ess-866"><span class="linenos">866</span></a><span class="sd">    Args:</span>
</span><span id="ess-867"><a href="#ess-867"><span class="linenos">867</span></a><span class="sd">        samples (np.ndarray | list): Existing points.</span>
</span><span id="ess-868"><a href="#ess-868"><span class="linenos">868</span></a><span class="sd">        bounds (np.ndarray): Domain boundaries.</span>
</span><span id="ess-869"><a href="#ess-869"><span class="linenos">869</span></a><span class="sd">        n (int): Number of new points to generate.</span>
</span><span id="ess-870"><a href="#ess-870"><span class="linenos">870</span></a><span class="sd">        nn_instance (nn.NearestNeighbors | None): NN engine.</span>
</span><span id="ess-871"><a href="#ess-871"><span class="linenos">871</span></a><span class="sd">        epochs (int): Optimization steps.</span>
</span><span id="ess-872"><a href="#ess-872"><span class="linenos">872</span></a><span class="sd">        lr (float): Learning rate.</span>
</span><span id="ess-873"><a href="#ess-873"><span class="linenos">873</span></a><span class="sd">        search_mode (str): Neighborhood search strategy.</span>
</span><span id="ess-874"><a href="#ess-874"><span class="linenos">874</span></a><span class="sd">        decay (float): Decay rate.</span>
</span><span id="ess-875"><a href="#ess-875"><span class="linenos">875</span></a><span class="sd">        batch_size (int): Batch size.</span>
</span><span id="ess-876"><a href="#ess-876"><span class="linenos">876</span></a><span class="sd">        k (int | None): Neighbors count.</span>
</span><span id="ess-877"><a href="#ess-877"><span class="linenos">877</span></a><span class="sd">        radius (float | None): Interaction radius.</span>
</span><span id="ess-878"><a href="#ess-878"><span class="linenos">878</span></a><span class="sd">        tol (float): Convergence tolerance.</span>
</span><span id="ess-879"><a href="#ess-879"><span class="linenos">879</span></a><span class="sd">        metric (str | Callable): Force metric.</span>
</span><span id="ess-880"><a href="#ess-880"><span class="linenos">880</span></a><span class="sd">        border_strategy (str): Boundary handling.</span>
</span><span id="ess-881"><a href="#ess-881"><span class="linenos">881</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="ess-882"><a href="#ess-882"><span class="linenos">882</span></a><span class="sd">        **kwargs: Additional metric args.</span>
</span><span id="ess-883"><a href="#ess-883"><span class="linenos">883</span></a>
</span><span id="ess-884"><a href="#ess-884"><span class="linenos">884</span></a><span class="sd">    Returns:</span>
</span><span id="ess-885"><a href="#ess-885"><span class="linenos">885</span></a><span class="sd">        np.ndarray: A combined array of shape $(N + n, D)$ containing original and new points.</span>
</span><span id="ess-886"><a href="#ess-886"><span class="linenos">886</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ess-887"><a href="#ess-887"><span class="linenos">887</span></a>
</span><span id="ess-888"><a href="#ess-888"><span class="linenos">888</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ess-889"><a href="#ess-889"><span class="linenos">889</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="ess-890"><a href="#ess-890"><span class="linenos">890</span></a>
</span><span id="ess-891"><a href="#ess-891"><span class="linenos">891</span></a>    <span class="n">new_points</span> <span class="o">=</span> <span class="n">esa</span><span class="p">(</span>
</span><span id="ess-892"><a href="#ess-892"><span class="linenos">892</span></a>        <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
</span><span id="ess-893"><a href="#ess-893"><span class="linenos">893</span></a>        <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
</span><span id="ess-894"><a href="#ess-894"><span class="linenos">894</span></a>        <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
</span><span id="ess-895"><a href="#ess-895"><span class="linenos">895</span></a>        <span class="n">nn_instance</span><span class="o">=</span><span class="n">nn_instance</span><span class="p">,</span>
</span><span id="ess-896"><a href="#ess-896"><span class="linenos">896</span></a>        <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="ess-897"><a href="#ess-897"><span class="linenos">897</span></a>        <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span>
</span><span id="ess-898"><a href="#ess-898"><span class="linenos">898</span></a>        <span class="n">decay</span><span class="o">=</span><span class="n">decay</span><span class="p">,</span>
</span><span id="ess-899"><a href="#ess-899"><span class="linenos">899</span></a>        <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
</span><span id="ess-900"><a href="#ess-900"><span class="linenos">900</span></a>        <span class="n">border_strategy</span><span class="o">=</span><span class="n">border_strategy</span><span class="p">,</span>
</span><span id="ess-901"><a href="#ess-901"><span class="linenos">901</span></a>        <span class="n">search_mode</span><span class="o">=</span><span class="n">search_mode</span><span class="p">,</span>
</span><span id="ess-902"><a href="#ess-902"><span class="linenos">902</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="ess-903"><a href="#ess-903"><span class="linenos">903</span></a>        <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Let ESA determine K</span>
</span><span id="ess-904"><a href="#ess-904"><span class="linenos">904</span></a>        <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
</span><span id="ess-905"><a href="#ess-905"><span class="linenos">905</span></a>        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
</span><span id="ess-906"><a href="#ess-906"><span class="linenos">906</span></a>        <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="ess-907"><a href="#ess-907"><span class="linenos">907</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="ess-908"><a href="#ess-908"><span class="linenos">908</span></a>    <span class="p">)</span>
</span><span id="ess-909"><a href="#ess-909"><span class="linenos">909</span></a>
</span><span id="ess-910"><a href="#ess-910"><span class="linenos">910</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">samples</span><span class="p">,</span> <span class="n">new_points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>High-level Empty Space Strategy (ESS) wrapper returning the full dataset.</p>

<p>This convenience function runs the ESA algorithm and concatenates the results
with the original input samples. It is useful for iterative design of experiments
or sequential sampling workflows where the complete set of points is needed.</p>

<p>$$ \text{Result} = \text{samples} \cup \text{ESA}(\text{samples}, \dots) $$</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>samples (np.ndarray | list):</strong>  Existing points.</li>
<li><strong>bounds (np.ndarray):</strong>  Domain boundaries.</li>
<li><strong>n (int):</strong>  Number of new points to generate.</li>
<li><strong>nn_instance (nn.NearestNeighbors | None):</strong>  NN engine.</li>
<li><strong>epochs (int):</strong>  Optimization steps.</li>
<li><strong>lr (float):</strong>  Learning rate.</li>
<li><strong>search_mode (str):</strong>  Neighborhood search strategy.</li>
<li><strong>decay (float):</strong>  Decay rate.</li>
<li><strong>batch_size (int):</strong>  Batch size.</li>
<li><strong>k (int | None):</strong>  Neighbors count.</li>
<li><strong>radius (float | None):</strong>  Interaction radius.</li>
<li><strong>tol (float):</strong>  Convergence tolerance.</li>
<li><strong>metric (str | Callable):</strong>  Force metric.</li>
<li><strong>border_strategy (str):</strong>  Boundary handling.</li>
<li><strong>seed (int):</strong>  Random seed.</li>
<li><strong>**kwargs:</strong>  Additional metric args.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>np.ndarray: A combined array of shape $(N + n, D)$ containing original and new points.</p>
</blockquote>
</div>


                </section>
                <section id="NearestNeighbors">
                            <input id="NearestNeighbors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NearestNeighbors</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="NearestNeighbors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors-14"><a href="#NearestNeighbors-14"><span class="linenos"> 14</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NearestNeighbors</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="NearestNeighbors-15"><a href="#NearestNeighbors-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-16"><a href="#NearestNeighbors-16"><span class="linenos"> 16</span></a><span class="sd">    Abstract Base Class for Nearest Neighbors implementations tailored for ESA.</span>
</span><span id="NearestNeighbors-17"><a href="#NearestNeighbors-17"><span class="linenos"> 17</span></a>
</span><span id="NearestNeighbors-18"><a href="#NearestNeighbors-18"><span class="linenos"> 18</span></a><span class="sd">    This interface defines the contract for hybrid neighbor search engines that manage</span>
</span><span id="NearestNeighbors-19"><a href="#NearestNeighbors-19"><span class="linenos"> 19</span></a><span class="sd">    two sets of points:</span>
</span><span id="NearestNeighbors-20"><a href="#NearestNeighbors-20"><span class="linenos"> 20</span></a><span class="sd">    1. **Static Set:** Fixed points (anchors/obstacles) that accumulate over time.</span>
</span><span id="NearestNeighbors-21"><a href="#NearestNeighbors-21"><span class="linenos"> 21</span></a><span class="sd">    2. **Active Set:** A transient batch of points currently being optimized.</span>
</span><span id="NearestNeighbors-22"><a href="#NearestNeighbors-22"><span class="linenos"> 22</span></a>
</span><span id="NearestNeighbors-23"><a href="#NearestNeighbors-23"><span class="linenos"> 23</span></a><span class="sd">    The implementations must support efficient queries of Active points against the</span>
</span><span id="NearestNeighbors-24"><a href="#NearestNeighbors-24"><span class="linenos"> 24</span></a><span class="sd">    union of both sets: $P_{query} \\in Active \\to \\{P_{static} \\cup P_{active}\\}$.</span>
</span><span id="NearestNeighbors-25"><a href="#NearestNeighbors-25"><span class="linenos"> 25</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-26"><a href="#NearestNeighbors-26"><span class="linenos"> 26</span></a>
</span><span id="NearestNeighbors-27"><a href="#NearestNeighbors-27"><span class="linenos"> 27</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
</span><span id="NearestNeighbors-28"><a href="#NearestNeighbors-28"><span class="linenos"> 28</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="n">dimension</span>
</span><span id="NearestNeighbors-29"><a href="#NearestNeighbors-29"><span class="linenos"> 29</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
</span><span id="NearestNeighbors-30"><a href="#NearestNeighbors-30"><span class="linenos"> 30</span></a>
</span><span id="NearestNeighbors-31"><a href="#NearestNeighbors-31"><span class="linenos"> 31</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-32"><a href="#NearestNeighbors-32"><span class="linenos"> 32</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors-33"><a href="#NearestNeighbors-33"><span class="linenos"> 33</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-34"><a href="#NearestNeighbors-34"><span class="linenos"> 34</span></a><span class="sd">        Adds points to the persistent static set.</span>
</span><span id="NearestNeighbors-35"><a href="#NearestNeighbors-35"><span class="linenos"> 35</span></a>
</span><span id="NearestNeighbors-36"><a href="#NearestNeighbors-36"><span class="linenos"> 36</span></a><span class="sd">        These points represent obstacles or previously consolidated solutions that the active</span>
</span><span id="NearestNeighbors-37"><a href="#NearestNeighbors-37"><span class="linenos"> 37</span></a><span class="sd">        batch must avoid.</span>
</span><span id="NearestNeighbors-38"><a href="#NearestNeighbors-38"><span class="linenos"> 38</span></a>
</span><span id="NearestNeighbors-39"><a href="#NearestNeighbors-39"><span class="linenos"> 39</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors-40"><a href="#NearestNeighbors-40"><span class="linenos"> 40</span></a><span class="sd">            points (np.ndarray): Array of shape $(N, D)$ to add to the index.</span>
</span><span id="NearestNeighbors-41"><a href="#NearestNeighbors-41"><span class="linenos"> 41</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-42"><a href="#NearestNeighbors-42"><span class="linenos"> 42</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-43"><a href="#NearestNeighbors-43"><span class="linenos"> 43</span></a>
</span><span id="NearestNeighbors-44"><a href="#NearestNeighbors-44"><span class="linenos"> 44</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-45"><a href="#NearestNeighbors-45"><span class="linenos"> 45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors-46"><a href="#NearestNeighbors-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-47"><a href="#NearestNeighbors-47"><span class="linenos"> 47</span></a><span class="sd">        Sets the current batch of active points for optimization.</span>
</span><span id="NearestNeighbors-48"><a href="#NearestNeighbors-48"><span class="linenos"> 48</span></a>
</span><span id="NearestNeighbors-49"><a href="#NearestNeighbors-49"><span class="linenos"> 49</span></a><span class="sd">        These points are transient and updated iteratively. Setting a new active batch</span>
</span><span id="NearestNeighbors-50"><a href="#NearestNeighbors-50"><span class="linenos"> 50</span></a><span class="sd">        replaces the previous one.</span>
</span><span id="NearestNeighbors-51"><a href="#NearestNeighbors-51"><span class="linenos"> 51</span></a>
</span><span id="NearestNeighbors-52"><a href="#NearestNeighbors-52"><span class="linenos"> 52</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors-53"><a href="#NearestNeighbors-53"><span class="linenos"> 53</span></a><span class="sd">            points (np.ndarray): Array of shape $(M, D)$ representing the moving particles.</span>
</span><span id="NearestNeighbors-54"><a href="#NearestNeighbors-54"><span class="linenos"> 54</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-55"><a href="#NearestNeighbors-55"><span class="linenos"> 55</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-56"><a href="#NearestNeighbors-56"><span class="linenos"> 56</span></a>
</span><span id="NearestNeighbors-57"><a href="#NearestNeighbors-57"><span class="linenos"> 57</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-58"><a href="#NearestNeighbors-58"><span class="linenos"> 58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors-59"><a href="#NearestNeighbors-59"><span class="linenos"> 59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-60"><a href="#NearestNeighbors-60"><span class="linenos"> 60</span></a><span class="sd">        Merges the current active points into the static set.</span>
</span><span id="NearestNeighbors-61"><a href="#NearestNeighbors-61"><span class="linenos"> 61</span></a>
</span><span id="NearestNeighbors-62"><a href="#NearestNeighbors-62"><span class="linenos"> 62</span></a><span class="sd">        This is typically called when the optimization of the current batch converges.</span>
</span><span id="NearestNeighbors-63"><a href="#NearestNeighbors-63"><span class="linenos"> 63</span></a><span class="sd">        The active points become permanent obstacles for future batches.</span>
</span><span id="NearestNeighbors-64"><a href="#NearestNeighbors-64"><span class="linenos"> 64</span></a>
</span><span id="NearestNeighbors-65"><a href="#NearestNeighbors-65"><span class="linenos"> 65</span></a><span class="sd">        $ S_{new} = S_{old} \\cup A_{current} $</span>
</span><span id="NearestNeighbors-66"><a href="#NearestNeighbors-66"><span class="linenos"> 66</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-67"><a href="#NearestNeighbors-67"><span class="linenos"> 67</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-68"><a href="#NearestNeighbors-68"><span class="linenos"> 68</span></a>
</span><span id="NearestNeighbors-69"><a href="#NearestNeighbors-69"><span class="linenos"> 69</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-70"><a href="#NearestNeighbors-70"><span class="linenos"> 70</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NearestNeighbors-71"><a href="#NearestNeighbors-71"><span class="linenos"> 71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-72"><a href="#NearestNeighbors-72"><span class="linenos"> 72</span></a><span class="sd">        Finds the $k$-nearest neighbors for the ACTIVE batch against the full set (Static + Active).</span>
</span><span id="NearestNeighbors-73"><a href="#NearestNeighbors-73"><span class="linenos"> 73</span></a>
</span><span id="NearestNeighbors-74"><a href="#NearestNeighbors-74"><span class="linenos"> 74</span></a><span class="sd">        For each point $x_i$ in the active set, this computes:</span>
</span><span id="NearestNeighbors-75"><a href="#NearestNeighbors-75"><span class="linenos"> 75</span></a><span class="sd">        $ N(x_i) = \\{ y \\in (S \\cup A) \\mid \\text{rank}(||x_i - y||) \\le k \\} $</span>
</span><span id="NearestNeighbors-76"><a href="#NearestNeighbors-76"><span class="linenos"> 76</span></a>
</span><span id="NearestNeighbors-77"><a href="#NearestNeighbors-77"><span class="linenos"> 77</span></a><span class="sd">        The results serve as the basis for k-NN repulsive forces.</span>
</span><span id="NearestNeighbors-78"><a href="#NearestNeighbors-78"><span class="linenos"> 78</span></a>
</span><span id="NearestNeighbors-79"><a href="#NearestNeighbors-79"><span class="linenos"> 79</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors-80"><a href="#NearestNeighbors-80"><span class="linenos"> 80</span></a><span class="sd">            k (int): The number of neighbors to retrieve.</span>
</span><span id="NearestNeighbors-81"><a href="#NearestNeighbors-81"><span class="linenos"> 81</span></a>
</span><span id="NearestNeighbors-82"><a href="#NearestNeighbors-82"><span class="linenos"> 82</span></a><span class="sd">        Returns:</span>
</span><span id="NearestNeighbors-83"><a href="#NearestNeighbors-83"><span class="linenos"> 83</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]:</span>
</span><span id="NearestNeighbors-84"><a href="#NearestNeighbors-84"><span class="linenos"> 84</span></a><span class="sd">                - **Indices**: Shape $(M, k)$, global indices of neighbors.</span>
</span><span id="NearestNeighbors-85"><a href="#NearestNeighbors-85"><span class="linenos"> 85</span></a><span class="sd">                - **Distances**: Shape $(M, k)$, Euclidean distances to neighbors.</span>
</span><span id="NearestNeighbors-86"><a href="#NearestNeighbors-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-87"><a href="#NearestNeighbors-87"><span class="linenos"> 87</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-88"><a href="#NearestNeighbors-88"><span class="linenos"> 88</span></a>
</span><span id="NearestNeighbors-89"><a href="#NearestNeighbors-89"><span class="linenos"> 89</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-90"><a href="#NearestNeighbors-90"><span class="linenos"> 90</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_static</span><span class="p">(</span>
</span><span id="NearestNeighbors-91"><a href="#NearestNeighbors-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">query_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="NearestNeighbors-92"><a href="#NearestNeighbors-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NearestNeighbors-93"><a href="#NearestNeighbors-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-94"><a href="#NearestNeighbors-94"><span class="linenos"> 94</span></a><span class="sd">        Finds the $k$-nearest neighbors for arbitrary query points against the STATIC set only.</span>
</span><span id="NearestNeighbors-95"><a href="#NearestNeighbors-95"><span class="linenos"> 95</span></a>
</span><span id="NearestNeighbors-96"><a href="#NearestNeighbors-96"><span class="linenos"> 96</span></a><span class="sd">        Used mainly for initialization heuristics where we only care about distance to</span>
</span><span id="NearestNeighbors-97"><a href="#NearestNeighbors-97"><span class="linenos"> 97</span></a><span class="sd">        established obstacles, ignoring other nascent points.</span>
</span><span id="NearestNeighbors-98"><a href="#NearestNeighbors-98"><span class="linenos"> 98</span></a>
</span><span id="NearestNeighbors-99"><a href="#NearestNeighbors-99"><span class="linenos"> 99</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors-100"><a href="#NearestNeighbors-100"><span class="linenos">100</span></a><span class="sd">            query_points (np.ndarray): The query coordinates $(Q, D)$.</span>
</span><span id="NearestNeighbors-101"><a href="#NearestNeighbors-101"><span class="linenos">101</span></a><span class="sd">            k (int): Number of neighbors.</span>
</span><span id="NearestNeighbors-102"><a href="#NearestNeighbors-102"><span class="linenos">102</span></a>
</span><span id="NearestNeighbors-103"><a href="#NearestNeighbors-103"><span class="linenos">103</span></a><span class="sd">        Returns:</span>
</span><span id="NearestNeighbors-104"><a href="#NearestNeighbors-104"><span class="linenos">104</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: Indices and distances.</span>
</span><span id="NearestNeighbors-105"><a href="#NearestNeighbors-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-106"><a href="#NearestNeighbors-106"><span class="linenos">106</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-107"><a href="#NearestNeighbors-107"><span class="linenos">107</span></a>
</span><span id="NearestNeighbors-108"><a href="#NearestNeighbors-108"><span class="linenos">108</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-109"><a href="#NearestNeighbors-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">range_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NearestNeighbors-110"><a href="#NearestNeighbors-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-111"><a href="#NearestNeighbors-111"><span class="linenos">111</span></a><span class="sd">        Finds all neighbors within a fixed `radius` for the ACTIVE batch.</span>
</span><span id="NearestNeighbors-112"><a href="#NearestNeighbors-112"><span class="linenos">112</span></a>
</span><span id="NearestNeighbors-113"><a href="#NearestNeighbors-113"><span class="linenos">113</span></a><span class="sd">        This returns a dense matrix representation suitable for vectorized force calculation.</span>
</span><span id="NearestNeighbors-114"><a href="#NearestNeighbors-114"><span class="linenos">114</span></a><span class="sd">        For active point $x_i$ and potential neighbor $y_j$:</span>
</span><span id="NearestNeighbors-115"><a href="#NearestNeighbors-115"><span class="linenos">115</span></a>
</span><span id="NearestNeighbors-116"><a href="#NearestNeighbors-116"><span class="linenos">116</span></a><span class="sd">        $ M_{ij} = \\begin{cases} ||x_i - y_j|| &amp; \\text{if } ||x_i - y_j|| &lt; R \\\\ 0 &amp; \\text{otherwise} \\end{cases} $</span>
</span><span id="NearestNeighbors-117"><a href="#NearestNeighbors-117"><span class="linenos">117</span></a>
</span><span id="NearestNeighbors-118"><a href="#NearestNeighbors-118"><span class="linenos">118</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors-119"><a href="#NearestNeighbors-119"><span class="linenos">119</span></a><span class="sd">            radius (float): The cutoff distance $R$.</span>
</span><span id="NearestNeighbors-120"><a href="#NearestNeighbors-120"><span class="linenos">120</span></a>
</span><span id="NearestNeighbors-121"><a href="#NearestNeighbors-121"><span class="linenos">121</span></a><span class="sd">        Returns:</span>
</span><span id="NearestNeighbors-122"><a href="#NearestNeighbors-122"><span class="linenos">122</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]:</span>
</span><span id="NearestNeighbors-123"><a href="#NearestNeighbors-123"><span class="linenos">123</span></a><span class="sd">                - **Distances**: Dense matrix $(M, N_{total})$. Zero where no neighbor exists.</span>
</span><span id="NearestNeighbors-124"><a href="#NearestNeighbors-124"><span class="linenos">124</span></a><span class="sd">                - **Mask**: Boolean matrix $(M, N_{total})$. True where $d &lt; R$.</span>
</span><span id="NearestNeighbors-125"><a href="#NearestNeighbors-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-126"><a href="#NearestNeighbors-126"><span class="linenos">126</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-127"><a href="#NearestNeighbors-127"><span class="linenos">127</span></a>
</span><span id="NearestNeighbors-128"><a href="#NearestNeighbors-128"><span class="linenos">128</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-129"><a href="#NearestNeighbors-129"><span class="linenos">129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors-130"><a href="#NearestNeighbors-130"><span class="linenos">130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-131"><a href="#NearestNeighbors-131"><span class="linenos">131</span></a><span class="sd">        Resets the internal state, clearing both static and active sets.</span>
</span><span id="NearestNeighbors-132"><a href="#NearestNeighbors-132"><span class="linenos">132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-133"><a href="#NearestNeighbors-133"><span class="linenos">133</span></a>        <span class="k">pass</span>
</span><span id="NearestNeighbors-134"><a href="#NearestNeighbors-134"><span class="linenos">134</span></a>
</span><span id="NearestNeighbors-135"><a href="#NearestNeighbors-135"><span class="linenos">135</span></a>    <span class="nd">@property</span>
</span><span id="NearestNeighbors-136"><a href="#NearestNeighbors-136"><span class="linenos">136</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors-137"><a href="#NearestNeighbors-137"><span class="linenos">137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="NearestNeighbors-138"><a href="#NearestNeighbors-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-139"><a href="#NearestNeighbors-139"><span class="linenos">139</span></a><span class="sd">        Returns the total number of points currently managed (Static + Active).</span>
</span><span id="NearestNeighbors-140"><a href="#NearestNeighbors-140"><span class="linenos">140</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors-141"><a href="#NearestNeighbors-141"><span class="linenos">141</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Abstract Base Class for Nearest Neighbors implementations tailored for ESA.</p>

<p>This interface defines the contract for hybrid neighbor search engines that manage
two sets of points:</p>

<ol>
<li><strong>Static Set:</strong> Fixed points (anchors/obstacles) that accumulate over time.</li>
<li><strong>Active Set:</strong> A transient batch of points currently being optimized.</li>
</ol>

<p>The implementations must support efficient queries of Active points against the
union of both sets: $P_{query} \in Active \to {P_{static} \cup P_{active}}$.</p>
</div>


                            <div id="NearestNeighbors.dimension" class="classattr">
                                <div class="attr variable">
            <span class="name">dimension</span>

        
    </div>
    <a class="headerlink" href="#NearestNeighbors.dimension"></a>
    
    

                            </div>
                            <div id="NearestNeighbors.seed" class="classattr">
                                <div class="attr variable">
            <span class="name">seed</span>

        
    </div>
    <a class="headerlink" href="#NearestNeighbors.seed"></a>
    
    

                            </div>
                            <div id="NearestNeighbors.add_static" class="classattr">
                                        <input id="NearestNeighbors.add_static-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">add_static</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">points</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.add_static-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.add_static"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.add_static-31"><a href="#NearestNeighbors.add_static-31"><span class="linenos">31</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.add_static-32"><a href="#NearestNeighbors.add_static-32"><span class="linenos">32</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors.add_static-33"><a href="#NearestNeighbors.add_static-33"><span class="linenos">33</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.add_static-34"><a href="#NearestNeighbors.add_static-34"><span class="linenos">34</span></a><span class="sd">        Adds points to the persistent static set.</span>
</span><span id="NearestNeighbors.add_static-35"><a href="#NearestNeighbors.add_static-35"><span class="linenos">35</span></a>
</span><span id="NearestNeighbors.add_static-36"><a href="#NearestNeighbors.add_static-36"><span class="linenos">36</span></a><span class="sd">        These points represent obstacles or previously consolidated solutions that the active</span>
</span><span id="NearestNeighbors.add_static-37"><a href="#NearestNeighbors.add_static-37"><span class="linenos">37</span></a><span class="sd">        batch must avoid.</span>
</span><span id="NearestNeighbors.add_static-38"><a href="#NearestNeighbors.add_static-38"><span class="linenos">38</span></a>
</span><span id="NearestNeighbors.add_static-39"><a href="#NearestNeighbors.add_static-39"><span class="linenos">39</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors.add_static-40"><a href="#NearestNeighbors.add_static-40"><span class="linenos">40</span></a><span class="sd">            points (np.ndarray): Array of shape $(N, D)$ to add to the index.</span>
</span><span id="NearestNeighbors.add_static-41"><a href="#NearestNeighbors.add_static-41"><span class="linenos">41</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.add_static-42"><a href="#NearestNeighbors.add_static-42"><span class="linenos">42</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Adds points to the persistent static set.</p>

<p>These points represent obstacles or previously consolidated solutions that the active
batch must avoid.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>points (np.ndarray):</strong>  Array of shape $(N, D)$ to add to the index.</li>
</ul>
</div>


                            </div>
                            <div id="NearestNeighbors.set_active" class="classattr">
                                        <input id="NearestNeighbors.set_active-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">set_active</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">points</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.set_active-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.set_active"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.set_active-44"><a href="#NearestNeighbors.set_active-44"><span class="linenos">44</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.set_active-45"><a href="#NearestNeighbors.set_active-45"><span class="linenos">45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors.set_active-46"><a href="#NearestNeighbors.set_active-46"><span class="linenos">46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.set_active-47"><a href="#NearestNeighbors.set_active-47"><span class="linenos">47</span></a><span class="sd">        Sets the current batch of active points for optimization.</span>
</span><span id="NearestNeighbors.set_active-48"><a href="#NearestNeighbors.set_active-48"><span class="linenos">48</span></a>
</span><span id="NearestNeighbors.set_active-49"><a href="#NearestNeighbors.set_active-49"><span class="linenos">49</span></a><span class="sd">        These points are transient and updated iteratively. Setting a new active batch</span>
</span><span id="NearestNeighbors.set_active-50"><a href="#NearestNeighbors.set_active-50"><span class="linenos">50</span></a><span class="sd">        replaces the previous one.</span>
</span><span id="NearestNeighbors.set_active-51"><a href="#NearestNeighbors.set_active-51"><span class="linenos">51</span></a>
</span><span id="NearestNeighbors.set_active-52"><a href="#NearestNeighbors.set_active-52"><span class="linenos">52</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors.set_active-53"><a href="#NearestNeighbors.set_active-53"><span class="linenos">53</span></a><span class="sd">            points (np.ndarray): Array of shape $(M, D)$ representing the moving particles.</span>
</span><span id="NearestNeighbors.set_active-54"><a href="#NearestNeighbors.set_active-54"><span class="linenos">54</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.set_active-55"><a href="#NearestNeighbors.set_active-55"><span class="linenos">55</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Sets the current batch of active points for optimization.</p>

<p>These points are transient and updated iteratively. Setting a new active batch
replaces the previous one.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>points (np.ndarray):</strong>  Array of shape $(M, D)$ representing the moving particles.</li>
</ul>
</div>


                            </div>
                            <div id="NearestNeighbors.consolidate" class="classattr">
                                        <input id="NearestNeighbors.consolidate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">consolidate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.consolidate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.consolidate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.consolidate-57"><a href="#NearestNeighbors.consolidate-57"><span class="linenos">57</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.consolidate-58"><a href="#NearestNeighbors.consolidate-58"><span class="linenos">58</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors.consolidate-59"><a href="#NearestNeighbors.consolidate-59"><span class="linenos">59</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.consolidate-60"><a href="#NearestNeighbors.consolidate-60"><span class="linenos">60</span></a><span class="sd">        Merges the current active points into the static set.</span>
</span><span id="NearestNeighbors.consolidate-61"><a href="#NearestNeighbors.consolidate-61"><span class="linenos">61</span></a>
</span><span id="NearestNeighbors.consolidate-62"><a href="#NearestNeighbors.consolidate-62"><span class="linenos">62</span></a><span class="sd">        This is typically called when the optimization of the current batch converges.</span>
</span><span id="NearestNeighbors.consolidate-63"><a href="#NearestNeighbors.consolidate-63"><span class="linenos">63</span></a><span class="sd">        The active points become permanent obstacles for future batches.</span>
</span><span id="NearestNeighbors.consolidate-64"><a href="#NearestNeighbors.consolidate-64"><span class="linenos">64</span></a>
</span><span id="NearestNeighbors.consolidate-65"><a href="#NearestNeighbors.consolidate-65"><span class="linenos">65</span></a><span class="sd">        $ S_{new} = S_{old} \\cup A_{current} $</span>
</span><span id="NearestNeighbors.consolidate-66"><a href="#NearestNeighbors.consolidate-66"><span class="linenos">66</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.consolidate-67"><a href="#NearestNeighbors.consolidate-67"><span class="linenos">67</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Merges the current active points into the static set.</p>

<p>This is typically called when the optimization of the current batch converges.
The active points become permanent obstacles for future batches.</p>

<p>$ S_{new} = S_{old} \cup A_{current} $</p>
</div>


                            </div>
                            <div id="NearestNeighbors.query_nn" class="classattr">
                                        <input id="NearestNeighbors.query_nn-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">query_nn</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">k</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.query_nn-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.query_nn"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.query_nn-69"><a href="#NearestNeighbors.query_nn-69"><span class="linenos">69</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.query_nn-70"><a href="#NearestNeighbors.query_nn-70"><span class="linenos">70</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NearestNeighbors.query_nn-71"><a href="#NearestNeighbors.query_nn-71"><span class="linenos">71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.query_nn-72"><a href="#NearestNeighbors.query_nn-72"><span class="linenos">72</span></a><span class="sd">        Finds the $k$-nearest neighbors for the ACTIVE batch against the full set (Static + Active).</span>
</span><span id="NearestNeighbors.query_nn-73"><a href="#NearestNeighbors.query_nn-73"><span class="linenos">73</span></a>
</span><span id="NearestNeighbors.query_nn-74"><a href="#NearestNeighbors.query_nn-74"><span class="linenos">74</span></a><span class="sd">        For each point $x_i$ in the active set, this computes:</span>
</span><span id="NearestNeighbors.query_nn-75"><a href="#NearestNeighbors.query_nn-75"><span class="linenos">75</span></a><span class="sd">        $ N(x_i) = \\{ y \\in (S \\cup A) \\mid \\text{rank}(||x_i - y||) \\le k \\} $</span>
</span><span id="NearestNeighbors.query_nn-76"><a href="#NearestNeighbors.query_nn-76"><span class="linenos">76</span></a>
</span><span id="NearestNeighbors.query_nn-77"><a href="#NearestNeighbors.query_nn-77"><span class="linenos">77</span></a><span class="sd">        The results serve as the basis for k-NN repulsive forces.</span>
</span><span id="NearestNeighbors.query_nn-78"><a href="#NearestNeighbors.query_nn-78"><span class="linenos">78</span></a>
</span><span id="NearestNeighbors.query_nn-79"><a href="#NearestNeighbors.query_nn-79"><span class="linenos">79</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors.query_nn-80"><a href="#NearestNeighbors.query_nn-80"><span class="linenos">80</span></a><span class="sd">            k (int): The number of neighbors to retrieve.</span>
</span><span id="NearestNeighbors.query_nn-81"><a href="#NearestNeighbors.query_nn-81"><span class="linenos">81</span></a>
</span><span id="NearestNeighbors.query_nn-82"><a href="#NearestNeighbors.query_nn-82"><span class="linenos">82</span></a><span class="sd">        Returns:</span>
</span><span id="NearestNeighbors.query_nn-83"><a href="#NearestNeighbors.query_nn-83"><span class="linenos">83</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]:</span>
</span><span id="NearestNeighbors.query_nn-84"><a href="#NearestNeighbors.query_nn-84"><span class="linenos">84</span></a><span class="sd">                - **Indices**: Shape $(M, k)$, global indices of neighbors.</span>
</span><span id="NearestNeighbors.query_nn-85"><a href="#NearestNeighbors.query_nn-85"><span class="linenos">85</span></a><span class="sd">                - **Distances**: Shape $(M, k)$, Euclidean distances to neighbors.</span>
</span><span id="NearestNeighbors.query_nn-86"><a href="#NearestNeighbors.query_nn-86"><span class="linenos">86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.query_nn-87"><a href="#NearestNeighbors.query_nn-87"><span class="linenos">87</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Finds the $k$-nearest neighbors for the ACTIVE batch against the full set (Static + Active).</p>

<p>For each point $x_i$ in the active set, this computes:
$ N(x_i) = { y \in (S \cup A) \mid \text{rank}(||x_i - y||) \le k } $</p>

<p>The results serve as the basis for k-NN repulsive forces.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>k (int):</strong>  The number of neighbors to retrieve.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[np.ndarray, np.ndarray]:
      - <strong>Indices</strong>: Shape $(M, k)$, global indices of neighbors.
      - <strong>Distances</strong>: Shape $(M, k)$, Euclidean distances to neighbors.</p>
</blockquote>
</div>


                            </div>
                            <div id="NearestNeighbors.query_static" class="classattr">
                                        <input id="NearestNeighbors.query_static-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">query_static</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query_points</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">k</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.query_static-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.query_static"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.query_static-89"><a href="#NearestNeighbors.query_static-89"><span class="linenos"> 89</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.query_static-90"><a href="#NearestNeighbors.query_static-90"><span class="linenos"> 90</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_static</span><span class="p">(</span>
</span><span id="NearestNeighbors.query_static-91"><a href="#NearestNeighbors.query_static-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">query_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="NearestNeighbors.query_static-92"><a href="#NearestNeighbors.query_static-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NearestNeighbors.query_static-93"><a href="#NearestNeighbors.query_static-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.query_static-94"><a href="#NearestNeighbors.query_static-94"><span class="linenos"> 94</span></a><span class="sd">        Finds the $k$-nearest neighbors for arbitrary query points against the STATIC set only.</span>
</span><span id="NearestNeighbors.query_static-95"><a href="#NearestNeighbors.query_static-95"><span class="linenos"> 95</span></a>
</span><span id="NearestNeighbors.query_static-96"><a href="#NearestNeighbors.query_static-96"><span class="linenos"> 96</span></a><span class="sd">        Used mainly for initialization heuristics where we only care about distance to</span>
</span><span id="NearestNeighbors.query_static-97"><a href="#NearestNeighbors.query_static-97"><span class="linenos"> 97</span></a><span class="sd">        established obstacles, ignoring other nascent points.</span>
</span><span id="NearestNeighbors.query_static-98"><a href="#NearestNeighbors.query_static-98"><span class="linenos"> 98</span></a>
</span><span id="NearestNeighbors.query_static-99"><a href="#NearestNeighbors.query_static-99"><span class="linenos"> 99</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors.query_static-100"><a href="#NearestNeighbors.query_static-100"><span class="linenos">100</span></a><span class="sd">            query_points (np.ndarray): The query coordinates $(Q, D)$.</span>
</span><span id="NearestNeighbors.query_static-101"><a href="#NearestNeighbors.query_static-101"><span class="linenos">101</span></a><span class="sd">            k (int): Number of neighbors.</span>
</span><span id="NearestNeighbors.query_static-102"><a href="#NearestNeighbors.query_static-102"><span class="linenos">102</span></a>
</span><span id="NearestNeighbors.query_static-103"><a href="#NearestNeighbors.query_static-103"><span class="linenos">103</span></a><span class="sd">        Returns:</span>
</span><span id="NearestNeighbors.query_static-104"><a href="#NearestNeighbors.query_static-104"><span class="linenos">104</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: Indices and distances.</span>
</span><span id="NearestNeighbors.query_static-105"><a href="#NearestNeighbors.query_static-105"><span class="linenos">105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.query_static-106"><a href="#NearestNeighbors.query_static-106"><span class="linenos">106</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Finds the $k$-nearest neighbors for arbitrary query points against the STATIC set only.</p>

<p>Used mainly for initialization heuristics where we only care about distance to
established obstacles, ignoring other nascent points.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>query_points (np.ndarray):</strong>  The query coordinates $(Q, D)$.</li>
<li><strong>k (int):</strong>  Number of neighbors.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[np.ndarray, np.ndarray]: Indices and distances.</p>
</blockquote>
</div>


                            </div>
                            <div id="NearestNeighbors.range_search" class="classattr">
                                        <input id="NearestNeighbors.range_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">range_search</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">radius</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.range_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.range_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.range_search-108"><a href="#NearestNeighbors.range_search-108"><span class="linenos">108</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.range_search-109"><a href="#NearestNeighbors.range_search-109"><span class="linenos">109</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">range_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NearestNeighbors.range_search-110"><a href="#NearestNeighbors.range_search-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.range_search-111"><a href="#NearestNeighbors.range_search-111"><span class="linenos">111</span></a><span class="sd">        Finds all neighbors within a fixed `radius` for the ACTIVE batch.</span>
</span><span id="NearestNeighbors.range_search-112"><a href="#NearestNeighbors.range_search-112"><span class="linenos">112</span></a>
</span><span id="NearestNeighbors.range_search-113"><a href="#NearestNeighbors.range_search-113"><span class="linenos">113</span></a><span class="sd">        This returns a dense matrix representation suitable for vectorized force calculation.</span>
</span><span id="NearestNeighbors.range_search-114"><a href="#NearestNeighbors.range_search-114"><span class="linenos">114</span></a><span class="sd">        For active point $x_i$ and potential neighbor $y_j$:</span>
</span><span id="NearestNeighbors.range_search-115"><a href="#NearestNeighbors.range_search-115"><span class="linenos">115</span></a>
</span><span id="NearestNeighbors.range_search-116"><a href="#NearestNeighbors.range_search-116"><span class="linenos">116</span></a><span class="sd">        $ M_{ij} = \\begin{cases} ||x_i - y_j|| &amp; \\text{if } ||x_i - y_j|| &lt; R \\\\ 0 &amp; \\text{otherwise} \\end{cases} $</span>
</span><span id="NearestNeighbors.range_search-117"><a href="#NearestNeighbors.range_search-117"><span class="linenos">117</span></a>
</span><span id="NearestNeighbors.range_search-118"><a href="#NearestNeighbors.range_search-118"><span class="linenos">118</span></a><span class="sd">        Args:</span>
</span><span id="NearestNeighbors.range_search-119"><a href="#NearestNeighbors.range_search-119"><span class="linenos">119</span></a><span class="sd">            radius (float): The cutoff distance $R$.</span>
</span><span id="NearestNeighbors.range_search-120"><a href="#NearestNeighbors.range_search-120"><span class="linenos">120</span></a>
</span><span id="NearestNeighbors.range_search-121"><a href="#NearestNeighbors.range_search-121"><span class="linenos">121</span></a><span class="sd">        Returns:</span>
</span><span id="NearestNeighbors.range_search-122"><a href="#NearestNeighbors.range_search-122"><span class="linenos">122</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]:</span>
</span><span id="NearestNeighbors.range_search-123"><a href="#NearestNeighbors.range_search-123"><span class="linenos">123</span></a><span class="sd">                - **Distances**: Dense matrix $(M, N_{total})$. Zero where no neighbor exists.</span>
</span><span id="NearestNeighbors.range_search-124"><a href="#NearestNeighbors.range_search-124"><span class="linenos">124</span></a><span class="sd">                - **Mask**: Boolean matrix $(M, N_{total})$. True where $d &lt; R$.</span>
</span><span id="NearestNeighbors.range_search-125"><a href="#NearestNeighbors.range_search-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.range_search-126"><a href="#NearestNeighbors.range_search-126"><span class="linenos">126</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Finds all neighbors within a fixed <code>radius</code> for the ACTIVE batch.</p>

<p>This returns a dense matrix representation suitable for vectorized force calculation.
For active point $x_i$ and potential neighbor $y_j$:</p>

<p>$ M_{ij} = \begin{cases} ||x_i - y_j|| &amp; \text{if } ||x_i - y_j|| &lt; R \ 0 &amp; \text{otherwise} \end{cases} $</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>radius (float):</strong>  The cutoff distance $R$.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[np.ndarray, np.ndarray]:
      - <strong>Distances</strong>: Dense matrix $(M, N_{total})$. Zero where no neighbor exists.
      - *<em>Mask</em>*: Boolean matrix $(M, N_{total})$. True where $d &lt; R$.</p>
</blockquote>
</div>


                            </div>
                            <div id="NearestNeighbors.clear" class="classattr">
                                        <input id="NearestNeighbors.clear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abc.abstractmethod">@abc.abstractmethod</div>

        <span class="def">def</span>
        <span class="name">clear</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NearestNeighbors.clear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.clear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.clear-128"><a href="#NearestNeighbors.clear-128"><span class="linenos">128</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.clear-129"><a href="#NearestNeighbors.clear-129"><span class="linenos">129</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestNeighbors.clear-130"><a href="#NearestNeighbors.clear-130"><span class="linenos">130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.clear-131"><a href="#NearestNeighbors.clear-131"><span class="linenos">131</span></a><span class="sd">        Resets the internal state, clearing both static and active sets.</span>
</span><span id="NearestNeighbors.clear-132"><a href="#NearestNeighbors.clear-132"><span class="linenos">132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.clear-133"><a href="#NearestNeighbors.clear-133"><span class="linenos">133</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Resets the internal state, clearing both static and active sets.</p>
</div>


                            </div>
                            <div id="NearestNeighbors.total_count" class="classattr">
                                        <input id="NearestNeighbors.total_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">total_count</span><span class="annotation">: int</span>

                <label class="view-source-button" for="NearestNeighbors.total_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestNeighbors.total_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestNeighbors.total_count-135"><a href="#NearestNeighbors.total_count-135"><span class="linenos">135</span></a>    <span class="nd">@property</span>
</span><span id="NearestNeighbors.total_count-136"><a href="#NearestNeighbors.total_count-136"><span class="linenos">136</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="NearestNeighbors.total_count-137"><a href="#NearestNeighbors.total_count-137"><span class="linenos">137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="NearestNeighbors.total_count-138"><a href="#NearestNeighbors.total_count-138"><span class="linenos">138</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.total_count-139"><a href="#NearestNeighbors.total_count-139"><span class="linenos">139</span></a><span class="sd">        Returns the total number of points currently managed (Static + Active).</span>
</span><span id="NearestNeighbors.total_count-140"><a href="#NearestNeighbors.total_count-140"><span class="linenos">140</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NearestNeighbors.total_count-141"><a href="#NearestNeighbors.total_count-141"><span class="linenos">141</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Returns the total number of points currently managed (Static + Active).</p>
</div>


                            </div>
                </section>
                <section id="NumpyNN">
                            <input id="NumpyNN-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NumpyNN</span><wbr>(<span class="base"><a href="#NearestNeighbors">ess.NearestNeighbors</a></span>):

                <label class="view-source-button" for="NumpyNN-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN-144"><a href="#NumpyNN-144"><span class="linenos">144</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NumpyNN</span><span class="p">(</span><span class="n">NearestNeighbors</span><span class="p">):</span>
</span><span id="NumpyNN-145"><a href="#NumpyNN-145"><span class="linenos">145</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-146"><a href="#NumpyNN-146"><span class="linenos">146</span></a><span class="sd">    Pure NumPy implementation using vectorized broadcasting and caching.</span>
</span><span id="NumpyNN-147"><a href="#NumpyNN-147"><span class="linenos">147</span></a>
</span><span id="NumpyNN-148"><a href="#NumpyNN-148"><span class="linenos">148</span></a><span class="sd">    This class is optimized for small to medium datasets ($N &lt; 5000$) where the overhead</span>
</span><span id="NumpyNN-149"><a href="#NumpyNN-149"><span class="linenos">149</span></a><span class="sd">    of building tree structures or HNSW graphs outweighs the $O(N^2)$ cost of brute-force</span>
</span><span id="NumpyNN-150"><a href="#NumpyNN-150"><span class="linenos">150</span></a><span class="sd">    matrix operations.</span>
</span><span id="NumpyNN-151"><a href="#NumpyNN-151"><span class="linenos">151</span></a>
</span><span id="NumpyNN-152"><a href="#NumpyNN-152"><span class="linenos">152</span></a><span class="sd">    **Optimization Mechanism:**</span>
</span><span id="NumpyNN-153"><a href="#NumpyNN-153"><span class="linenos">153</span></a><span class="sd">    It utilizes the squared Euclidean distance expansion to leverage BLAS Level 3 optimizations</span>
</span><span id="NumpyNN-154"><a href="#NumpyNN-154"><span class="linenos">154</span></a><span class="sd">    (matrix multiplication):</span>
</span><span id="NumpyNN-155"><a href="#NumpyNN-155"><span class="linenos">155</span></a><span class="sd">    $ ||A - B||^2 = ||A||^2 + ||B||^2 - 2A \\cdot B^T $</span>
</span><span id="NumpyNN-156"><a href="#NumpyNN-156"><span class="linenos">156</span></a>
</span><span id="NumpyNN-157"><a href="#NumpyNN-157"><span class="linenos">157</span></a><span class="sd">    The term $||B||^2$ (static points squared norms) is cached and incrementally updated</span>
</span><span id="NumpyNN-158"><a href="#NumpyNN-158"><span class="linenos">158</span></a><span class="sd">    to avoid recomputation during iterative optimization steps.</span>
</span><span id="NumpyNN-159"><a href="#NumpyNN-159"><span class="linenos">159</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NumpyNN-160"><a href="#NumpyNN-160"><span class="linenos">160</span></a>
</span><span id="NumpyNN-161"><a href="#NumpyNN-161"><span class="linenos">161</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
</span><span id="NumpyNN-162"><a href="#NumpyNN-162"><span class="linenos">162</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</span><span id="NumpyNN-163"><a href="#NumpyNN-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-164"><a href="#NumpyNN-164"><span class="linenos">164</span></a>        <span class="c1"># Cache squared norms of static points to avoid re-computing in loop</span>
</span><span id="NumpyNN-165"><a href="#NumpyNN-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-166"><a href="#NumpyNN-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-167"><a href="#NumpyNN-167"><span class="linenos">167</span></a>
</span><span id="NumpyNN-168"><a href="#NumpyNN-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN-169"><a href="#NumpyNN-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-170"><a href="#NumpyNN-170"><span class="linenos">170</span></a><span class="sd">        Adds points to the static set and updates the squared-norm cache.</span>
</span><span id="NumpyNN-171"><a href="#NumpyNN-171"><span class="linenos">171</span></a>
</span><span id="NumpyNN-172"><a href="#NumpyNN-172"><span class="linenos">172</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN-173"><a href="#NumpyNN-173"><span class="linenos">173</span></a><span class="sd">            points (np.ndarray): Points to add $(N, D)$.</span>
</span><span id="NumpyNN-174"><a href="#NumpyNN-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-175"><a href="#NumpyNN-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
</span><span id="NumpyNN-176"><a href="#NumpyNN-176"><span class="linenos">176</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dim mismatch: </span><span class="si">{</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NumpyNN-177"><a href="#NumpyNN-177"><span class="linenos">177</span></a>
</span><span id="NumpyNN-178"><a href="#NumpyNN-178"><span class="linenos">178</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-179"><a href="#NumpyNN-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">,</span> <span class="n">points</span><span class="p">))</span>
</span><span id="NumpyNN-180"><a href="#NumpyNN-180"><span class="linenos">180</span></a>
</span><span id="NumpyNN-181"><a href="#NumpyNN-181"><span class="linenos">181</span></a>        <span class="c1"># Update cache: ||B||^2</span>
</span><span id="NumpyNN-182"><a href="#NumpyNN-182"><span class="linenos">182</span></a>        <span class="n">points_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">points</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NumpyNN-183"><a href="#NumpyNN-183"><span class="linenos">183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span><span class="p">,</span> <span class="n">points_sq</span><span class="p">))</span>
</span><span id="NumpyNN-184"><a href="#NumpyNN-184"><span class="linenos">184</span></a>
</span><span id="NumpyNN-185"><a href="#NumpyNN-185"><span class="linenos">185</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN-186"><a href="#NumpyNN-186"><span class="linenos">186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-187"><a href="#NumpyNN-187"><span class="linenos">187</span></a><span class="sd">        Sets the active batch buffer.</span>
</span><span id="NumpyNN-188"><a href="#NumpyNN-188"><span class="linenos">188</span></a>
</span><span id="NumpyNN-189"><a href="#NumpyNN-189"><span class="linenos">189</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN-190"><a href="#NumpyNN-190"><span class="linenos">190</span></a><span class="sd">            points (np.ndarray): Active points $(M, D)$.</span>
</span><span id="NumpyNN-191"><a href="#NumpyNN-191"><span class="linenos">191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-192"><a href="#NumpyNN-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
</span><span id="NumpyNN-193"><a href="#NumpyNN-193"><span class="linenos">193</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dim mismatch: </span><span class="si">{</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NumpyNN-194"><a href="#NumpyNN-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-195"><a href="#NumpyNN-195"><span class="linenos">195</span></a>
</span><span id="NumpyNN-196"><a href="#NumpyNN-196"><span class="linenos">196</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN-197"><a href="#NumpyNN-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-198"><a href="#NumpyNN-198"><span class="linenos">198</span></a><span class="sd">        Transfers active points to the static array and updates the norm cache.</span>
</span><span id="NumpyNN-199"><a href="#NumpyNN-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-200"><a href="#NumpyNN-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NumpyNN-201"><a href="#NumpyNN-201"><span class="linenos">201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">)</span>
</span><span id="NumpyNN-202"><a href="#NumpyNN-202"><span class="linenos">202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-203"><a href="#NumpyNN-203"><span class="linenos">203</span></a>
</span><span id="NumpyNN-204"><a href="#NumpyNN-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN-205"><a href="#NumpyNN-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-206"><a href="#NumpyNN-206"><span class="linenos">206</span></a><span class="sd">        Reallocates empty buffers for static and active sets.</span>
</span><span id="NumpyNN-207"><a href="#NumpyNN-207"><span class="linenos">207</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-208"><a href="#NumpyNN-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-209"><a href="#NumpyNN-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-210"><a href="#NumpyNN-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-211"><a href="#NumpyNN-211"><span class="linenos">211</span></a>
</span><span id="NumpyNN-212"><a href="#NumpyNN-212"><span class="linenos">212</span></a>    <span class="nd">@property</span>
</span><span id="NumpyNN-213"><a href="#NumpyNN-213"><span class="linenos">213</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="NumpyNN-214"><a href="#NumpyNN-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-215"><a href="#NumpyNN-215"><span class="linenos">215</span></a><span class="sd">        The sum of rows in the static and active buffers.</span>
</span><span id="NumpyNN-216"><a href="#NumpyNN-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-217"><a href="#NumpyNN-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NumpyNN-218"><a href="#NumpyNN-218"><span class="linenos">218</span></a>
</span><span id="NumpyNN-219"><a href="#NumpyNN-219"><span class="linenos">219</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sq_dist_matrix_cached</span><span class="p">(</span>
</span><span id="NumpyNN-220"><a href="#NumpyNN-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">B</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">B_sq</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
</span><span id="NumpyNN-221"><a href="#NumpyNN-221"><span class="linenos">221</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="NumpyNN-222"><a href="#NumpyNN-222"><span class="linenos">222</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes ||A - B||^2 using cached ||B||^2.&quot;&quot;&quot;</span>
</span><span id="NumpyNN-223"><a href="#NumpyNN-223"><span class="linenos">223</span></a>        <span class="n">A_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NumpyNN-224"><a href="#NumpyNN-224"><span class="linenos">224</span></a>        <span class="c1"># A_sq + B_sq.T - 2AB</span>
</span><span id="NumpyNN-225"><a href="#NumpyNN-225"><span class="linenos">225</span></a>        <span class="k">return</span> <span class="n">A_sq</span> <span class="o">+</span> <span class="n">B_sq</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="NumpyNN-226"><a href="#NumpyNN-226"><span class="linenos">226</span></a>
</span><span id="NumpyNN-227"><a href="#NumpyNN-227"><span class="linenos">227</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sq_dist_matrix_uncached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">B</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="NumpyNN-228"><a href="#NumpyNN-228"><span class="linenos">228</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Standard ||A - B||^2 computation.&quot;&quot;&quot;</span>
</span><span id="NumpyNN-229"><a href="#NumpyNN-229"><span class="linenos">229</span></a>        <span class="n">A_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NumpyNN-230"><a href="#NumpyNN-230"><span class="linenos">230</span></a>        <span class="n">B_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NumpyNN-231"><a href="#NumpyNN-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="n">A_sq</span> <span class="o">+</span> <span class="n">B_sq</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="NumpyNN-232"><a href="#NumpyNN-232"><span class="linenos">232</span></a>
</span><span id="NumpyNN-233"><a href="#NumpyNN-233"><span class="linenos">233</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_full_sq_dists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
</span><span id="NumpyNN-234"><a href="#NumpyNN-234"><span class="linenos">234</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes merged squared distances from Active to (Static + Active).&quot;&quot;&quot;</span>
</span><span id="NumpyNN-235"><a href="#NumpyNN-235"><span class="linenos">235</span></a>        <span class="n">n_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NumpyNN-236"><a href="#NumpyNN-236"><span class="linenos">236</span></a>        <span class="n">n_static</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NumpyNN-237"><a href="#NumpyNN-237"><span class="linenos">237</span></a>
</span><span id="NumpyNN-238"><a href="#NumpyNN-238"><span class="linenos">238</span></a>        <span class="c1"># 1. Active vs Static (Using Cache)</span>
</span><span id="NumpyNN-239"><a href="#NumpyNN-239"><span class="linenos">239</span></a>        <span class="k">if</span> <span class="n">n_static</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NumpyNN-240"><a href="#NumpyNN-240"><span class="linenos">240</span></a>            <span class="n">dists_s_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sq_dist_matrix_cached</span><span class="p">(</span>
</span><span id="NumpyNN-241"><a href="#NumpyNN-241"><span class="linenos">241</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span>
</span><span id="NumpyNN-242"><a href="#NumpyNN-242"><span class="linenos">242</span></a>            <span class="p">)</span>
</span><span id="NumpyNN-243"><a href="#NumpyNN-243"><span class="linenos">243</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="NumpyNN-244"><a href="#NumpyNN-244"><span class="linenos">244</span></a>            <span class="n">dists_s_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_active</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN-245"><a href="#NumpyNN-245"><span class="linenos">245</span></a>
</span><span id="NumpyNN-246"><a href="#NumpyNN-246"><span class="linenos">246</span></a>        <span class="c1"># 2. Active vs Active (Uncached)</span>
</span><span id="NumpyNN-247"><a href="#NumpyNN-247"><span class="linenos">247</span></a>        <span class="n">dists_a_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sq_dist_matrix_uncached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">)</span>
</span><span id="NumpyNN-248"><a href="#NumpyNN-248"><span class="linenos">248</span></a>
</span><span id="NumpyNN-249"><a href="#NumpyNN-249"><span class="linenos">249</span></a>        <span class="c1"># 3. Merge</span>
</span><span id="NumpyNN-250"><a href="#NumpyNN-250"><span class="linenos">250</span></a>        <span class="n">full_dists_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dists_s_sq</span><span class="p">,</span> <span class="n">dists_a_sq</span><span class="p">))</span>
</span><span id="NumpyNN-251"><a href="#NumpyNN-251"><span class="linenos">251</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">full_dists_sq</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="NumpyNN-252"><a href="#NumpyNN-252"><span class="linenos">252</span></a>
</span><span id="NumpyNN-253"><a href="#NumpyNN-253"><span class="linenos">253</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NumpyNN-254"><a href="#NumpyNN-254"><span class="linenos">254</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-255"><a href="#NumpyNN-255"><span class="linenos">255</span></a><span class="sd">        Performs exact k-NN search using dense matrix operations.</span>
</span><span id="NumpyNN-256"><a href="#NumpyNN-256"><span class="linenos">256</span></a>
</span><span id="NumpyNN-257"><a href="#NumpyNN-257"><span class="linenos">257</span></a><span class="sd">        **Algorithm:**</span>
</span><span id="NumpyNN-258"><a href="#NumpyNN-258"><span class="linenos">258</span></a><span class="sd">        1. Compute full distance matrix $D^2$ using cached norms ($M \\times N$).</span>
</span><span id="NumpyNN-259"><a href="#NumpyNN-259"><span class="linenos">259</span></a><span class="sd">        2. Use `np.argpartition` (Introselect) to find the top-$k$ elements in $O(N)$ time.</span>
</span><span id="NumpyNN-260"><a href="#NumpyNN-260"><span class="linenos">260</span></a><span class="sd">        3. Perform a small sort on the $k$ elements to return them in order.</span>
</span><span id="NumpyNN-261"><a href="#NumpyNN-261"><span class="linenos">261</span></a>
</span><span id="NumpyNN-262"><a href="#NumpyNN-262"><span class="linenos">262</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN-263"><a href="#NumpyNN-263"><span class="linenos">263</span></a><span class="sd">            k (int): Number of neighbors.</span>
</span><span id="NumpyNN-264"><a href="#NumpyNN-264"><span class="linenos">264</span></a>
</span><span id="NumpyNN-265"><a href="#NumpyNN-265"><span class="linenos">265</span></a><span class="sd">        Returns:</span>
</span><span id="NumpyNN-266"><a href="#NumpyNN-266"><span class="linenos">266</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: Indices and distances.</span>
</span><span id="NumpyNN-267"><a href="#NumpyNN-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-268"><a href="#NumpyNN-268"><span class="linenos">268</span></a>        <span class="n">full_dists_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_full_sq_dists</span><span class="p">()</span>
</span><span id="NumpyNN-269"><a href="#NumpyNN-269"><span class="linenos">269</span></a>        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">full_dists_sq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NumpyNN-270"><a href="#NumpyNN-270"><span class="linenos">270</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">full_dists_sq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="NumpyNN-271"><a href="#NumpyNN-271"><span class="linenos">271</span></a>
</span><span id="NumpyNN-272"><a href="#NumpyNN-272"><span class="linenos">272</span></a>        <span class="c1"># 1. Argpartition to find top-k (unsorted)</span>
</span><span id="NumpyNN-273"><a href="#NumpyNN-273"><span class="linenos">273</span></a>        <span class="c1"># Time: O(N * Total_Count)</span>
</span><span id="NumpyNN-274"><a href="#NumpyNN-274"><span class="linenos">274</span></a>        <span class="n">unsorted_top_k_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">full_dists_sq</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span>
</span><span id="NumpyNN-275"><a href="#NumpyNN-275"><span class="linenos">275</span></a>
</span><span id="NumpyNN-276"><a href="#NumpyNN-276"><span class="linenos">276</span></a>        <span class="c1"># 2. Extract values (Optimized indexing)</span>
</span><span id="NumpyNN-277"><a href="#NumpyNN-277"><span class="linenos">277</span></a>        <span class="c1"># Create row indices: [[0,0,..], [1,1,..], ...]</span>
</span><span id="NumpyNN-278"><a href="#NumpyNN-278"><span class="linenos">278</span></a>        <span class="n">row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="NumpyNN-279"><a href="#NumpyNN-279"><span class="linenos">279</span></a>
</span><span id="NumpyNN-280"><a href="#NumpyNN-280"><span class="linenos">280</span></a>        <span class="c1"># Fancy indexing is often faster than take_along_axis for simple 2D arrays</span>
</span><span id="NumpyNN-281"><a href="#NumpyNN-281"><span class="linenos">281</span></a>        <span class="n">top_dists_sq</span> <span class="o">=</span> <span class="n">full_dists_sq</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">unsorted_top_k_idx</span><span class="p">]</span>
</span><span id="NumpyNN-282"><a href="#NumpyNN-282"><span class="linenos">282</span></a>
</span><span id="NumpyNN-283"><a href="#NumpyNN-283"><span class="linenos">283</span></a>        <span class="c1"># 3. Sort the top-k (Small sort: k * log k)</span>
</span><span id="NumpyNN-284"><a href="#NumpyNN-284"><span class="linenos">284</span></a>        <span class="c1"># We only sort the small k window, not the full array</span>
</span><span id="NumpyNN-285"><a href="#NumpyNN-285"><span class="linenos">285</span></a>        <span class="n">local_sort_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">top_dists_sq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN-286"><a href="#NumpyNN-286"><span class="linenos">286</span></a>
</span><span id="NumpyNN-287"><a href="#NumpyNN-287"><span class="linenos">287</span></a>        <span class="c1"># 4. Final Gather</span>
</span><span id="NumpyNN-288"><a href="#NumpyNN-288"><span class="linenos">288</span></a>        <span class="n">final_indices</span> <span class="o">=</span> <span class="n">unsorted_top_k_idx</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">local_sort_order</span><span class="p">]</span>
</span><span id="NumpyNN-289"><a href="#NumpyNN-289"><span class="linenos">289</span></a>        <span class="n">final_dists_sq</span> <span class="o">=</span> <span class="n">top_dists_sq</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">local_sort_order</span><span class="p">]</span>
</span><span id="NumpyNN-290"><a href="#NumpyNN-290"><span class="linenos">290</span></a>
</span><span id="NumpyNN-291"><a href="#NumpyNN-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="n">final_indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">final_dists_sq</span><span class="p">)</span>
</span><span id="NumpyNN-292"><a href="#NumpyNN-292"><span class="linenos">292</span></a>
</span><span id="NumpyNN-293"><a href="#NumpyNN-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_static</span><span class="p">(</span>
</span><span id="NumpyNN-294"><a href="#NumpyNN-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">query_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="NumpyNN-295"><a href="#NumpyNN-295"><span class="linenos">295</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NumpyNN-296"><a href="#NumpyNN-296"><span class="linenos">296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-297"><a href="#NumpyNN-297"><span class="linenos">297</span></a><span class="sd">        Queries the static set using cached squared norms.</span>
</span><span id="NumpyNN-298"><a href="#NumpyNN-298"><span class="linenos">298</span></a>
</span><span id="NumpyNN-299"><a href="#NumpyNN-299"><span class="linenos">299</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN-300"><a href="#NumpyNN-300"><span class="linenos">300</span></a><span class="sd">            query_points (np.ndarray): Query inputs.</span>
</span><span id="NumpyNN-301"><a href="#NumpyNN-301"><span class="linenos">301</span></a><span class="sd">            k (int): Neighbors count.</span>
</span><span id="NumpyNN-302"><a href="#NumpyNN-302"><span class="linenos">302</span></a>
</span><span id="NumpyNN-303"><a href="#NumpyNN-303"><span class="linenos">303</span></a><span class="sd">        Returns:</span>
</span><span id="NumpyNN-304"><a href="#NumpyNN-304"><span class="linenos">304</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: Indices and distances.</span>
</span><span id="NumpyNN-305"><a href="#NumpyNN-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-306"><a href="#NumpyNN-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NumpyNN-307"><a href="#NumpyNN-307"><span class="linenos">307</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="NumpyNN-308"><a href="#NumpyNN-308"><span class="linenos">308</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">query_points</span><span class="p">),</span> <span class="n">k</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
</span><span id="NumpyNN-309"><a href="#NumpyNN-309"><span class="linenos">309</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">query_points</span><span class="p">),</span> <span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
</span><span id="NumpyNN-310"><a href="#NumpyNN-310"><span class="linenos">310</span></a>            <span class="p">)</span>
</span><span id="NumpyNN-311"><a href="#NumpyNN-311"><span class="linenos">311</span></a>
</span><span id="NumpyNN-312"><a href="#NumpyNN-312"><span class="linenos">312</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="NumpyNN-313"><a href="#NumpyNN-313"><span class="linenos">313</span></a>        <span class="c1"># Use cached static norms</span>
</span><span id="NumpyNN-314"><a href="#NumpyNN-314"><span class="linenos">314</span></a>        <span class="n">dist_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sq_dist_matrix_cached</span><span class="p">(</span>
</span><span id="NumpyNN-315"><a href="#NumpyNN-315"><span class="linenos">315</span></a>            <span class="n">query_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span>
</span><span id="NumpyNN-316"><a href="#NumpyNN-316"><span class="linenos">316</span></a>        <span class="p">)</span>
</span><span id="NumpyNN-317"><a href="#NumpyNN-317"><span class="linenos">317</span></a>        <span class="n">dist_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="NumpyNN-318"><a href="#NumpyNN-318"><span class="linenos">318</span></a>
</span><span id="NumpyNN-319"><a href="#NumpyNN-319"><span class="linenos">319</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="NumpyNN-320"><a href="#NumpyNN-320"><span class="linenos">320</span></a>            <span class="n">final_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="NumpyNN-321"><a href="#NumpyNN-321"><span class="linenos">321</span></a>            <span class="n">final_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">final_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="NumpyNN-322"><a href="#NumpyNN-322"><span class="linenos">322</span></a>            <span class="k">return</span> <span class="n">final_idx</span><span class="p">,</span> <span class="n">final_dists</span>
</span><span id="NumpyNN-323"><a href="#NumpyNN-323"><span class="linenos">323</span></a>
</span><span id="NumpyNN-324"><a href="#NumpyNN-324"><span class="linenos">324</span></a>        <span class="n">part_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span>
</span><span id="NumpyNN-325"><a href="#NumpyNN-325"><span class="linenos">325</span></a>        <span class="n">top_dists_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">part_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN-326"><a href="#NumpyNN-326"><span class="linenos">326</span></a>
</span><span id="NumpyNN-327"><a href="#NumpyNN-327"><span class="linenos">327</span></a>        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">top_dists_sq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN-328"><a href="#NumpyNN-328"><span class="linenos">328</span></a>        <span class="n">final_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">top_dists_sq</span><span class="p">,</span> <span class="n">sort_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="NumpyNN-329"><a href="#NumpyNN-329"><span class="linenos">329</span></a>        <span class="n">final_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">part_idx</span><span class="p">,</span> <span class="n">sort_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN-330"><a href="#NumpyNN-330"><span class="linenos">330</span></a>
</span><span id="NumpyNN-331"><a href="#NumpyNN-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="n">final_idx</span><span class="p">,</span> <span class="n">final_dists</span>
</span><span id="NumpyNN-332"><a href="#NumpyNN-332"><span class="linenos">332</span></a>
</span><span id="NumpyNN-333"><a href="#NumpyNN-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">range_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NumpyNN-334"><a href="#NumpyNN-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN-335"><a href="#NumpyNN-335"><span class="linenos">335</span></a><span class="sd">        Computes the full distance matrix and applies a boolean mask.</span>
</span><span id="NumpyNN-336"><a href="#NumpyNN-336"><span class="linenos">336</span></a>
</span><span id="NumpyNN-337"><a href="#NumpyNN-337"><span class="linenos">337</span></a><span class="sd">        Because `NumpyNN` is designed for dense regimes, this returns the complete</span>
</span><span id="NumpyNN-338"><a href="#NumpyNN-338"><span class="linenos">338</span></a><span class="sd">        $M \\times N$ distance matrix and a boolean mask indicating valid neighbors ($d &lt; R$).</span>
</span><span id="NumpyNN-339"><a href="#NumpyNN-339"><span class="linenos">339</span></a><span class="sd">        This avoids the overhead of sparse formatting when connectivity is high.</span>
</span><span id="NumpyNN-340"><a href="#NumpyNN-340"><span class="linenos">340</span></a>
</span><span id="NumpyNN-341"><a href="#NumpyNN-341"><span class="linenos">341</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN-342"><a href="#NumpyNN-342"><span class="linenos">342</span></a><span class="sd">            radius (float): Cutoff radius.</span>
</span><span id="NumpyNN-343"><a href="#NumpyNN-343"><span class="linenos">343</span></a>
</span><span id="NumpyNN-344"><a href="#NumpyNN-344"><span class="linenos">344</span></a><span class="sd">        Returns:</span>
</span><span id="NumpyNN-345"><a href="#NumpyNN-345"><span class="linenos">345</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: (Distances, Mask).</span>
</span><span id="NumpyNN-346"><a href="#NumpyNN-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN-347"><a href="#NumpyNN-347"><span class="linenos">347</span></a>        <span class="c1"># 1. Compute Full Matrix</span>
</span><span id="NumpyNN-348"><a href="#NumpyNN-348"><span class="linenos">348</span></a>        <span class="n">full_dists_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_full_sq_dists</span><span class="p">()</span>
</span><span id="NumpyNN-349"><a href="#NumpyNN-349"><span class="linenos">349</span></a>
</span><span id="NumpyNN-350"><a href="#NumpyNN-350"><span class="linenos">350</span></a>        <span class="c1"># 2. Compute Mask</span>
</span><span id="NumpyNN-351"><a href="#NumpyNN-351"><span class="linenos">351</span></a>        <span class="n">radius_sq</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">radius</span>
</span><span id="NumpyNN-352"><a href="#NumpyNN-352"><span class="linenos">352</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">full_dists_sq</span> <span class="o">&lt;</span> <span class="n">radius_sq</span>
</span><span id="NumpyNN-353"><a href="#NumpyNN-353"><span class="linenos">353</span></a>
</span><span id="NumpyNN-354"><a href="#NumpyNN-354"><span class="linenos">354</span></a>        <span class="c1"># 3. Return (Dists, Mask) - No &#39;nonzero&#39; or sorting required</span>
</span><span id="NumpyNN-355"><a href="#NumpyNN-355"><span class="linenos">355</span></a>        <span class="c1"># Return sqrt distances for metric compatibility</span>
</span><span id="NumpyNN-356"><a href="#NumpyNN-356"><span class="linenos">356</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">full_dists_sq</span><span class="p">),</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Pure NumPy implementation using vectorized broadcasting and caching.</p>

<p>This class is optimized for small to medium datasets ($N &lt; 5000$) where the overhead
of building tree structures or HNSW graphs outweighs the $O(N^2)$ cost of brute-force
matrix operations.</p>

<p><strong>Optimization Mechanism:</strong>
It utilizes the squared Euclidean distance expansion to leverage BLAS Level 3 optimizations
(matrix multiplication):
$ ||A - B||^2 = ||A||^2 + ||B||^2 - 2A \cdot B^T $</p>

<p>The term $||B||^2$ (static points squared norms) is cached and incrementally updated
to avoid recomputation during iterative optimization steps.</p>
</div>


                            <div id="NumpyNN.__init__" class="classattr">
                                        <input id="NumpyNN.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NumpyNN</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span></span>)</span>

                <label class="view-source-button" for="NumpyNN.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.__init__-161"><a href="#NumpyNN.__init__-161"><span class="linenos">161</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
</span><span id="NumpyNN.__init__-162"><a href="#NumpyNN.__init__-162"><span class="linenos">162</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</span><span id="NumpyNN.__init__-163"><a href="#NumpyNN.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN.__init__-164"><a href="#NumpyNN.__init__-164"><span class="linenos">164</span></a>        <span class="c1"># Cache squared norms of static points to avoid re-computing in loop</span>
</span><span id="NumpyNN.__init__-165"><a href="#NumpyNN.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN.__init__-166"><a href="#NumpyNN.__init__-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="NumpyNN.add_static" class="classattr">
                                        <input id="NumpyNN.add_static-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_static</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">points</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.add_static-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.add_static"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.add_static-168"><a href="#NumpyNN.add_static-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN.add_static-169"><a href="#NumpyNN.add_static-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.add_static-170"><a href="#NumpyNN.add_static-170"><span class="linenos">170</span></a><span class="sd">        Adds points to the static set and updates the squared-norm cache.</span>
</span><span id="NumpyNN.add_static-171"><a href="#NumpyNN.add_static-171"><span class="linenos">171</span></a>
</span><span id="NumpyNN.add_static-172"><a href="#NumpyNN.add_static-172"><span class="linenos">172</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN.add_static-173"><a href="#NumpyNN.add_static-173"><span class="linenos">173</span></a><span class="sd">            points (np.ndarray): Points to add $(N, D)$.</span>
</span><span id="NumpyNN.add_static-174"><a href="#NumpyNN.add_static-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.add_static-175"><a href="#NumpyNN.add_static-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
</span><span id="NumpyNN.add_static-176"><a href="#NumpyNN.add_static-176"><span class="linenos">176</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dim mismatch: </span><span class="si">{</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NumpyNN.add_static-177"><a href="#NumpyNN.add_static-177"><span class="linenos">177</span></a>
</span><span id="NumpyNN.add_static-178"><a href="#NumpyNN.add_static-178"><span class="linenos">178</span></a>        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN.add_static-179"><a href="#NumpyNN.add_static-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">,</span> <span class="n">points</span><span class="p">))</span>
</span><span id="NumpyNN.add_static-180"><a href="#NumpyNN.add_static-180"><span class="linenos">180</span></a>
</span><span id="NumpyNN.add_static-181"><a href="#NumpyNN.add_static-181"><span class="linenos">181</span></a>        <span class="c1"># Update cache: ||B||^2</span>
</span><span id="NumpyNN.add_static-182"><a href="#NumpyNN.add_static-182"><span class="linenos">182</span></a>        <span class="n">points_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">points</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="NumpyNN.add_static-183"><a href="#NumpyNN.add_static-183"><span class="linenos">183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span><span class="p">,</span> <span class="n">points_sq</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Adds points to the static set and updates the squared-norm cache.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>points (np.ndarray):</strong>  Points to add $(N, D)$.</li>
</ul>
</div>


                            </div>
                            <div id="NumpyNN.set_active" class="classattr">
                                        <input id="NumpyNN.set_active-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_active</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">points</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.set_active-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.set_active"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.set_active-185"><a href="#NumpyNN.set_active-185"><span class="linenos">185</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN.set_active-186"><a href="#NumpyNN.set_active-186"><span class="linenos">186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.set_active-187"><a href="#NumpyNN.set_active-187"><span class="linenos">187</span></a><span class="sd">        Sets the active batch buffer.</span>
</span><span id="NumpyNN.set_active-188"><a href="#NumpyNN.set_active-188"><span class="linenos">188</span></a>
</span><span id="NumpyNN.set_active-189"><a href="#NumpyNN.set_active-189"><span class="linenos">189</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN.set_active-190"><a href="#NumpyNN.set_active-190"><span class="linenos">190</span></a><span class="sd">            points (np.ndarray): Active points $(M, D)$.</span>
</span><span id="NumpyNN.set_active-191"><a href="#NumpyNN.set_active-191"><span class="linenos">191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.set_active-192"><a href="#NumpyNN.set_active-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">:</span>
</span><span id="NumpyNN.set_active-193"><a href="#NumpyNN.set_active-193"><span class="linenos">193</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dim mismatch: </span><span class="si">{</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NumpyNN.set_active-194"><a href="#NumpyNN.set_active-194"><span class="linenos">194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sets the active batch buffer.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>points (np.ndarray):</strong>  Active points $(M, D)$.</li>
</ul>
</div>


                            </div>
                            <div id="NumpyNN.consolidate" class="classattr">
                                        <input id="NumpyNN.consolidate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">consolidate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.consolidate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.consolidate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.consolidate-196"><a href="#NumpyNN.consolidate-196"><span class="linenos">196</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">consolidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN.consolidate-197"><a href="#NumpyNN.consolidate-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.consolidate-198"><a href="#NumpyNN.consolidate-198"><span class="linenos">198</span></a><span class="sd">        Transfers active points to the static array and updates the norm cache.</span>
</span><span id="NumpyNN.consolidate-199"><a href="#NumpyNN.consolidate-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.consolidate-200"><a href="#NumpyNN.consolidate-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NumpyNN.consolidate-201"><a href="#NumpyNN.consolidate-201"><span class="linenos">201</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_static</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="p">)</span>
</span><span id="NumpyNN.consolidate-202"><a href="#NumpyNN.consolidate-202"><span class="linenos">202</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Transfers active points to the static array and updates the norm cache.</p>
</div>


                            </div>
                            <div id="NumpyNN.clear" class="classattr">
                                        <input id="NumpyNN.clear-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.clear-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.clear"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.clear-204"><a href="#NumpyNN.clear-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NumpyNN.clear-205"><a href="#NumpyNN.clear-205"><span class="linenos">205</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.clear-206"><a href="#NumpyNN.clear-206"><span class="linenos">206</span></a><span class="sd">        Reallocates empty buffers for static and active sets.</span>
</span><span id="NumpyNN.clear-207"><a href="#NumpyNN.clear-207"><span class="linenos">207</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.clear-208"><a href="#NumpyNN.clear-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN.clear-209"><a href="#NumpyNN.clear-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="NumpyNN.clear-210"><a href="#NumpyNN.clear-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reallocates empty buffers for static and active sets.</p>
</div>


                            </div>
                            <div id="NumpyNN.total_count" class="classattr">
                                        <input id="NumpyNN.total_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">total_count</span><span class="annotation">: int</span>

                <label class="view-source-button" for="NumpyNN.total_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.total_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.total_count-212"><a href="#NumpyNN.total_count-212"><span class="linenos">212</span></a>    <span class="nd">@property</span>
</span><span id="NumpyNN.total_count-213"><a href="#NumpyNN.total_count-213"><span class="linenos">213</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="NumpyNN.total_count-214"><a href="#NumpyNN.total_count-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.total_count-215"><a href="#NumpyNN.total_count-215"><span class="linenos">215</span></a><span class="sd">        The sum of rows in the static and active buffers.</span>
</span><span id="NumpyNN.total_count-216"><a href="#NumpyNN.total_count-216"><span class="linenos">216</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.total_count-217"><a href="#NumpyNN.total_count-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>The sum of rows in the static and active buffers.</p>
</div>


                            </div>
                            <div id="NumpyNN.query_nn" class="classattr">
                                        <input id="NumpyNN.query_nn-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">query_nn</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">k</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.query_nn-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.query_nn"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.query_nn-253"><a href="#NumpyNN.query_nn-253"><span class="linenos">253</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NumpyNN.query_nn-254"><a href="#NumpyNN.query_nn-254"><span class="linenos">254</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.query_nn-255"><a href="#NumpyNN.query_nn-255"><span class="linenos">255</span></a><span class="sd">        Performs exact k-NN search using dense matrix operations.</span>
</span><span id="NumpyNN.query_nn-256"><a href="#NumpyNN.query_nn-256"><span class="linenos">256</span></a>
</span><span id="NumpyNN.query_nn-257"><a href="#NumpyNN.query_nn-257"><span class="linenos">257</span></a><span class="sd">        **Algorithm:**</span>
</span><span id="NumpyNN.query_nn-258"><a href="#NumpyNN.query_nn-258"><span class="linenos">258</span></a><span class="sd">        1. Compute full distance matrix $D^2$ using cached norms ($M \\times N$).</span>
</span><span id="NumpyNN.query_nn-259"><a href="#NumpyNN.query_nn-259"><span class="linenos">259</span></a><span class="sd">        2. Use `np.argpartition` (Introselect) to find the top-$k$ elements in $O(N)$ time.</span>
</span><span id="NumpyNN.query_nn-260"><a href="#NumpyNN.query_nn-260"><span class="linenos">260</span></a><span class="sd">        3. Perform a small sort on the $k$ elements to return them in order.</span>
</span><span id="NumpyNN.query_nn-261"><a href="#NumpyNN.query_nn-261"><span class="linenos">261</span></a>
</span><span id="NumpyNN.query_nn-262"><a href="#NumpyNN.query_nn-262"><span class="linenos">262</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN.query_nn-263"><a href="#NumpyNN.query_nn-263"><span class="linenos">263</span></a><span class="sd">            k (int): Number of neighbors.</span>
</span><span id="NumpyNN.query_nn-264"><a href="#NumpyNN.query_nn-264"><span class="linenos">264</span></a>
</span><span id="NumpyNN.query_nn-265"><a href="#NumpyNN.query_nn-265"><span class="linenos">265</span></a><span class="sd">        Returns:</span>
</span><span id="NumpyNN.query_nn-266"><a href="#NumpyNN.query_nn-266"><span class="linenos">266</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: Indices and distances.</span>
</span><span id="NumpyNN.query_nn-267"><a href="#NumpyNN.query_nn-267"><span class="linenos">267</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.query_nn-268"><a href="#NumpyNN.query_nn-268"><span class="linenos">268</span></a>        <span class="n">full_dists_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_full_sq_dists</span><span class="p">()</span>
</span><span id="NumpyNN.query_nn-269"><a href="#NumpyNN.query_nn-269"><span class="linenos">269</span></a>        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">full_dists_sq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="NumpyNN.query_nn-270"><a href="#NumpyNN.query_nn-270"><span class="linenos">270</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">full_dists_sq</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="NumpyNN.query_nn-271"><a href="#NumpyNN.query_nn-271"><span class="linenos">271</span></a>
</span><span id="NumpyNN.query_nn-272"><a href="#NumpyNN.query_nn-272"><span class="linenos">272</span></a>        <span class="c1"># 1. Argpartition to find top-k (unsorted)</span>
</span><span id="NumpyNN.query_nn-273"><a href="#NumpyNN.query_nn-273"><span class="linenos">273</span></a>        <span class="c1"># Time: O(N * Total_Count)</span>
</span><span id="NumpyNN.query_nn-274"><a href="#NumpyNN.query_nn-274"><span class="linenos">274</span></a>        <span class="n">unsorted_top_k_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">full_dists_sq</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span>
</span><span id="NumpyNN.query_nn-275"><a href="#NumpyNN.query_nn-275"><span class="linenos">275</span></a>
</span><span id="NumpyNN.query_nn-276"><a href="#NumpyNN.query_nn-276"><span class="linenos">276</span></a>        <span class="c1"># 2. Extract values (Optimized indexing)</span>
</span><span id="NumpyNN.query_nn-277"><a href="#NumpyNN.query_nn-277"><span class="linenos">277</span></a>        <span class="c1"># Create row indices: [[0,0,..], [1,1,..], ...]</span>
</span><span id="NumpyNN.query_nn-278"><a href="#NumpyNN.query_nn-278"><span class="linenos">278</span></a>        <span class="n">row_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="NumpyNN.query_nn-279"><a href="#NumpyNN.query_nn-279"><span class="linenos">279</span></a>
</span><span id="NumpyNN.query_nn-280"><a href="#NumpyNN.query_nn-280"><span class="linenos">280</span></a>        <span class="c1"># Fancy indexing is often faster than take_along_axis for simple 2D arrays</span>
</span><span id="NumpyNN.query_nn-281"><a href="#NumpyNN.query_nn-281"><span class="linenos">281</span></a>        <span class="n">top_dists_sq</span> <span class="o">=</span> <span class="n">full_dists_sq</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">unsorted_top_k_idx</span><span class="p">]</span>
</span><span id="NumpyNN.query_nn-282"><a href="#NumpyNN.query_nn-282"><span class="linenos">282</span></a>
</span><span id="NumpyNN.query_nn-283"><a href="#NumpyNN.query_nn-283"><span class="linenos">283</span></a>        <span class="c1"># 3. Sort the top-k (Small sort: k * log k)</span>
</span><span id="NumpyNN.query_nn-284"><a href="#NumpyNN.query_nn-284"><span class="linenos">284</span></a>        <span class="c1"># We only sort the small k window, not the full array</span>
</span><span id="NumpyNN.query_nn-285"><a href="#NumpyNN.query_nn-285"><span class="linenos">285</span></a>        <span class="n">local_sort_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">top_dists_sq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN.query_nn-286"><a href="#NumpyNN.query_nn-286"><span class="linenos">286</span></a>
</span><span id="NumpyNN.query_nn-287"><a href="#NumpyNN.query_nn-287"><span class="linenos">287</span></a>        <span class="c1"># 4. Final Gather</span>
</span><span id="NumpyNN.query_nn-288"><a href="#NumpyNN.query_nn-288"><span class="linenos">288</span></a>        <span class="n">final_indices</span> <span class="o">=</span> <span class="n">unsorted_top_k_idx</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">local_sort_order</span><span class="p">]</span>
</span><span id="NumpyNN.query_nn-289"><a href="#NumpyNN.query_nn-289"><span class="linenos">289</span></a>        <span class="n">final_dists_sq</span> <span class="o">=</span> <span class="n">top_dists_sq</span><span class="p">[</span><span class="n">row_indices</span><span class="p">,</span> <span class="n">local_sort_order</span><span class="p">]</span>
</span><span id="NumpyNN.query_nn-290"><a href="#NumpyNN.query_nn-290"><span class="linenos">290</span></a>
</span><span id="NumpyNN.query_nn-291"><a href="#NumpyNN.query_nn-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="n">final_indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">final_dists_sq</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs exact k-NN search using dense matrix operations.</p>

<p><strong>Algorithm:</strong></p>

<ol>
<li>Compute full distance matrix $D^2$ using cached norms ($M \times N$).</li>
<li>Use <code>np.argpartition</code> (Introselect) to find the top-$k$ elements in $O(N)$ time.</li>
<li>Perform a small sort on the $k$ elements to return them in order.</li>
</ol>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>k (int):</strong>  Number of neighbors.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[np.ndarray, np.ndarray]: Indices and distances.</p>
</blockquote>
</div>


                            </div>
                            <div id="NumpyNN.query_static" class="classattr">
                                        <input id="NumpyNN.query_static-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">query_static</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query_points</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">k</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.query_static-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.query_static"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.query_static-293"><a href="#NumpyNN.query_static-293"><span class="linenos">293</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_static</span><span class="p">(</span>
</span><span id="NumpyNN.query_static-294"><a href="#NumpyNN.query_static-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">query_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="NumpyNN.query_static-295"><a href="#NumpyNN.query_static-295"><span class="linenos">295</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NumpyNN.query_static-296"><a href="#NumpyNN.query_static-296"><span class="linenos">296</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.query_static-297"><a href="#NumpyNN.query_static-297"><span class="linenos">297</span></a><span class="sd">        Queries the static set using cached squared norms.</span>
</span><span id="NumpyNN.query_static-298"><a href="#NumpyNN.query_static-298"><span class="linenos">298</span></a>
</span><span id="NumpyNN.query_static-299"><a href="#NumpyNN.query_static-299"><span class="linenos">299</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN.query_static-300"><a href="#NumpyNN.query_static-300"><span class="linenos">300</span></a><span class="sd">            query_points (np.ndarray): Query inputs.</span>
</span><span id="NumpyNN.query_static-301"><a href="#NumpyNN.query_static-301"><span class="linenos">301</span></a><span class="sd">            k (int): Neighbors count.</span>
</span><span id="NumpyNN.query_static-302"><a href="#NumpyNN.query_static-302"><span class="linenos">302</span></a>
</span><span id="NumpyNN.query_static-303"><a href="#NumpyNN.query_static-303"><span class="linenos">303</span></a><span class="sd">        Returns:</span>
</span><span id="NumpyNN.query_static-304"><a href="#NumpyNN.query_static-304"><span class="linenos">304</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: Indices and distances.</span>
</span><span id="NumpyNN.query_static-305"><a href="#NumpyNN.query_static-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.query_static-306"><a href="#NumpyNN.query_static-306"><span class="linenos">306</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NumpyNN.query_static-307"><a href="#NumpyNN.query_static-307"><span class="linenos">307</span></a>            <span class="k">return</span> <span class="p">(</span>
</span><span id="NumpyNN.query_static-308"><a href="#NumpyNN.query_static-308"><span class="linenos">308</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">query_points</span><span class="p">),</span> <span class="n">k</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
</span><span id="NumpyNN.query_static-309"><a href="#NumpyNN.query_static-309"><span class="linenos">309</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">query_points</span><span class="p">),</span> <span class="n">k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
</span><span id="NumpyNN.query_static-310"><a href="#NumpyNN.query_static-310"><span class="linenos">310</span></a>            <span class="p">)</span>
</span><span id="NumpyNN.query_static-311"><a href="#NumpyNN.query_static-311"><span class="linenos">311</span></a>
</span><span id="NumpyNN.query_static-312"><a href="#NumpyNN.query_static-312"><span class="linenos">312</span></a>        <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="NumpyNN.query_static-313"><a href="#NumpyNN.query_static-313"><span class="linenos">313</span></a>        <span class="c1"># Use cached static norms</span>
</span><span id="NumpyNN.query_static-314"><a href="#NumpyNN.query_static-314"><span class="linenos">314</span></a>        <span class="n">dist_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sq_dist_matrix_cached</span><span class="p">(</span>
</span><span id="NumpyNN.query_static-315"><a href="#NumpyNN.query_static-315"><span class="linenos">315</span></a>            <span class="n">query_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_sq</span>
</span><span id="NumpyNN.query_static-316"><a href="#NumpyNN.query_static-316"><span class="linenos">316</span></a>        <span class="p">)</span>
</span><span id="NumpyNN.query_static-317"><a href="#NumpyNN.query_static-317"><span class="linenos">317</span></a>        <span class="n">dist_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="NumpyNN.query_static-318"><a href="#NumpyNN.query_static-318"><span class="linenos">318</span></a>
</span><span id="NumpyNN.query_static-319"><a href="#NumpyNN.query_static-319"><span class="linenos">319</span></a>        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="NumpyNN.query_static-320"><a href="#NumpyNN.query_static-320"><span class="linenos">320</span></a>            <span class="n">final_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="NumpyNN.query_static-321"><a href="#NumpyNN.query_static-321"><span class="linenos">321</span></a>            <span class="n">final_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">final_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="NumpyNN.query_static-322"><a href="#NumpyNN.query_static-322"><span class="linenos">322</span></a>            <span class="k">return</span> <span class="n">final_idx</span><span class="p">,</span> <span class="n">final_dists</span>
</span><span id="NumpyNN.query_static-323"><a href="#NumpyNN.query_static-323"><span class="linenos">323</span></a>
</span><span id="NumpyNN.query_static-324"><a href="#NumpyNN.query_static-324"><span class="linenos">324</span></a>        <span class="n">part_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span>
</span><span id="NumpyNN.query_static-325"><a href="#NumpyNN.query_static-325"><span class="linenos">325</span></a>        <span class="n">top_dists_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">dist_sq</span><span class="p">,</span> <span class="n">part_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN.query_static-326"><a href="#NumpyNN.query_static-326"><span class="linenos">326</span></a>
</span><span id="NumpyNN.query_static-327"><a href="#NumpyNN.query_static-327"><span class="linenos">327</span></a>        <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">top_dists_sq</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN.query_static-328"><a href="#NumpyNN.query_static-328"><span class="linenos">328</span></a>        <span class="n">final_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">top_dists_sq</span><span class="p">,</span> <span class="n">sort_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="NumpyNN.query_static-329"><a href="#NumpyNN.query_static-329"><span class="linenos">329</span></a>        <span class="n">final_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span><span class="n">part_idx</span><span class="p">,</span> <span class="n">sort_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="NumpyNN.query_static-330"><a href="#NumpyNN.query_static-330"><span class="linenos">330</span></a>
</span><span id="NumpyNN.query_static-331"><a href="#NumpyNN.query_static-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="n">final_idx</span><span class="p">,</span> <span class="n">final_dists</span>
</span></pre></div>


            <div class="docstring"><p>Queries the static set using cached squared norms.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>query_points (np.ndarray):</strong>  Query inputs.</li>
<li><strong>k (int):</strong>  Neighbors count.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[np.ndarray, np.ndarray]: Indices and distances.</p>
</blockquote>
</div>


                            </div>
                            <div id="NumpyNN.range_search" class="classattr">
                                        <input id="NumpyNN.range_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">range_search</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">radius</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NumpyNN.range_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NumpyNN.range_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NumpyNN.range_search-333"><a href="#NumpyNN.range_search-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">range_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
</span><span id="NumpyNN.range_search-334"><a href="#NumpyNN.range_search-334"><span class="linenos">334</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NumpyNN.range_search-335"><a href="#NumpyNN.range_search-335"><span class="linenos">335</span></a><span class="sd">        Computes the full distance matrix and applies a boolean mask.</span>
</span><span id="NumpyNN.range_search-336"><a href="#NumpyNN.range_search-336"><span class="linenos">336</span></a>
</span><span id="NumpyNN.range_search-337"><a href="#NumpyNN.range_search-337"><span class="linenos">337</span></a><span class="sd">        Because `NumpyNN` is designed for dense regimes, this returns the complete</span>
</span><span id="NumpyNN.range_search-338"><a href="#NumpyNN.range_search-338"><span class="linenos">338</span></a><span class="sd">        $M \\times N$ distance matrix and a boolean mask indicating valid neighbors ($d &lt; R$).</span>
</span><span id="NumpyNN.range_search-339"><a href="#NumpyNN.range_search-339"><span class="linenos">339</span></a><span class="sd">        This avoids the overhead of sparse formatting when connectivity is high.</span>
</span><span id="NumpyNN.range_search-340"><a href="#NumpyNN.range_search-340"><span class="linenos">340</span></a>
</span><span id="NumpyNN.range_search-341"><a href="#NumpyNN.range_search-341"><span class="linenos">341</span></a><span class="sd">        Args:</span>
</span><span id="NumpyNN.range_search-342"><a href="#NumpyNN.range_search-342"><span class="linenos">342</span></a><span class="sd">            radius (float): Cutoff radius.</span>
</span><span id="NumpyNN.range_search-343"><a href="#NumpyNN.range_search-343"><span class="linenos">343</span></a>
</span><span id="NumpyNN.range_search-344"><a href="#NumpyNN.range_search-344"><span class="linenos">344</span></a><span class="sd">        Returns:</span>
</span><span id="NumpyNN.range_search-345"><a href="#NumpyNN.range_search-345"><span class="linenos">345</span></a><span class="sd">            tuple[np.ndarray, np.ndarray]: (Distances, Mask).</span>
</span><span id="NumpyNN.range_search-346"><a href="#NumpyNN.range_search-346"><span class="linenos">346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NumpyNN.range_search-347"><a href="#NumpyNN.range_search-347"><span class="linenos">347</span></a>        <span class="c1"># 1. Compute Full Matrix</span>
</span><span id="NumpyNN.range_search-348"><a href="#NumpyNN.range_search-348"><span class="linenos">348</span></a>        <span class="n">full_dists_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_full_sq_dists</span><span class="p">()</span>
</span><span id="NumpyNN.range_search-349"><a href="#NumpyNN.range_search-349"><span class="linenos">349</span></a>
</span><span id="NumpyNN.range_search-350"><a href="#NumpyNN.range_search-350"><span class="linenos">350</span></a>        <span class="c1"># 2. Compute Mask</span>
</span><span id="NumpyNN.range_search-351"><a href="#NumpyNN.range_search-351"><span class="linenos">351</span></a>        <span class="n">radius_sq</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">radius</span>
</span><span id="NumpyNN.range_search-352"><a href="#NumpyNN.range_search-352"><span class="linenos">352</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">full_dists_sq</span> <span class="o">&lt;</span> <span class="n">radius_sq</span>
</span><span id="NumpyNN.range_search-353"><a href="#NumpyNN.range_search-353"><span class="linenos">353</span></a>
</span><span id="NumpyNN.range_search-354"><a href="#NumpyNN.range_search-354"><span class="linenos">354</span></a>        <span class="c1"># 3. Return (Dists, Mask) - No &#39;nonzero&#39; or sorting required</span>
</span><span id="NumpyNN.range_search-355"><a href="#NumpyNN.range_search-355"><span class="linenos">355</span></a>        <span class="c1"># Return sqrt distances for metric compatibility</span>
</span><span id="NumpyNN.range_search-356"><a href="#NumpyNN.range_search-356"><span class="linenos">356</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">full_dists_sq</span><span class="p">),</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Computes the full distance matrix and applies a boolean mask.</p>

<p>Because <code><a href="#NumpyNN">NumpyNN</a></code> is designed for dense regimes, this returns the complete
$M \times N$ distance matrix and a boolean mask indicating valid neighbors ($d &lt; R$).
This avoids the overhead of sparse formatting when connectivity is high.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>radius (float):</strong>  Cutoff radius.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>tuple[np.ndarray, np.ndarray]: (Distances, Mask).</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#NearestNeighbors">NearestNeighbors</a></dt>
                                <dd id="NumpyNN.dimension" class="variable"><a href="#NearestNeighbors.dimension">dimension</a></dd>
                <dd id="NumpyNN.seed" class="variable"><a href="#NearestNeighbors.seed">seed</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FaissFlatL2NN">
                            <input id="FaissFlatL2NN-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FaissFlatL2NN</span><wbr>(<span class="base"><a href="ess/nn.html#FaissBaseNN">ess.nn.FaissBaseNN</a></span>):

                <label class="view-source-button" for="FaissFlatL2NN-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FaissFlatL2NN"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FaissFlatL2NN-616"><a href="#FaissFlatL2NN-616"><span class="linenos">616</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FaissFlatL2NN</span><span class="p">(</span><span class="n">FaissBaseNN</span><span class="p">):</span>
</span><span id="FaissFlatL2NN-617"><a href="#FaissFlatL2NN-617"><span class="linenos">617</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FaissFlatL2NN-618"><a href="#FaissFlatL2NN-618"><span class="linenos">618</span></a><span class="sd">    Wrapper for `faiss.IndexFlatL2`.</span>
</span><span id="FaissFlatL2NN-619"><a href="#FaissFlatL2NN-619"><span class="linenos">619</span></a>
</span><span id="FaissFlatL2NN-620"><a href="#FaissFlatL2NN-620"><span class="linenos">620</span></a><span class="sd">    This provides exact nearest neighbor search using brute-force comparison within Faiss.</span>
</span><span id="FaissFlatL2NN-621"><a href="#FaissFlatL2NN-621"><span class="linenos">621</span></a><span class="sd">    It is generally faster than `NumpyNN` for medium datasets ($N &gt; 5000$) due to C++</span>
</span><span id="FaissFlatL2NN-622"><a href="#FaissFlatL2NN-622"><span class="linenos">622</span></a><span class="sd">    optimizations and multithreading, but slower than HNSW.</span>
</span><span id="FaissFlatL2NN-623"><a href="#FaissFlatL2NN-623"><span class="linenos">623</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FaissFlatL2NN-624"><a href="#FaissFlatL2NN-624"><span class="linenos">624</span></a>
</span><span id="FaissFlatL2NN-625"><a href="#FaissFlatL2NN-625"><span class="linenos">625</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
</span><span id="FaissFlatL2NN-626"><a href="#FaissFlatL2NN-626"><span class="linenos">626</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">IndexFlatL2</span><span class="p">(</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for <code>faiss.IndexFlatL2</code>.</p>

<p>This provides exact nearest neighbor search using brute-force comparison within Faiss.
It is generally faster than <code><a href="#NumpyNN">NumpyNN</a></code> for medium datasets ($N &gt; 5000$) due to C++
optimizations and multithreading, but slower than HNSW.</p>
</div>


                            <div id="FaissFlatL2NN.__init__" class="classattr">
                                        <input id="FaissFlatL2NN.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FaissFlatL2NN</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span></span>)</span>

                <label class="view-source-button" for="FaissFlatL2NN.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FaissFlatL2NN.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FaissFlatL2NN.__init__-625"><a href="#FaissFlatL2NN.__init__-625"><span class="linenos">625</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">):</span>
</span><span id="FaissFlatL2NN.__init__-626"><a href="#FaissFlatL2NN.__init__-626"><span class="linenos">626</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">IndexFlatL2</span><span class="p">(</span><span class="n">dimension</span><span class="p">),</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="ess/nn.html#FaissBaseNN">ess.nn.FaissBaseNN</a></dt>
                                <dd id="FaissFlatL2NN.add_static" class="function"><a href="ess/nn.html#FaissBaseNN.add_static">add_static</a></dd>
                <dd id="FaissFlatL2NN.set_active" class="function"><a href="ess/nn.html#FaissBaseNN.set_active">set_active</a></dd>
                <dd id="FaissFlatL2NN.consolidate" class="function"><a href="ess/nn.html#FaissBaseNN.consolidate">consolidate</a></dd>
                <dd id="FaissFlatL2NN.clear" class="function"><a href="ess/nn.html#FaissBaseNN.clear">clear</a></dd>
                <dd id="FaissFlatL2NN.total_count" class="variable"><a href="ess/nn.html#FaissBaseNN.total_count">total_count</a></dd>
                <dd id="FaissFlatL2NN.query_nn" class="function"><a href="ess/nn.html#FaissBaseNN.query_nn">query_nn</a></dd>
                <dd id="FaissFlatL2NN.query_static" class="function"><a href="ess/nn.html#FaissBaseNN.query_static">query_static</a></dd>
                <dd id="FaissFlatL2NN.range_search" class="function"><a href="ess/nn.html#FaissBaseNN.range_search">range_search</a></dd>

            </div>
            <div><dt><a href="#NearestNeighbors">NearestNeighbors</a></dt>
                                <dd id="FaissFlatL2NN.dimension" class="variable"><a href="#NearestNeighbors.dimension">dimension</a></dd>
                <dd id="FaissFlatL2NN.seed" class="variable"><a href="#NearestNeighbors.seed">seed</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FaissHNSWFlatNN">
                            <input id="FaissHNSWFlatNN-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FaissHNSWFlatNN</span><wbr>(<span class="base"><a href="ess/nn.html#FaissBaseNN">ess.nn.FaissBaseNN</a></span>):

                <label class="view-source-button" for="FaissHNSWFlatNN-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FaissHNSWFlatNN"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FaissHNSWFlatNN-629"><a href="#FaissHNSWFlatNN-629"><span class="linenos">629</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FaissHNSWFlatNN</span><span class="p">(</span><span class="n">FaissBaseNN</span><span class="p">):</span>
</span><span id="FaissHNSWFlatNN-630"><a href="#FaissHNSWFlatNN-630"><span class="linenos">630</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FaissHNSWFlatNN-631"><a href="#FaissHNSWFlatNN-631"><span class="linenos">631</span></a><span class="sd">    Wrapper for `faiss.IndexHNSWFlat`.</span>
</span><span id="FaissHNSWFlatNN-632"><a href="#FaissHNSWFlatNN-632"><span class="linenos">632</span></a>
</span><span id="FaissHNSWFlatNN-633"><a href="#FaissHNSWFlatNN-633"><span class="linenos">633</span></a><span class="sd">    Uses Hierarchical Navigable Small World graphs for approximate nearest neighbor search.</span>
</span><span id="FaissHNSWFlatNN-634"><a href="#FaissHNSWFlatNN-634"><span class="linenos">634</span></a><span class="sd">    This offers logarithmic scaling $O(\\log N)$, making it suitable for very large datasets</span>
</span><span id="FaissHNSWFlatNN-635"><a href="#FaissHNSWFlatNN-635"><span class="linenos">635</span></a><span class="sd">    ($N &gt; 50,000$).</span>
</span><span id="FaissHNSWFlatNN-636"><a href="#FaissHNSWFlatNN-636"><span class="linenos">636</span></a>
</span><span id="FaissHNSWFlatNN-637"><a href="#FaissHNSWFlatNN-637"><span class="linenos">637</span></a><span class="sd">    Args:</span>
</span><span id="FaissHNSWFlatNN-638"><a href="#FaissHNSWFlatNN-638"><span class="linenos">638</span></a><span class="sd">        dimension (int): Dimensionality of the data.</span>
</span><span id="FaissHNSWFlatNN-639"><a href="#FaissHNSWFlatNN-639"><span class="linenos">639</span></a><span class="sd">        seed (int): Random seed.</span>
</span><span id="FaissHNSWFlatNN-640"><a href="#FaissHNSWFlatNN-640"><span class="linenos">640</span></a><span class="sd">        M (int): Number of edges per node in the graph (default 32). Higher $M$ improves</span>
</span><span id="FaissHNSWFlatNN-641"><a href="#FaissHNSWFlatNN-641"><span class="linenos">641</span></a><span class="sd">            recall at the cost of memory and build time.</span>
</span><span id="FaissHNSWFlatNN-642"><a href="#FaissHNSWFlatNN-642"><span class="linenos">642</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FaissHNSWFlatNN-643"><a href="#FaissHNSWFlatNN-643"><span class="linenos">643</span></a>
</span><span id="FaissHNSWFlatNN-644"><a href="#FaissHNSWFlatNN-644"><span class="linenos">644</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
</span><span id="FaissHNSWFlatNN-645"><a href="#FaissHNSWFlatNN-645"><span class="linenos">645</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">IndexHNSWFlat</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper for <code>faiss.IndexHNSWFlat</code>.</p>

<p>Uses Hierarchical Navigable Small World graphs for approximate nearest neighbor search.
This offers logarithmic scaling $O(\log N)$, making it suitable for very large datasets
($N &gt; 50,000$).</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>dimension (int):</strong>  Dimensionality of the data.</li>
<li><strong>seed (int):</strong>  Random seed.</li>
<li><strong>M (int):</strong>  Number of edges per node in the graph (default 32). Higher $M$ improves
recall at the cost of memory and build time.</li>
</ul>
</div>


                            <div id="FaissHNSWFlatNN.__init__" class="classattr">
                                        <input id="FaissHNSWFlatNN.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FaissHNSWFlatNN</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span>, </span><span class="param"><span class="n">M</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span></span>)</span>

                <label class="view-source-button" for="FaissHNSWFlatNN.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FaissHNSWFlatNN.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FaissHNSWFlatNN.__init__-644"><a href="#FaissHNSWFlatNN.__init__-644"><span class="linenos">644</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">):</span>
</span><span id="FaissHNSWFlatNN.__init__-645"><a href="#FaissHNSWFlatNN.__init__-645"><span class="linenos">645</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">faiss</span><span class="o">.</span><span class="n">IndexHNSWFlat</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="ess/nn.html#FaissBaseNN">ess.nn.FaissBaseNN</a></dt>
                                <dd id="FaissHNSWFlatNN.add_static" class="function"><a href="ess/nn.html#FaissBaseNN.add_static">add_static</a></dd>
                <dd id="FaissHNSWFlatNN.set_active" class="function"><a href="ess/nn.html#FaissBaseNN.set_active">set_active</a></dd>
                <dd id="FaissHNSWFlatNN.consolidate" class="function"><a href="ess/nn.html#FaissBaseNN.consolidate">consolidate</a></dd>
                <dd id="FaissHNSWFlatNN.clear" class="function"><a href="ess/nn.html#FaissBaseNN.clear">clear</a></dd>
                <dd id="FaissHNSWFlatNN.total_count" class="variable"><a href="ess/nn.html#FaissBaseNN.total_count">total_count</a></dd>
                <dd id="FaissHNSWFlatNN.query_nn" class="function"><a href="ess/nn.html#FaissBaseNN.query_nn">query_nn</a></dd>
                <dd id="FaissHNSWFlatNN.query_static" class="function"><a href="ess/nn.html#FaissBaseNN.query_static">query_static</a></dd>
                <dd id="FaissHNSWFlatNN.range_search" class="function"><a href="ess/nn.html#FaissBaseNN.range_search">range_search</a></dd>

            </div>
            <div><dt><a href="#NearestNeighbors">NearestNeighbors</a></dt>
                                <dd id="FaissHNSWFlatNN.dimension" class="variable"><a href="#NearestNeighbors.dimension">dimension</a></dd>
                <dd id="FaissHNSWFlatNN.seed" class="variable"><a href="#NearestNeighbors.seed">seed</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>